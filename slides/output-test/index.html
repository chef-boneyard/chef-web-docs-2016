<!DOCTYPE html>


<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title align="left">Slide Deck &mdash; Slide Deck</title>

    

    
<link rel="stylesheet" href="_static/css/reveal.min.css">
<link rel="stylesheet" href="_static/css/theme/default.css" id="theme">
<link rel="stylesheet" href="_static/lib/css/zenburn.css">
<link rel="stylesheet" href="_static/revealjs.css" type="text/css" />

    <!-- If the query includes 'print-pdf', include the PDF print sheet -->
    <script>
        if(window.location.search.match(/print-pdf/gi)) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = '_static/css/print/pdf.css';
            document.getElementsByTagName('head')[0].appendChild(link);
        }
    </script>

    <!--[if lt IE 9]>
    <script src="_static/lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="reveal">
      <div class="slides" align="left">
        
  <div class="section" id="slide-deck">
<h1>Slide Deck<a class="headerlink" href="#slide-deck" title="Permalink to this headline">¶</a></h1>
<section>
<h2>First Slide!</h2>
This is the main slide. Notice that the title of the slide isn&#8217;t in the actual slide itself, i.e. it&#8217;s not here, it&#8217;s in the slide map file.</section>
<section>
<h2>Text</h2>
<p class="first">A paragraph is a series of sentences. You can <em>emphasize</em> strings, <strong>bold them</strong>, apply code <tt class="docutils literal"><span class="pre">5tr!ng+</span></tt>.</p>
<p class="last">You can use whitespace within the slide to have more than one paragraph on a slide.</p>
</section>
<section>
<h2>Ordered Lists</h2>
<p class="first">This is an ordered list:</p>
<ol class="last arabic simple">
<li>first item</li>
<li>second item</li>
<li>third item</li>
</ol>
</section>
<section>
<h2>Unordered Lists</h2>
<p class="first">This is an unordered list:</p>
<ul class="last simple">
<li>first item</li>
<li>second item</li>
<li>third item</li>
</ul>
</section>
<section>
<h2>Links</h2>
<p class="first">There are three types of links:</p>
<ul class="simple">
<li>Hardcoded, i.e. <a class="reference external" href="http://ampledata.org/splunk_storm_chef_handler.html">http://ampledata.org/splunk_storm_chef_handler.html</a></li>
<li><tt class="docutils literal"><span class="pre">`linkName</span> <span class="pre">&lt;http://docs.chef.io/&gt;`__</span></tt></li>
<li><tt class="docutils literal"><span class="pre">:doc:`pageTitle</span> <span class="pre">&lt;/filename&gt;`</span></tt></li>
</ul>
<p class="last">The hardcoded link is useful because viewers can write it down and/or print it out. The second one hides the actual URL and is good for inline linking in HTML files, which is good if the slides are available to everyone online. The third one probably isn&#8217;t used too often, if at all. But in theory it will hyperlink to another slide in the slide deck.</p>
</section>
<section>
<h2>Tables</h2>
<table border="1" class="first last docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>thing 1</td>
<td>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur elementum lobortis orci non suscipit. Mauris sodales justo eu metus dignissim bibendum.</td>
</tr>
<tr class="row-even"><td>thing 2</td>
<td>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur elementum lobortis orci non suscipit. Mauris sodales justo eu metus dignissim bibendum.</td>
</tr>
<tr class="row-odd"><td>thing 3</td>
<td>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur elementum lobortis orci non suscipit. Mauris sodales justo eu metus dignissim bibendum.</td>
</tr>
</tbody>
</table>
</section>
<section>
<h2>Code Blocks</h2>
<p class="first">A code block shows a block of code (obviously). If Pygments is enabled for Sphinx, use the code-block directive to show colors applied. Use a double colon (<tt class="docutils literal"><span class="pre">::</span></tt>) to introduce the default code block. For example, Ruby code:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;foo&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</pre></div>
</div>
<p>and the same without the directive:</p>
<div class="last highlight-python"><div class="highlight"><pre>package &quot;foo&quot; do
  action :install
end
</pre></div>
</div>
</section>
<section>
<h2>Images</h2>
<p class="first">Still playing around with the images.</p>
<img alt="_images/chef_overview.png" class="last" src="_images/chef_overview.png" />
</section>
<section>
<h2>Pulling in some chef-docs</h2>
<p class="first">The next series of slides are just pulling in random chef-docs topics. Mostly to see what they might look like and also to just show that it&#8217;s super-easy to reuse the chef-docs library in slide decks.</p>
<ul class="simple">
<li>Ohai resource</li>
<li>chef-client command options</li>
<li>examples of using resources (straight from chef-docs)</li>
</ul>
<p class="last">There are likely some formatting issues. But let&#8217;s identify them and then figure out how to make them go away in the places where reusability is extra important. For example, to reuse the command options, the entire approach had to be refactored to work as HTML and command output, but once done 100% reuse.</p>
</section>
<section>
<section class="first">
<h2>Ohai Resource</h2>
Use the <strong>ohai</strong> resource to reload the Ohai configuration on a node. This allows recipes that change system attributes (like a recipe that adds a user) to refer to those attributes later on during the chef-client run.</section>
<section>
<h2>Syntax</h2>
<p class="first">The syntax for using the <strong>ohai</strong> resource in a recipe is as follows:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">ohai</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">attribute</span> <span class="s2">&quot;value&quot;</span> <span class="c1"># see attributes section below</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="n">action</span> <span class="ss">:action</span> <span class="c1"># see actions section below</span>
<span class="k">end</span>
</pre></div>
</div>
<p>where</p>
<ul class="last simple">
<li><tt class="docutils literal"><span class="pre">ohai</span></tt> tells the chef-client to use the <tt class="docutils literal"><span class="pre">Chef::Provider::Ohai</span></tt> provider during the chef-client run</li>
<li><tt class="docutils literal"><span class="pre">&quot;name&quot;</span></tt> is a friendly name for the action that is defined in the recipe</li>
<li><tt class="docutils literal"><span class="pre">attribute</span></tt> is zero (or more) of the attributes that are available for this resource</li>
<li><tt class="docutils literal"><span class="pre">:action</span></tt> identifies which steps the chef-client will take to bring the node into the desired state</li>
</ul>
</section>
<section>
<h2>Actions</h2>
<p class="first">This resource has the following actions:</p>
<table border="1" class="last docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:reload</span></tt></td>
<td>Default. Use to reload the Ohai configuration on a node.</td>
</tr>
</tbody>
</table>
</section>
<section>
<h2>Attributes</h2>
<p class="first">This resource has the following attributes:</p>
<table border="1" class="last docutils">
<colgroup>
<col width="25%" />
<col width="75%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">name</span></tt></td>
<td>Always the same value as the <tt class="docutils literal"><span class="pre">name</span></tt> of the resource block. (See &#8220;Syntax&#8221; section above for more information.)</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">plugin</span></tt></td>
<td>Optional. The name of an Ohai plugin to be reloaded. If this attribute is not specified, the chef-client will reload all plugins.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">provider</span></tt></td>
<td>Optional. Use to explicitly specify a provider. (See &#8220;Providers&#8221; section below for more information.)</td>
</tr>
</tbody>
</table>
</section>
<section class="last">
<h2>Examples</h2>
<p class="first"><strong>Reload Ohai</strong></p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">ohai</span> <span class="s2">&quot;reload&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:reload</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Reload Ohai after a new user is created</strong></p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">ohai</span> <span class="s2">&quot;reload_passwd&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="n">plugin</span> <span class="s2">&quot;etc&quot;</span>
<span class="k">end</span>

<span class="n">user</span> <span class="s2">&quot;daemonuser&quot;</span> <span class="k">do</span>
  <span class="n">home</span> <span class="s2">&quot;/dev/null&quot;</span>
  <span class="n">shell</span> <span class="s2">&quot;/sbin/nologin&quot;</span>
  <span class="nb">system</span> <span class="kp">true</span>
  <span class="n">notifies</span> <span class="ss">:reload</span><span class="p">,</span> <span class="s2">&quot;ohai[reload_passwd]&quot;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">ruby_block</span> <span class="s2">&quot;just an example&quot;</span> <span class="k">do</span>
  <span class="n">block</span> <span class="k">do</span>
    <span class="c1"># These variables will now have the new values</span>
    <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;etc&#39;</span><span class="o">][</span><span class="s1">&#39;passwd&#39;</span><span class="o">][</span><span class="s1">&#39;daemonuser&#39;</span><span class="o">][</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="nb">puts</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;etc&#39;</span><span class="o">][</span><span class="s1">&#39;passwd&#39;</span><span class="o">][</span><span class="s1">&#39;daemonuser&#39;</span><span class="o">][</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
</section>
<section>
<h2>Reusing chef-client options</h2>
<p class="first">This command has the following syntax:</p>
<div class="highlight-python"><div class="highlight"><pre>chef-client OPTION VALUE OPTION VALUE ...
</pre></div>
</div>
<p>This command has the following options:</p>
<dl class="last docutils">
<dt><tt class="docutils literal"><span class="pre">-A</span></tt>, <tt class="docutils literal"><span class="pre">--fatal-windows-admin-check</span></tt></dt>
<dd>Use to cause a chef-client run to fail when the chef-client does not have administrator privileges in Microsoft Windows.</dd>
<dt><tt class="docutils literal"><span class="pre">--audit-mode</span> <span class="pre">MODE</span></tt></dt>
<dd>Use to enable audit-mode. Set to <tt class="docutils literal"><span class="pre">audit-only</span></tt> to skip the converge phase of the chef-client run and only perform audits. Possible values: <tt class="docutils literal"><span class="pre">audit-only</span></tt>, <tt class="docutils literal"><span class="pre">disabled</span></tt>, and <tt class="docutils literal"><span class="pre">enabled</span></tt>. Default value: <tt class="docutils literal"><span class="pre">disabled</span></tt>.</dd>
</dl>
</section>
<section>
<h2>Example: package</h2>
<p class="first">To install a package:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;tar&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section>
<h2>Example: template</h2>
<p class="first">A template helper module can be defined in a library. This is useful when extensions need to be reused across recipes or to make it easier to manage code that would otherwise be defined inline on a per-recipe basis.</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">template</span> <span class="s2">&quot;/path/to/template.erb&quot;</span> <span class="k">do</span>
  <span class="n">helpers</span><span class="p">(</span><span class="no">MyHelperModule</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section>
<h2>Example: service</h2>
<div class="first last highlight-ruby"><div class="highlight"><pre><span class="n">service</span> <span class="s2">&quot;some_service&quot;</span> <span class="k">do</span>
  <span class="n">provider</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Provider</span><span class="o">::</span><span class="ss">Service</span><span class="p">:</span><span class="ss">:Upstart</span>
  <span class="n">supports</span> <span class="ss">:status</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:restart</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:reload</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">action</span> <span class="o">[</span> <span class="ss">:enable</span><span class="p">,</span> <span class="ss">:start</span> <span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section>
<h2>Example Lessons</h2>
The next series of slides that begins on the next horizontal slide shows a series of slides from the existing handlers intermediate training. These will go vertically and are just the first cut at seeing what they might look like in a slide deck.</section>
<section>
<section class="first">
<h2>Lesson Objectives (Handlers)</h2>
<p class="first">After completing this lesson, you will be able to</p>
<ul class="last simple">
<li>Describe Chef handlers</li>
<li>Write custom report handlers</li>
<li>Distribute handlers to nodes</li>
<li>Configure Chef to use custom handlers</li>
</ul>
</section>
<section>
<h2>Handlers</h2>
<p class="first">Handlers run at the start or end of a chef-client run</p>
<p>They are Ruby programs that can read the status information of your chef-client run</p>
<p>There are three types of handlers:</p>
<ul class="last simple">
<li>Report</li>
<li>Exception</li>
<li>Start</li>
</ul>
</section>
<section>
<h2>Report Handlers</h2>
<p class="first">Report handlers are used when the chef-client run succeeds</p>
<p>Runs when <tt class="docutils literal"><span class="pre">run_status.success?</span></tt> is true</p>
<p>Community Examples:</p>
<ul class="last simple">
<li><a class="reference external" href="http://ampledata.org/splunk_storm_chef_handler.html">http://ampledata.org/splunk_storm_chef_handler.html</a></li>
<li><a class="reference external" href="http://onddo.github.io/chef-handler-zookeeper/">http://onddo.github.io/chef-handler-zookeeper/</a></li>
<li><a class="reference external" href="https://github.com/realityforge/chef-graphite_handler">https://github.com/realityforge/chef-graphite_handler</a></li>
</ul>
</section>
<section>
<h2>Exception Handlers</h2>
<p class="first">Exception handlers are used when the chef-client run fails</p>
<p>Runs when <tt class="docutils literal"><span class="pre">run_status.failed?</span></tt> is true</p>
<p>Community Examples:</p>
<ul class="last simple">
<li><a class="reference external" href="https://github.com/morgoth/airbrake_handler">https://github.com/morgoth/airbrake_handler</a></li>
<li><a class="reference external" href="https://github.com/jblaine/syslog_handler">https://github.com/jblaine/syslog_handler</a></li>
<li><a class="reference external" href="http://onddo.github.io/chef-handler-sns/">http://onddo.github.io/chef-handler-sns/</a></li>
</ul>
</section>
<section>
<h2>Start Handlers</h2>
<p class="first">Start handlers are used to run events at the beginning of the chef-client run</p>
<p>Does not load the <strong>chef_handler</strong> resource</p>
<p>Install start handlers using the <strong>chef_gem</strong> resource or add the <tt class="docutils literal"><span class="pre">start_handlers</span></tt> setting to the client.rb file.</p>
<p class="last"><a class="reference external" href="https://github.com/opscode/chef-reporting">https://github.com/opscode/chef-reporting</a></p>
</section>
<section>
<h2>Writing Custom Handlers</h2>
<ul class="first last simple">
<li>Use any ruby gem or library</li>
<li>Distribute to nodes with the chef_handler or chef-client cookbooks</li>
<li>Optionally configure through client.rb settings</li>
</ul>
</section>
<section>
<h2>Exercise: Download the chef_handler cookbook</h2>
<div class="first highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook site download chef_handler 1.1.6
</pre></div>
</div>
<div class="last highlight-bash"><div class="highlight"><pre>Downloading chef_handler from the cookbooks site at version 1.1.6 to /Users/YOU/chef-repo/chef_handler-1.1.6.tar.gz

Cookbook saved: /Users/YOU/chef-repo/chef_handler-1.1.6.tar.gz
</pre></div>
</div>
</section>
<section>
<h2>Exercise: Download the chef-client cookbook</h2>
<div class="first highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>tar -zxvf chef_handler-1.1.6.tar.gz -C cookbooks/
</pre></div>
</div>
<div class="last highlight-bash"><div class="highlight"><pre>x chef_handler/
x chef_handler/CHANGELOG.md
x chef_handler/README.md
x chef_handler/attributes
x chef_handler/attributes/default.rb
x chef_handler/files
x chef_handler/files/default
x chef_handler/files/default/handlers
x chef_handler/files/default/handlers/README
x chef_handler/libraries
x chef_handler/libraries/matchers.rb
</pre></div>
</div>
</section>
<section>
<h2>Exercise: Upload the chef_handler cookbook</h2>
<div class="first highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook upload chef_handler
</pre></div>
</div>
<div class="last highlight-bash"><div class="highlight"><pre>Uploading chef_handler         <span class="o">[</span>1.1.6<span class="o">]</span>
Uploaded 1 cookbook.
</pre></div>
</div>
</section>
<section>
<h2>Let’s Write a Handler</h2>
<p class="first">We’re going to write a new handler that will email us when chef-client runs</p>
<p>It will send us all of the resources that changed during the chef-client run</p>
<p class="last"><a class="reference external" href="http://docs.chef.io/handlers.html">http://docs.chef.io/handlers.html</a></p>
</section>
<section>
<h2>Library Cookbook Pattern</h2>
<p class="first">We could modify the chef_handler cookbook to add a recipe for the email handler</p>
<p>However, we&#8217;d basically be &#8220;forking&#8221; an upstream cookbook</p>
<p>Instead, let&#8217;s create our own cookbook and use chef_handler as a &#8220;library&#8221;</p>
<p class="last">Code reusability!</p>
</section>
<section>
<h2>Exercise: Create a cookbook named ‘email_handler’</h2>
<div class="first highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook create email_handler
</pre></div>
</div>
<div class="last highlight-bash"><div class="highlight"><pre>** Creating cookbook email_handler
** Creating README <span class="k">for </span>cookbook: email_handler
** Creating CHANGELOG <span class="k">for </span>cookbook: email_handler
** Creating metadata <span class="k">for </span>cookbook: email_handler
</pre></div>
</div>
</section>
<section>
<h2>Exercise: Edit the default recipe</h2>
<ol class="first last arabic">
<li><p class="first">Open cookbooks/email_handler/recipes/default.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">chef_gem</span> <span class="s2">&quot;pony&quot;</span> <span class="k">do</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>

<span class="n">include_recipe</span> <span class="s2">&quot;chef_handler&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
</section>
<section>
<h2>The chef_handler Resource</h2>
<p class="first">chef_handler is a resource packaged with the chef_handler cookbook</p>
<p>It has two actions: :enable and :disable</p>
<p>It has three arguments:</p>
<ul class="simple">
<li>source - the file containing the handler code</li>
<li>arguments - any pieces of information needed to initialize the handler</li>
<li>supports - :report, :exception</li>
</ul>
<p>Defaults:</p>
<ul class="last simple">
<li>:enable</li>
<li>:report =&gt; true, :exception =&gt; true</li>
</ul>
</section>
<section>
<h2>Exercise: Setup the handler</h2>
<ol class="first last arabic">
<li><p class="first">Open cookbooks/email_handler/recipes/default.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">cookbook_file</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;chef_handler&#39;</span><span class="o">][</span><span class="s1">&#39;handler_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/email_handler.rb&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;handlers/email_handler.rb&quot;</span>
  <span class="n">owner</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span> <span class="s2">&quot;0644&quot;</span>
<span class="k">end</span>

<span class="n">chef_handler</span> <span class="s2">&quot;MyCompany::EmailMe&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;chef_handler&#39;</span><span class="o">][</span><span class="s1">&#39;handler_path&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/email_handler.rb&quot;</span>
  <span class="n">arguments</span> <span class="o">[</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;email_handler&#39;</span><span class="o">][</span><span class="s1">&#39;from_address&#39;</span><span class="o">]</span><span class="p">,</span>
             <span class="n">node</span><span class="o">[</span><span class="s1">&#39;email_handler&#39;</span><span class="o">][</span><span class="s1">&#39;to_address&#39;</span><span class="o">]]</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
</section>
<section>
<h2>Exercise: Set the attributes</h2>
<ol class="first last arabic">
<li><p class="first">Open cookbooks/email_handler/attributes/default.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">default</span><span class="o">[</span><span class="s1">&#39;email_handler&#39;</span><span class="o">][</span><span class="s1">&#39;from_address&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chef@localhost&quot;</span>
<span class="n">default</span><span class="o">[</span><span class="s1">&#39;email_handler&#39;</span><span class="o">][</span><span class="s1">&#39;to_address&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;chef@localhost&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
</section>
<section>
<h2>Exercise: Write the handler</h2>
<ol class="first arabic">
<li><p class="first">Open ../email_handler/files/default/handlers/email_handler.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;pony&#39;</span>

<span class="k">module</span> <span class="nn">MyCompany</span>
  <span class="k">class</span> <span class="nc">EmailMe</span> <span class="o">&lt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Handler</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
<ul class="last simple">
<li>All custom exception and report handlers are defined using Ruby and must be a subclass of the Chef::Handler class.</li>
<li>The module and class match what we defined as the name of the chef_handler in the recipe</li>
</ul>
</section>
<section>
<h2>The initialize Method</h2>
<ol class="first arabic">
<li><p class="first">Open ../email_handler/files/default/handlers/email_handler.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EmailMe</span> <span class="o">&lt;</span> <span class="ss">Chef</span><span class="p">:</span><span class="ss">:Handler</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">from_address</span><span class="p">,</span> <span class="n">to_address</span><span class="p">)</span>
    <span class="vi">@from_address</span> <span class="o">=</span> <span class="n">from_address</span>
    <span class="vi">@to_address</span> <span class="o">=</span> <span class="n">to_address</span>
  <span class="k">end</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
<ul class="last simple">
<li>Initialize the handler with the arguments we passed in the definition</li>
<li>You can create the method with any args you need to meet your requirements</li>
</ul>
</section>
<section>
<h2>The report Method</h2>
<ol class="first arabic">
<li><p class="first">Open ../email_handler/files/default/handlers/email_handler.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="vi">@to_address</span> <span class="o">=</span> <span class="n">to_address</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">report</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">success?</span> <span class="p">?</span> <span class="s2">&quot;Successful&quot;</span> <span class="p">:</span> <span class="s2">&quot;Failed&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">status</span><span class="si">}</span><span class="s2"> Chef run report from </span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">report_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
<ul class="last simple">
<li>The report interface is used to define how a handler will behave and is a required part of any custom handler</li>
</ul>
</section>
<section>
<h2>The updated_resources Hash</h2>
<ol class="first arabic">
<li><p class="first">Open ../email_handler/files/default/handlers/email_handler.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># report on changed resources</span>
<span class="k">if</span> <span class="o">!</span> <span class="n">run_status</span><span class="o">.</span><span class="n">updated_resources</span><span class="o">.</span><span class="n">empty?</span>
  <span class="c1"># get some info about all the changed resources!</span>
  <span class="n">run_status</span><span class="o">.</span><span class="n">updated_resources</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
    <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;The resource </span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> was changed in cookbook</span>
<span class="s2">                      </span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">cookbook_name</span><span class="si">}</span><span class="s2"> at </span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">source_line</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;No resources changed by chef-client</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">end</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
<ul class="last simple">
<li>updated_resources records information about all the resources changed during a chef-client run</li>
<li>read through this hash with .each, pull interesting information out about each resource</li>
</ul>
</section>
<section>
<h2>Exercise: Finish email_handler.rb</h2>
<ol class="first arabic">
<li><p class="first">Open ../email_handler/files/default/handlers/email_handler.rb</p>
</li>
<li><p class="first">Add:</p>
<div class="highlight-ruby"><div class="highlight"><pre>    <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;No resources changed by chef-client</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">end</span>

      <span class="no">Pony</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="vi">@to_address</span><span class="p">,</span>
                <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="vi">@from_address</span><span class="p">,</span>
                <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="p">,</span>
                <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">report_string</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
<ul class="last simple">
<li>Use Pony.mail to send a message containing info on changed resources</li>
</ul>
</section>
<section class="last">
<h2>Other Dependencies</h2>
<ul class="first last simple">
<li>Make sure all necessary functions are available!</li>
<li>Some sort of mail transfer agent (MTA)</li>
<li>Some sort of email reader (MUA)</li>
<li>These are distinct functional pieces</li>
<li>May have uses other than the handler</li>
<li>Get to be their own cookbooks!</li>
</ul>
</section>
</section>
</div>


      </div>
    </div>
    
<script src="_static/js/jquery.min.js"></script>
<script src="_static/lib/js/head.min.js"></script>
<script src="_static/js/reveal.min.js"></script>
    <script>

      // change DOM for reveal.js
      $("div.section h1").remove();
      var content = $("div.section").html();
      $("div.section").remove();
      $("div.slides").html(content);

      Reveal.initialize({
        width: 960,
        height: 700,

        margin: 0.3,

        minScale: 0.2,
        maxScale: 1.0,

        controls: true,
        progress: false,
        history: false,
        center: false,

        keyboard : true,
        overview: false,
        touch: true,
        loop: false,
        rtl: false,
        fragments: false,

        autoSlide: 0,
        mouseWheel: false,
        rollingLinks: true,
        previewLinks: false,

        transitionSpeed: "default",
        backgroundTransition: "default",

        slideNumber: false,
        embedded: false,
        autoSlideStoppable: true,
        hideAddressBar: true,

        parallaxBackgroundImage: "",
        parallaxBackgroundSize: "",

        focusBodyOnPageVisiblityChange: true,

        viewDistance: 3,

        theme: Reveal.getQueryHash().theme || "chef_slides",
        transition: Reveal.getQueryHash().transition || "default",

        

        dependencies: [
           { src: '_static/lib/js/classList.js', condition: function() { return !document.body.classList; } },
           { src: '_static/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
           { src: '_static/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
           { src: '_static/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
           { src: '_static/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
           { src: '_static/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
    
  </body>
</html>