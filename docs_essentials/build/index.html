

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Chef Essentials &mdash; Chef Overview</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1-1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Chef Overview" href="#" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="#">Chef Overview</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="#">
              <img class="logo" src="_static/opscode_html_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Chef Essentials</a><ul>
<li><a class="reference internal" href="#h1-nodes-done">H1 &#8211; Nodes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h2-cloud-vs-physical-nodes-done">H2 &#8211; Cloud vs. Physical Nodes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h2-chef-client-done">H2 &#8211; chef-client &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-ssl-certificates-done">H3 &#8211; SSL Certificates &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-signed-headers-done">H4 &#8211; Signed Headers &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-chef-validator-doneish">H4 &#8211; chef-validator &#8211; DONEish</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-the-chef-run-xxxxx">H2 &#8211; The Chef Run &#8211; xxxxx</a></li>
<li><a class="reference internal" href="#h2-ohai-done">H2 &#8211; Ohai &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-automatic-attributes">H3 &#8211; Automatic Attributes</a></li>
<li><a class="reference internal" href="#h3-ohai-attribute-list-done">H3 &#8211; Ohai Attribute List &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-handlers-done">H2 &#8211; Handlers &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-handler-properties-done">H3 &#8211; Handler Properties &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-writing-a-handler-done">H3 &#8211; Writing a Handler &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-example-send-email-when-chef-run-fails-done">H4 &#8211; Example: Send email when Chef run fails: &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-installing-and-configuring-a-handler-done">H3 &#8211; Installing and Configuring a Handler &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-lwrp-chef-handler-done">H4 &#8211; chef_handler: &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-manual-install-done">H4 &#8211; Manual Install: &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-distributing-handlers-done">H3 &#8211; Distributing Handlers &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-available-handlers-done">H3 &#8211; Available Handlers &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-opscode-jsonfile-handler-done">H4 &#8211; Opscode: JsonFile Handler: &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-community-open-source-handlers-done">H4 &#8211;  Community: Open Source Handlers: &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h1-workstations-done">H1 &#8211; Workstations &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h2-repository-done">H2 &#8211; Repository &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-directory-structure-done">H3 &#8211; Directory Structure &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-certificates-done">H4 &#8211; certificates/ &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-chef-done">H4 &#8211; .chef/ &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-config-done">H4 &#8211; config/ &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-cookbooks-done-this-is-the-cookbook-cache">H4 &#8211; cookbooks/ &#8211; DONE &#8211; THIS IS THE COOKBOOK CACHE!</a></li>
<li><a class="reference internal" href="#h4-data-bags-done">H4 &#8211; data_bags/ &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-environments-done">H4 &#8211; environments/ &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-roles-done">H4 &#8211; roles/ &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-create-the-chef-repository-done">H3 &#8211; Create the Chef Repository &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-clone-done">H4 &#8211; Clone &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-download-done">H4 &#8211; Download &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-knife-done">H2 &#8211; Knife &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-sub-commands-done">H3 &#8211; Sub-commands &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-plugins-done">H3 &#8211; Plugins &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-ruby-done">H2 &#8211; Ruby &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-just-enough-ruby-for-chef-done">H3 &#8211; Just Enough Ruby for Chef &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h1-the-chef-server">H1 &#8211; The Chef Server</a><ul>
<li><a class="reference internal" href="#h2-policy">H2 &#8211; Policy</a></li>
<li><a class="reference internal" href="#h2-environments-done">H2 &#8211; Environments &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-the-default-environment-done">H3 &#8211; The _default Environment &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-environment-formats-done">H3 &#8211; Environment Formats &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-ruby-dsl-done">H4 &#8211; Ruby DSL &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-json-done">H4 &#8211; JSON &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-environment-attributes-done">H3 &#8211; Environment Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-types-done">H4 &#8211; Types &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-precedence-vs-priority-pick-a-word-done">H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-persistence-done">H4 &#8211; Persistence &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-automatic-attributes-done">H4 &#8211; Automatic Attributes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-notation-done">H4 &#8211; Notation &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-create-environments-done">H3 &#8211; Create Environments &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-manage-environments-done">H3 &#8211; Manage Environments &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-save-environment-data-in-a-data-bag-done">H4 &#8211; Save Environment Data in a Data Bag &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-override-environment-attributes-in-roles-done">H4 &#8211; Override Environment Attributes in Roles - DONE</a></li>
<li><a class="reference internal" href="#h4-set-the-environment-for-a-node-done">H4 &#8211; Set the Environment for a Node &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-move-nodes-between-environments-done">H4 &#8211; Move Nodes Between Environments &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-set-per-environment-run-lists-in-roles-done">H4 &#8211; Set Per-environment Run-lists in Roles &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-searching-environments-done">H4 &#8211; Searching Environments &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-data-bags">H2 &#8211; Data Bags</a><ul>
<li><a class="reference internal" href="#h3-storing-data-bags-done">H3 &#8211; Storing Data Bags &#8211; DONE?</a><ul>
<li><a class="reference internal" href="#h4-directory-structure-done">H4 &#8211; Directory Structure &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-data-bag-items-done">H4 &#8211; Data Bag Items &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-create-data-bags-done">H3 &#8211; Create Data Bags &#8211; DONE?</a><ul>
<li><a class="reference internal" href="#h4-using-knife-done">H4 &#8211; Using Knife &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-manually-done">H4 &#8211; Manually &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-encrypting-data-bags-done">H3 &#8211; Encrypting Data Bags &#8211; DONE?</a><ul>
<li><a class="reference internal" href="#h4-knife-options-for-encryption-done">H4 &#8211; Knife Options for Encryption &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-create-an-encrypted-data-bag-item-done">H4 &#8211; Scenario: Create an encrypted data bag item &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-verify-that-a-data-bag-item-is-encrypted-done">H4 &#8211; Scenario: Verify that a data bag item is encrypted &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-decrypt-an-encrypted-data-bag-item-done">H4 &#8211; Scenario: Decrypt an encrypted data bag item &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-storing-encryption-keys-on-nodes-done">H4 &#8211; Scenario: Storing encryption keys on nodes &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-example-done">H4 &#8211; Example &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-use-data-bags-in-recipes-done">H3 &#8211; Use Data Bags in Recipes &#8211; DONE?</a><ul>
<li><a class="reference internal" href="#h4-scenario-loading-a-data-bag-item-using-the-recipe-dsl-done">H4 &#8211; Scenario: Loading a Data Bag Item using the Recipe DSL &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-creating-and-editing-data-bag-within-a-recipe-done">H4 &#8211; Scenario: Creating and Editing Data Bag within a Recipe &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-access-encrypted-data-from-a-recipe-done">H4 &#8211; Scenario: Access Encrypted Data from a Recipe &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-scenario-create-a-user-for-each-item-in-a-data-bag-done">H4 &#8211; Scenario: Create a user for each item in a data bag &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-using-search-done">H3 &#8211; Using Search &#8211; DONE?</a><ul>
<li><a class="reference internal" href="#h4-search-syntax-done">H4 &#8211; Search Syntax &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h4-accessing-data-bags-using-search-indexes-done">H4 &#8211; Accessing Data Bags using Search Indexes &#8211; DONE?</a></li>
<li><a class="reference internal" href="#id1">H4 &#8211; Example &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-use-data-bags-with-environments-done">H3 &#8211; Use Data Bags with Environments &#8211; DONE?</a></li>
<li><a class="reference internal" href="#h3-use-data-bags-with-chef-solo-done">H3 &#8211; Use Data Bags with Chef Solo &#8211; DONE?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-roles-done">H2 &#8211; Roles &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-role-formats-done">H3 &#8211; Role Formats &#8211; DONE</a><ul>
<li><a class="reference internal" href="#id2">H4 &#8211; Ruby DSL &#8211; DONE</a></li>
<li><a class="reference internal" href="#id3">H4 &#8211; JSON &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-role-attributes-done">H3 &#8211; Role Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#id4">H4 &#8211; Types &#8211; DONE</a></li>
<li><a class="reference internal" href="#id5">H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE</a></li>
<li><a class="reference internal" href="#id6">H4 &#8211; Persistence &#8211; DONE</a></li>
<li><a class="reference internal" href="#id7">H4 &#8211; Automatic Attributes &#8211; DONE</a></li>
<li><a class="reference internal" href="#id8">H4 &#8211; Notation &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-manage-roles-done">H3 &#8211; Manage Roles &#8211; DONE</a><ul>
<li><a class="reference internal" href="#deleting-environments-from-a-role-s-run-list-done">Deleting Environments from a Role&#8217;s Run-list &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-node-objects">H2 &#8211; Node Objects</a><ul>
<li><a class="reference internal" href="#h3-node-attributes-done">H3 &#8211; Node Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-attribute-types-done">H4 &#8211; Attribute Types &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-attribute-precedence-done">H4 &#8211; Attribute Precedence &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-attribute-persistence-done">H4 &#8211; Attribute Persistence &#8211; DONE</a></li>
<li><a class="reference internal" href="#id9">H4 &#8211; Automatic Attributes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-attribute-notation-done">H4 &#8211; Attribute Notation &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-deep-merging-of-attributes-done">H3 &#8211; Deep Merging of Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-substitution-done">H4 &#8211; Substitution &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-addition-done">H4 &#8211; Addition &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-run-lists">H3 &#8211; Run-lists</a><ul>
<li><a class="reference internal" href="#h4-xxxxx">H4 &#8211; xxxxx</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-search-done">H2 &#8211; Search &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-search-indexes-done">H3 &#8211; Search Indexes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-search-query-syntax-done">H3 &#8211; Search Query Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-keys-or-field-names-done">H3 &#8211; Keys (or Field Names) &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-search-patterns-done">H3 &#8211; Search Patterns &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-exact-matching-done">H4 &#8211; Exact Matching &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-wildcard-matching-done">H4 &#8211; Wildcard Matching &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-range-matching-done">H4 &#8211; Range Matching &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-fuzzy-matching-done">H4 &#8211; Fuzzy Matching &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-boolean-operators-done">H3 &#8211; Boolean Operators &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-special-characters-done">H3 &#8211; Special Characters &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-search-targets-done">H3 &#8211; Search Targets &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-roles-in-run-lists-done">H4 &#8211; Roles in Run-lists: &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-nodes-done">H4 &#8211; Nodes: &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-clients-done">H4 &#8211; Clients: &#8211; DONE</a></li>
<li><a class="reference internal" href="#id10">H4 &#8211; Environments: &#8211; DONE</a></li>
<li><a class="reference internal" href="#id11">H4 &#8211; Data Bags: &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-cookbooks-uploaded-placeholder">H2 &#8211; Cookbooks (Uploaded) &#8211; PLACEHOLDER</a></li>
<li><a class="reference internal" href="#h2-manager-management-console-done">H2 &#8211; Manager (Management Console) &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h1-cookbooks">H1 &#8211; Cookbooks</a><ul>
<li><a class="reference internal" href="#h2-cookbooks-directory-structure-done">H2 &#8211; Cookbooks Directory Structure &#8211; DONE</a></li>
<li><a class="reference internal" href="#h2-cookbook-attributes-done">H2 &#8211; Cookbook Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-when-to-use-attributes-done">H3 &#8211; When to Use Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-node-environment-role-and-attribute-file">H4 &#8211; NODE, ENVIRONMENT, ROLE, and ATTRIBUTE FILE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#types-done">Types &#8211; DONE</a></li>
<li><a class="reference internal" href="#precedence-vs-priority-pick-a-word-done">Precedence vs. Priority (PICK A WORD!) &#8211; DONE</a></li>
<li><a class="reference internal" href="#persistence-done">Persistence &#8211; DONE</a></li>
<li><a class="reference internal" href="#automatic-attributes-done">Automatic Attributes &#8211; DONE</a></li>
<li><a class="reference internal" href="#notation-done">Notation &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-attribute-files">H3 &#8211; Attribute Files</a><ul>
<li><a class="reference internal" href="#h4-attribute-file-methods">H4 &#8211; Attribute File Methods</a></li>
<li><a class="reference internal" href="#h4-cookbook-attribute-file-ordering">H4 &#8211; Cookbook Attribute File Ordering</a></li>
<li><a class="reference internal" href="#h4-attribute-accessor-methods">H4 &#8211; Attribute Accessor Methods</a></li>
<li><a class="reference internal" href="#h4-reloading-attribute-files-from-recipes">H4 &#8211; Reloading Attribute Files From Recipes</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#h2-definitions-done">H2 &#8211; Definitions &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-definition-syntax-done">H3 &#8211; Definition Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-create-a-new-resource-done">H3 &#8211; Scenario: Create a new resource &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-many-recipes-one-definition-done">H3 &#8211; Scenario: Many recipes, one definition &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-virtual-hosts-done">H3 &#8211; Scenario: Virtual hosts &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-file-distributions-done">H2 &#8211; File Distributions &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-syntax-done">H3 &#8211; Syntax(?) &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-file-specificity-done">H3 &#8211; File Specificity &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-host-notation-done">H3 &#8211; Host Notation &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-file-transfers-done">H3 &#8211; File Transfers &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-libraries-done">H2 &#8211; Libraries &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-library-syntax-done">H3 &#8211; Library Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-attributes-stored-in-file-done">H3 &#8211; Scenario: Attributes stored in file &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-loop-over-customer-records-done">H3 &#8211; Scenario: Loop over customer records &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-scenario-creating-a-namespace-done">H3 &#8211; Scenario: Creating a namespace &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-lightweight-resources-and-providers-done">H2 &#8211; Lightweight Resources and Providers &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-file-locations-done">H3 &#8211; File Locations &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-lightweight-resources-done">H3 &#8211; Lightweight Resources &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-common-functionality-for-all-lightweight-resources-done">H4 &#8211; Common Functionality for all Lightweight Resources &#8211; DONE</a></li>
<li><a class="reference internal" href="#h5-actions-done-needs-to-be-h5">H5 &#8211; Actions &#8211; DONE, NEEDS TO BE H5</a></li>
<li><a class="reference internal" href="#h5-attributes-done-needs-to-be-h5">H5 &#8211; Attributes &#8211; DONE, NEEDS TO BE H5</a></li>
<li><a class="reference internal" href="#h5-conditional-execution-done-needs-to-be-h5">H5 &#8211; Conditional Execution &#8211; DONE, NEEDS TO BE H5</a></li>
<li><a class="reference internal" href="#h5-notifications-done-needs-to-be-h5">H5 &#8211; Notifications &#8211; DONE, NEEDS TO BE H5</a></li>
<li><a class="reference internal" href="#h5-relative-paths-done-needs-to-be-h5">H5 &#8211; Relative Paths &#8211; DONE, NEEDS TO BE H5</a></li>
<li><a class="reference internal" href="#h4-actions-done">H4 &#8211; Actions &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-attributes-and-validation-parameters-done">H4 &#8211; Attributes and Validation Parameters &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-syntax-done">H4 &#8211; Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-compare-platform-and-lightweight-resources-done">H4 &#8211; Compare Platform and Lightweight Resources &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-use-a-default-provider-done">H4 &#8211; Use a Default Provider &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-lightweight-providers-done">H3 &#8211; Lightweight Providers &#8211; DONE</a><ul>
<li><a class="reference internal" href="#id12">H4 &#8211; Actions &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-extending-providers-done">H4 &#8211; Extending Providers &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-example-create-lightweight-provider-and-resource-done">H3 &#8211; Example: Create Lightweight Provider and Resource &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-metadata-done">H2 &#8211; Metadata &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-metadata-rb-done">H3 &#8211; metadata.rb &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-error-messages-done">H3 &#8211; Error Messages &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-recipes-done">H2 &#8211; Recipes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-apply-recipes-to-run-lists-done">H3 &#8211; Apply Recipes to Run-lists &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-include-recipes-in-recipes-done">H3 &#8211; Include Recipes in Recipes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-cookbook-dependencies-done">H3 &#8211; Cookbook Dependencies &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-recipe-attributes-done">H3 &#8211; Recipe Attributes &#8211; DONE</a><ul>
<li><a class="reference internal" href="#id13">H4 &#8211; Types &#8211; DONE</a></li>
<li><a class="reference internal" href="#id14">H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE</a></li>
<li><a class="reference internal" href="#id15">H4 &#8211; Persistence &#8211; DONE</a></li>
<li><a class="reference internal" href="#id16">H4 &#8211; Automatic Attributes &#8211; DONE</a></li>
<li><a class="reference internal" href="#id17">H4 &#8211; Notation &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-attribute-methods">H4 &#8211; Attribute Methods</a></li>
<li><a class="reference internal" href="#h4-reloading-attributes-from-recipes">H4 &#8211; Reloading Attributes From Recipes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">H3 &#8211; Search Indexes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-data-bags-done">H3 &#8211; Data Bags &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-other-recipe-dsl-methods-done-deprecate">H3 &#8211; Other Recipe DSL Methods &#8211; DONE, DEPRECATE?</a></li>
<li><a class="reference internal" href="#h3-tags-done-but-weak">H3 &#8211; Tags &#8211; DONE, BUT WEAK</a></li>
<li><a class="reference internal" href="#h3-ruby-in-recipes-done">H3 &#8211; Ruby in Recipes &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-exceptions-and-logging-done">H3 &#8211; Exceptions and Logging &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-resources-and-providers-done">H2 - Resources and Providers &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-resources-syntax-done">H3 &#8211; Resources Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-platform-resources-done">H3 &#8211; Platform Resources &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-platform-providers-done">H3 &#8211; Platform Providers &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h2-templates-done">H2 &#8211; Templates &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h3-requirements-done">H3 &#8211; Requirements &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-variables-done">H3 &#8211; Variables &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-location-specificity-done">H3 &#8211; Location Specificity &#8211; DONE</a></li>
<li><a class="reference internal" href="#id19">H3 &#8211; Host Notation &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-transfer-frequency-done">H3 &#8211; Transfer Frequency &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-versions-done">H3 &#8211; Versions &#8211; DONE</a></li>
<li><a class="reference internal" href="#id20">H3 &#8211; Syntax &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-operators-done">H3 &#8211; Operators &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-version-constraints-done">H3 &#8211; Version Constraints &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-metadata-in-metadata-rb-done">H3 &#8211; Metadata (in metadata.rb) &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-environments-done">H3 &#8211; Environments &#8211; DONE</a></li>
<li><a class="reference internal" href="#h3-run-list-items-done">H3 &#8211; Run-list Items &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-freezing-versions-done">H4 &#8211; Freezing Versions &#8211; DONE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#h3-version-control-strategies-done">H3 &#8211; Version Control Strategies &#8211; DONE</a><ul>
<li><a class="reference internal" href="#h4-branch-tracking-done">H4 &#8211; Branch Tracking &#8211; DONE</a></li>
<li><a class="reference internal" href="#h4-maximum-version-control-done">H4 &#8211; Maximum Version Control &#8211; DONE</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="chef-essentials">
<h1>Chef Essentials<a class="headerlink" href="#chef-essentials" title="Permalink to this headline">¶</a></h1>
<p>Chef is a systems and cloud infrastructure automation framework that makes it easy to deploy servers and applications to any physical, virtual, and cloud location, no matter the size of your infrastructure. Chef relies on abstract definitions (known as cookbooks and recipes) that are written in Ruby and are managed like source code. Each definition describes how a specific part of your infrastructure should be built and managed. Chef then applies those definitions to servers and applications, as specified, resulting in a fully automated infrastructure. When a new server comes online, the only thing that Chef needs to know is which cookbooks and recipes to apply.</p>
<p>The following diagram shows the relationships between the various components of a Chef deployment, including the nodes, server, and workstations, and the various elements that work together to provide Chef the information that it needs to automate the infrastructure in your environment.</p>
<img alt="_images/overview_chef_draft.png" src="_images/overview_chef_draft.png" />
<p>Chef is comprised of three main elements: a server, one (or more) nodes, and at least one workstation. The Chef server acts as a hub, ensuring that the right cookbooks are used, that the right policies are being applied, that all of the node objects are up-to-date, and that all of the nodes that will be maintained are registered and known to the Chef server. The workstation is the location from which most of the work happens, including authoring cookbooks, synchronizing with the repository, and uploading certain information to the server. The nodes host the various servers and applications in the cloud or on physical devices; each node contains a chef-client that performs the various infrastructure automation tasks that each node requires.</p>
<p>The following sections discuss these elements (and their various sub-components) in more detail:</p>
<ul class="simple">
<li>Nodes</li>
<li>Workstations</li>
<li>The Chef Server</li>
<li>Cookbooks</li>
</ul>
<p>CUT THE FOLLOWING OUT. BUT KEEP IT IN MIND FOR THE FUTURE.</p>
<p>Basic Workflows (PLACEHOLDER JUST FOR IDEAS FOR NOW):</p>
<ul class="simple">
<li>Workflow A: Cookbooks</li>
<li>Workflow B: Setup Workstations</li>
<li>Workflow C: Setup Server</li>
<li>Workflow D: Setup Nodes</li>
<li>Workflow E: Chef Runs &gt;&gt; tying cookbooks + server + nodes together</li>
<li>Workflow F: Maintaining Nodes</li>
</ul>
<p>These should be high-level, each with a diagram that is based on the main-diagram. The actual workflow shouldn&#8217;t be more than a paragraph (with bullets = OK) and should NOT get into the weeds.</p>
<div class="section" id="h1-nodes-done">
<h2>H1 &#8211; Nodes &#8211; DONE<a class="headerlink" href="#h1-nodes-done" title="Permalink to this headline">¶</a></h2>
<p>A node is a server or virtual server that is configured to be maintained by a chef-client. A node can be physical or cloud-based. A Chef organization can be comprised of any combination of physical and cloud-based nodes. The chef-client runs on each node and Ohai is used to collect data about the system so that Chef can use it. Each node keeps a cache that contains the most recent node object and all of the cookbooks that are used during configuration of the node.</p>
<p>The name of each node must be unique within the Chef organization, but otherwise can be any string that matches the following regular expression:</p>
<div class="highlight-python"><pre>/^[\-[:alnum:]_:.]+$/</pre>
</div>
<p>There are several ways to manage nodes, including by using Knife or the Management Console or by using command-line tools that are specific to the chef-client or to Chef Solo.</p>
<ul class="simple">
<li>Knife can be used to create, edit, view, list, tag, and delete nodes.</li>
<li>Knife plug-ins can be used to create, edit, and manage nodes that are located on cloud providers.</li>
<li>The Management Console on the Chef server can be used to create, edit, view, list, tag, and delete nodes. In addition, node attributes can be modified and nodes can be moved between environments.</li>
<li>The chef-client can be used to manage node data using the command line and JSON files (that contain a hash, the elements of which are added as node attributes). In addition, the <tt class="docutils literal"><span class="pre">run_list</span></tt> setting allows roles and/or recipes to be added to the node.</li>
<li>Chef Solo can be used to manage node data using the command line and JSON files (that contain a hash, the elements of which are added as node attributes). In addition, the <tt class="docutils literal"><span class="pre">run_list</span></tt> setting allows roles and/or recipes to be added to the node.</li>
<li>The command line can also be used to edit JSON files and files that are related to third-party services, such as Amazon EC2, where the JSON files can contain per-instance metadata stored in a file on-disk and then read by Chef Solo or chef-client as required.</li>
</ul>
<p>The following sections discuss these elements (and their various sub-components) in more detail:</p>
<ul class="simple">
<li>Cloud vs. Physical Nodes</li>
<li>chef-client</li>
<li>The Chef run</li>
<li>Ohai</li>
</ul>
<div class="section" id="h2-cloud-vs-physical-nodes-done">
<h3>H2 &#8211; Cloud vs. Physical Nodes &#8211; DONE<a class="headerlink" href="#h2-cloud-vs-physical-nodes-done" title="Permalink to this headline">¶</a></h3>
<p>A cloud-based node is hosted in an external cloud-based service, such as Amazon Virtual Private Cloud, OpenStack, Rackspace, Google Compute Engine, Linode, or Windows Azure. Knife can create instances on these cloud-based services so that Chef can be used to deploy, configure, and maintain those instances.</p>
<p>A physical node is typically a server or a virtual machine, but it can be any active device attached to a network that is capable of sending, receiving, and forwarding information over a communications channel. In other words, a physical node is a any active device attached to a network that can do both of the following: run a chef-client and communicate with a Chef server.</p>
</div>
<div class="section" id="h2-chef-client-done">
<h3>H2 &#8211; chef-client &#8211; DONE<a class="headerlink" href="#h2-chef-client-done" title="Permalink to this headline">¶</a></h3>
<p>A chef-client is an agent that runs locally on every node that is registered with the Chef server. When a chef-client is run, it will perform all of the steps that are required to bring the node into the expected state, including:</p>
<ul class="simple">
<li>Building, registering, and authenticating the node with the Chef server</li>
<li>Synchronizing each required cookbook with the local file cache</li>
<li>Compiling the resource collection by loading each of the required cookbooks, including recipes, attributes, and all other dependencies</li>
<li>Taking the appropriate and required actions to configure the node</li>
<li>Looking for exceptions and notifications, handling each as required</li>
</ul>
<div class="section" id="h3-ssl-certificates-done">
<h4>H3 &#8211; SSL Certificates &#8211; DONE<a class="headerlink" href="#h3-ssl-certificates-done" title="Permalink to this headline">¶</a></h4>
<p>An SSL certificate is used between the chef-client and the Chef server to ensure that each node has access to the right data.</p>
<p><strong>jamescott: someone needs to explain how the security works between the node and the server. I know it uses SSL and that signed headers + private/public keys are used. This (probably) needs to be excised from the Chef Essentials docs and moved into a Chef Security collection of topics. Or something.</strong></p>
<div class="section" id="h4-signed-headers-done">
<h5>H4 &#8211; Signed Headers &#8211; DONE<a class="headerlink" href="#h4-signed-headers-done" title="Permalink to this headline">¶</a></h5>
<p>Chef uses signed header authentication to validate communications between the Chef server and any node that is being managed by the Chef server. An API client manages each authentication request. A public and private key pair is used for the authentication itself. The public key is stored in the database on the Chef server. The private key is stored locally on each node and is kept separate from node data (typically in the /etc/chef/client.pem directory). Each request to the Chef server by a node must include a request signature in the HTTP headers. This signature is computed from a hash of request content and is encrypted using the private key.</p>
</div>
<div class="section" id="h4-chef-validator-doneish">
<h5>H4 &#8211; chef-validator &#8211; DONEish<a class="headerlink" href="#h4-chef-validator-doneish" title="Permalink to this headline">¶</a></h5>
<p>When a node runs chef-client for the first time, it generally does not yet have an API client identity, and so cannot make authenticated requests to the server. This is where the validation client (named chef-validator) comes in. When the chef-client runs, it checks if it has a client key. If the client key does not exist, it then attempts to borrow the validation client&#8217;s identity to register itself with the Chef server. In order to do that, the validation client&#8217;s private key needs to be copied to the host and placed in /etc/chef/validation.pem. Once the chef-client has registered itself with the Chef server, it no longer uses the validation client for anything. It is recommended that you delete the validation client&#8217;s private key from the host after the host has registered or use the <tt class="docutils literal"><span class="pre">delete_validation</span></tt> recipe that can be found in the <tt class="docutils literal"><span class="pre">chef-client</span></tt> cookbook (<a class="reference external" href="http://community.opscode.com/cookbooks/chef-client">http://community.opscode.com/cookbooks/chef-client</a>).</p>
</div>
</div>
</div>
<div class="section" id="h2-the-chef-run-xxxxx">
<h3>H2 &#8211; The Chef Run &#8211; xxxxx<a class="headerlink" href="#h2-the-chef-run-xxxxx" title="Permalink to this headline">¶</a></h3>
<p>SEE INDEX_NEW. NEEDS UPDATING AND NEW DIAGRAM. IN JAMES&#8217; QUEUE.</p>
</div>
<div class="section" id="h2-ohai-done">
<h3>H2 &#8211; Ohai &#8211; DONE<a class="headerlink" href="#h2-ohai-done" title="Permalink to this headline">¶</a></h3>
<p>Ohai is a monitoring tool that is used to detect certain properties about the node environment and then report them back to Chef as node attributes. The types of properties Ohai reports on include:</p>
<ul class="simple">
<li>Platform details</li>
<li>Networking usage</li>
<li>Memory usage</li>
<li>Processor usage</li>
<li>Kernel data</li>
<li>Host names</li>
<li>Fully qualified domain names</li>
<li>and other configuration details</li>
</ul>
<p>Ohai reports each piece of data back to the Chef server as a node attribute. Later, while Chef configures a node, these attributes are used to ensure that certain properties remain unchanged. Ohai is part of the required configuration on each node that is registered with the Chef server.</p>
<div class="section" id="h3-automatic-attributes">
<h4>H3 &#8211; Automatic Attributes<a class="headerlink" href="#h3-automatic-attributes" title="Permalink to this headline">¶</a></h4>
<p>An automatic attribute is a specific detail about a node, such as an IP address, a host name, a list of loaded kernel modules, the version(s) of available programming languages that are available, and so on. Automatic attributes are detected by Ohai and are then used by Chef to ensure that these attribute are handled properly during every Chef run. The most commonly accessed automatic attributes are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node['platform']</span></tt></td>
<td>The platform on which a node is running. This attribute helps determine which providers will be used.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">node['platform_version']</span></tt></td>
<td>The version of the platform. This attribute helps determine which providers will be used.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node['ipaddress']</span></tt></td>
<td>The IP address for a node. If the node has a default route, this is the IPV4 address for the interface. If the node does not have a default route, the value for this attribute should be <tt class="docutils literal"><span class="pre">nil</span></tt>. The IP address for default route is the recommended default value.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">node['macaddress']</span></tt></td>
<td>The MAC address for a node, determined by the same interface that detects the <tt class="docutils literal"><span class="pre">node['ipaddress']</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node['fqdn']</span></tt></td>
<td>The fully qualified domain name for a node. This is used as the name of a node unless otherwise set.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">node['hostname']</span></tt></td>
<td>The host name for the node.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node['domain']</span></tt></td>
<td>The domain for the node.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">node['recipes']</span></tt></td>
<td>A list of recipes associated with a node (and part of that node&#8217;s run-list).</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node['roles']</span></tt></td>
<td>A list of roles associated with a node (and part of that node&#8217;s run-list).</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">node['ohai_time']</span></tt></td>
<td>The time at which Ohai was last run. This attribute is not commonly used in recipes, but it is saved to the Chef server and can be accessed using the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">status</span></tt> sub-command.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-ohai-attribute-list-done">
<h4>H3 &#8211; Ohai Attribute List &#8211; DONE<a class="headerlink" href="#h3-ohai-attribute-list-done" title="Permalink to this headline">¶</a></h4>
<p>The following attributes are those which are re-written with each Ohai run, so they should be recognized as being unmodifiable when considering the use of attributes:</p>
<div class="highlight-bash"><div class="highlight"><pre>ohai<span class="nv">$ </span>grep -R <span class="s2">&quot;provides&quot;</span> -h lib/ohai/plugins|sed <span class="s1">&#39;s/^\s*//g&#39;</span>|sed <span class="s2">&quot;s/\\\&quot;/\&#39;/g&quot;</span>|sort|uniq|grep ^provides
</pre></div>
</div>
</div>
</div>
<div class="section" id="h2-handlers-done">
<h3>H2 &#8211; Handlers &#8211; DONE<a class="headerlink" href="#h2-handlers-done" title="Permalink to this headline">¶</a></h3>
<p>A handler is a feature of Chef that is used to trigger certain behaviors in response to certain situations, typically identified during a Chef run.</p>
<ul class="simple">
<li>An exception handler is used to trigger behaviors when a defined aspect of a Chef run fails.</li>
<li>A report handler is used to trigger behaviors when a defined aspect of a Chef run is successful.</li>
</ul>
<p>Both types of handlers can be used to gather data about a Chef run, and when used across the entire Chef organization, can provide rich levels of data about all types of Chef usage that can be used later for trending and analysis. <strong>jamescott: this really needs to be re-written. Basically, Chef can track GOBS of data based on the success/fail of a Chef run and then once collected, the customer can do LOTS OF THINGS with it, including to trigger custom actions based on exceptions (and probably not based on reports) so that the system can adjust in real-time to things that go wrong. JUST A GUESS.</strong></p>
<div class="section" id="h3-handler-properties-done">
<h4>H3 &#8211; Handler Properties &#8211; DONE<a class="headerlink" href="#h3-handler-properties-done" title="Permalink to this headline">¶</a></h4>
<p>A handler is a class that inherits from <tt class="docutils literal"><span class="pre">Chef::Handler</span></tt> and implements the <tt class="docutils literal"><span class="pre">report()</span></tt> function. A handler may be assigned as a report or an exception handler (even though there is no real difference in the underlying code): a report handler runs when the <tt class="docutils literal"><span class="pre">success</span></tt> indicator is associated with the event message and an exception handler runs when the <tt class="docutils literal"><span class="pre">failed</span></tt> indicator is associated with the event message. Before <tt class="docutils literal"><span class="pre">report()</span></tt> is run, <tt class="docutils literal"><span class="pre">run_status</span></tt> is initialized by Chef. <tt class="docutils literal"><span class="pre">run_status</span></tt> is an instance of <tt class="docutils literal"><span class="pre">Chef::RunStatus</span></tt>, which is a class that keeps track of the status of a Chef run. <tt class="docutils literal"><span class="pre">run_status</span></tt> provides the following properties:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">success?</span></tt> or <tt class="docutils literal"><span class="pre">failed?</span></tt></td>
<td>Indicates whether the Chef run was successful.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">backtrace</span></tt></td>
<td>The backtrace for the exception, if present.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">exception</span></tt></td>
<td>The raw exception data, if present.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">formatted_exception</span></tt></td>
<td>The exception as a formatted string, for example: <tt class="docutils literal"><span class="pre">ExceptionClass:</span> <span class="pre">message</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">node</span></tt></td>
<td>The node for which the Chef run occurred.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">all_resources</span></tt></td>
<td>The list of all resources included in the <tt class="docutils literal"><span class="pre">resource_collection</span></tt> property for the current Chef run.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">updated_resources</span></tt></td>
<td>The list of all resources included in the <tt class="docutils literal"><span class="pre">resource_collection</span></tt> property for the current Chef run and that are marked as updated.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">elapsed_time</span></tt></td>
<td>The time elapsed between the <tt class="docutils literal"><span class="pre">start_time</span></tt> and <tt class="docutils literal"><span class="pre">finish_time</span></tt> of the Chef run.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">start_time</span></tt></td>
<td>The time the Chef run started.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">end_time</span></tt></td>
<td>The time the Chef run ended.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">run_context</span></tt></td>
<td>An instance of <tt class="docutils literal"><span class="pre">Chef::RunContext</span></tt> that is used to keep track of the context of the Chef run. It provides access to the following properties: <tt class="docutils literal"><span class="pre">cookbook_collection</span></tt>, <tt class="docutils literal"><span class="pre">resource_collection</span></tt>, and <tt class="docutils literal"><span class="pre">definitions</span></tt>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-writing-a-handler-done">
<h4>H3 &#8211; Writing a Handler &#8211; DONE<a class="headerlink" href="#h3-writing-a-handler-done" title="Permalink to this headline">¶</a></h4>
<p>A custom handler can be created to do just about anything. Chef a cookbook called <tt class="docutils literal"><span class="pre">chef_handler</span></tt> that contains a lightweight resource provider that allows custom handlers to be easily included within recipes. A custom handler can created to support just about any custom action or behavior that needs to be integrated into Chef.</p>
<div class="section" id="h4-example-send-email-when-chef-run-fails-done">
<h5>H4 &#8211; Example: Send email when Chef run fails: &#8211; DONE<a class="headerlink" href="#h4-example-send-email-when-chef-run-fails-done" title="Permalink to this headline">¶</a></h5>
<p>This example describes a simple handler that sends an email when a Chef run fails. The handler uses the pony library (<a class="reference external" href="https://github.com/benprew/pony">https://github.com/benprew/pony</a>), which is an &#8220;express way to send email in Ruby&#8221;. For this example to work, it must be possible to send email via /usr/sbin/sendmail or via SMTP to localhost. The following example shows how to use the pony library to send email:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;pony&#39;</span>

<span class="k">module</span> <span class="nn">MyOrganization</span>
  <span class="k">class</span> <span class="nc">EmailMe</span> <span class="o">&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Handler</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">from_address</span><span class="p">,</span> <span class="n">to_address</span><span class="p">)</span>
    <span class="vi">@from_address</span> <span class="o">=</span> <span class="n">from_address</span>
    <span class="vi">@to_address</span>   <span class="o">=</span> <span class="n">to_address</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">report</span>
    <span class="c1"># The Node is available as +node+</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Chef run failed on </span><span class="si">#{</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># +run_status+ is a value object with all of the run status data</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">run_status</span><span class="o">.</span><span class="n">formatted_exception</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="c1"># Join the backtrace lines. Coerce to an array just in case.</span>
    <span class="n">message</span> <span class="o">&lt;&lt;</span> <span class="nb">Array</span><span class="p">(</span><span class="n">backtrace</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="no">Pony</span><span class="o">.</span><span class="n">mail</span><span class="p">(</span><span class="ss">:to</span> <span class="o">=&gt;</span> <span class="vi">@to_address</span><span class="p">,</span> <span class="ss">:from</span> <span class="o">=&gt;</span> <span class="vi">@from_address</span><span class="p">,</span> <span class="ss">:subject</span> <span class="o">=&gt;</span> <span class="n">subject</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>This example can be extended as required.</p>
</div>
</div>
<div class="section" id="h3-installing-and-configuring-a-handler-done">
<h4>H3 &#8211; Installing and Configuring a Handler &#8211; DONE<a class="headerlink" href="#h3-installing-and-configuring-a-handler-done" title="Permalink to this headline">¶</a></h4>
<p>A handler can be installed and configured in two ways: by using the chef_handler lightweight resource provider (LWRP) or by a manual process.</p>
<div class="section" id="h4-lwrp-chef-handler-done">
<h5>H4 &#8211; chef_handler: &#8211; DONE<a class="headerlink" href="#h4-lwrp-chef-handler-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">chef_handler</span></tt> lightweight resource provider (LWRP) allows report and exception handlers to be enabled within recipes using Ruby code, as opposed to them being hard-coded in the client.rb file. It ships as part of the <tt class="docutils literal"><span class="pre">chef_handler</span></tt> cookbook and provides a resource that can be easily included in recipes. To use the chef_handler in a recipe, add the following Ruby code:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">chef_hander</span> <span class="s2">&quot;MyOrganization::EmailMe&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;/var/chef/handlers/email_me&quot;</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-manual-install-done">
<h5>H4 &#8211; Manual Install: &#8211; DONE<a class="headerlink" href="#h4-manual-install-done" title="Permalink to this headline">¶</a></h5>
<p>To manually install and configure a handler, the client.rb file must be edited. There is no default install location for handlers. The simplest way to distribute and install them is via RubyGems, though many methods (github, HTTP, and so on) will also work. Once the handler is installed on the system, enable it in the client.rb file by requiring it.</p>
<p>For example, if RubyGems was used to install the handler, adding the following to the client.rb file will enable it:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;name_of_handler&quot;</span>
</pre></div>
</div>
<p>Or if the handler was installed using another method, it may need to be required using the full path to the file:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;/var/chef/handlers/email_me&quot;</span>         <span class="c1"># the installation path</span>
</pre></div>
</div>
<p>After the handler is installed, it may require additional configuration. This will vary from handler to handler. If a handler is a very simple handler, it may only require the creation of a new instance. For example, if a handler named <tt class="docutils literal"><span class="pre">MyOrganization::EmailMe</span></tt> is hardcoded for all of the values required to send email, a new instance is required:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">email_handler</span> <span class="o">=</span> <span class="no">MyOrganization</span><span class="o">::</span><span class="no">EmailMe</span><span class="o">.</span><span class="n">new</span>   <span class="c1"># a simple handler</span>
</pre></div>
</div>
<p>and then the notification types need to be configured:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="n">email_handler</span>              <span class="c1"># these fire at the end of a successful run</span>
<span class="n">exception_handlers</span> <span class="o">&lt;&lt;</span> <span class="n">email_handler</span>           <span class="c1"># these fire at the end of a failed run</span>
</pre></div>
</div>
<p>Additional configuration steps will vary from handler to handler. For a simple handler, the required additions to the client.rb file (when pulled together into a single code block) would look like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;/var/chef/handlers/email_me&quot;</span>         <span class="c1"># the installation path</span>

<span class="n">email_handler</span> <span class="o">=</span> <span class="no">MyOrganization</span><span class="o">::</span><span class="no">EmailMe</span><span class="o">.</span><span class="n">new</span>   <span class="c1"># a simple handler</span>

<span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="n">email_handler</span>              <span class="c1"># these fire at the end of a successful run</span>
<span class="n">exception_handlers</span> <span class="o">&lt;&lt;</span> <span class="n">email_handler</span>           <span class="c1"># these fire at the end of a failed run</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="h3-distributing-handlers-done">
<h4>H3 &#8211; Distributing Handlers &#8211; DONE<a class="headerlink" href="#h3-distributing-handlers-done" title="Permalink to this headline">¶</a></h4>
<p>A handler can be distributed using a specific cookbook that is provided by Opscode to help facilitate the distribution of custom Chef handlers. The <tt class="docutils literal"><span class="pre">chef_handler</span></tt> cookbook exposes a lightweight resource provider that can be used to enable custom handlers from within recipes and is useful when including product-specific handlers in cookbooks. The <tt class="docutils literal"><span class="pre">chef_hander</span></tt> cookbook can be accessed here: <a class="reference external" href="http://community.opscode.com/chef_handler">http://community.opscode.com/chef_handler</a>. See the README.md of the <tt class="docutils literal"><span class="pre">chef_handler</span></tt> cookbook for additional information.</p>
</div>
<div class="section" id="h3-available-handlers-done">
<h4>H3 &#8211; Available Handlers &#8211; DONE<a class="headerlink" href="#h3-available-handlers-done" title="Permalink to this headline">¶</a></h4>
<p>Chef includes one handler (<tt class="docutils literal"><span class="pre">JsonFile</span></tt>) and the Chef community provides a number of open-source handlers that can be used by anyone in the Chef community.</p>
<div class="section" id="h4-opscode-jsonfile-handler-done">
<h5>H4 &#8211; Opscode: JsonFile Handler: &#8211; DONE<a class="headerlink" href="#h4-opscode-jsonfile-handler-done" title="Permalink to this headline">¶</a></h5>
<p>Chef includes a handler that serializes run status data to a JSON file. This handler needs to be enabled by adding the following lines of Ruby code to either client.rb or solo.rb:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;chef/handler/json_file&#39;</span>
<span class="n">report_handlers</span> <span class="o">&lt;&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Handler</span><span class="o">::</span><span class="no">JsonFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/var/chef/reports&quot;</span><span class="p">)</span>
<span class="n">exception_handlers</span> <span class="o">&lt;&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Handler</span><span class="o">::</span><span class="no">JsonFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/var/chef/reports&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>There is a LWRP entry:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">chef_handler</span> <span class="s2">&quot;Chef::Handler::JsonFile&quot;</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">&quot;chef/handler/json_file&quot;</span>
  <span class="n">arguments</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">&#39;/var/chef/reports&#39;</span>
  <span class="n">action</span> <span class="ss">:enable</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The run status data can be loaded and inspected via irb:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">002</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;json&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">003</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="nb">require</span> <span class="s1">&#39;chef&#39;</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">004</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">IO</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;/var/chef/reports/chef-run-report-20110322060731.json&quot;</span><span class="p">))</span> <span class="o">=&gt;</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="n">output</span> <span class="n">truncated</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">005</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">keys</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_resources&quot;</span><span class="p">,</span> <span class="s2">&quot;exception&quot;</span><span class="p">,</span> <span class="s2">&quot;all_resources&quot;</span><span class="p">,</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;elapsed_time&quot;</span><span class="p">,</span> <span class="s2">&quot;start_time&quot;</span><span class="p">,</span> <span class="s2">&quot;backtrace&quot;</span><span class="o">]</span>
<span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">006</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">r</span><span class="o">[</span><span class="s1">&#39;elapsed_time&#39;</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mo">00246</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-community-open-source-handlers-done">
<h5>H4 &#8211;  Community: Open Source Handlers: &#8211; DONE<a class="headerlink" href="#h4-community-open-source-handlers-done" title="Permalink to this headline">¶</a></h5>
<p>The following handlers are available in the Chef open source community:</p>
<p><strong>jamescott: each of these needs to be researched and better described. ALSO &#8211; need a standard naming convention for the names of the plugins. Some have their &#8220;github&#8221; path, whereas others have branded/friendly names. PICK ONE.</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Handler</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Airbrake</td>
<td>A Chef handler that sends exceptions (only) to Airbrake, an application that collects data and aggregates it for review. The Airbrake handler is available from: <a class="reference external" href="https://github.com/morgoth/airbrake_handler">https://github.com/morgoth/airbrake_handler</a>.</td>
</tr>
<tr class="row-odd"><td>Asynchronous Resources</td>
<td>A Chef handler that asynchronously pushes exception and report handler data to a STOMP queue, from which data can be processed into data storage. The asynchronous resources handler is available from: <a class="reference external" href="https://github.com/rottenbytes/chef/tree/master/async_handler">https://github.com/rottenbytes/chef/tree/master/async_handler</a>.</td>
</tr>
<tr class="row-even"><td>Campfire</td>
<td>A Chef handler that collects exception and report handler data and reports it to Campfire, a web-based group chat tool. The Campfire handler is available from: <a class="reference external" href="https://github.com/ampledata/chef-handler-campfire">https://github.com/ampledata/chef-handler-campfire</a>.</td>
</tr>
<tr class="row-odd"><td>Cloudkick</td>
<td>A Chef handler that collects exception and report handler data and sends it to Cloudkick, a set of cloud server monitoring and management tools. The Cloudkick handler is available from: <a class="reference external" href="https://github.com/ampledata/chef/blob/master/chef/lib/chef/handler/cloudkick_handler.rb">https://github.com/ampledata/chef/blob/master/chef/lib/chef/handler/cloudkick_handler.rb</a>.</td>
</tr>
<tr class="row-even"><td>DATADOG</td>
<td>A Chef handler that collects Chef stats and sends them into a DATADOG newsfeed. The DATADOG handler is available from: <a class="reference external" href="https://github.com/DataDog/chef-handler-datadog">https://github.com/DataDog/chef-handler-datadog</a>.</td>
</tr>
<tr class="row-odd"><td>Graphite</td>
<td>A Chef handler that collects exception and report handler data and reports it to Graphite, a graphic rendering application. The Graphite handler is available from: <a class="reference external" href="https://github.com/imeyer/chef-handler-graphite/wiki">https://github.com/imeyer/chef-handler-graphite/wiki</a>.</td>
</tr>
<tr class="row-even"><td>Graylog2 / Graylog Extended Log Format (GELF)</td>
<td>A Chef handler that provides exception and report handler status (including changes) to a Graylog2 server, so that the data can be viewed using Graylog Extended Log Format (GELF). The Graylog2 handler is available from: <a class="reference external" href="https://github.com/jellybob/chef-gelf/">https://github.com/jellybob/chef-gelf/</a>.</td>
</tr>
<tr class="row-odd"><td>Growl</td>
<td>A Chef handler that collects exception and report handler data and then sends it as a Growl notification. The Growl handler is available from: <a class="reference external" href="http://rubygems.org/gems/chef-handler-growl">http://rubygems.org/gems/chef-handler-growl</a>.</td>
</tr>
<tr class="row-even"><td>HipChat</td>
<td>A Chef handler that collects exception handler data and sends it to HipChat, a hosted private chat service for companies and teams. The HipChat handler is available from: <a class="reference external" href="https://github.com/mojotech/hipchat/blob/master/lib/hipchat/chef.rb">https://github.com/mojotech/hipchat/blob/master/lib/hipchat/chef.rb</a>.</td>
</tr>
<tr class="row-odd"><td>IRC Snitch</td>
<td>A Chef handler that notifies administrators (via Internet Relay Chat (IRC)) when a Chef run fails. The IRC Snitch handler is available from: <a class="reference external" href="https://rubygems.org/gems/chef-irc-snitch">https://rubygems.org/gems/chef-irc-snitch</a>.</td>
</tr>
<tr class="row-even"><td>NSCA</td>
<td>A Chef handler that supports NSCA, an add-on for Nagios. This will allow Chef report and exception handler messages to be passed to Nagios from NSCA. The NSCA handler is available from: <a class="reference external" href="https://github.com/ranjibd/nsca_handler">https://github.com/ranjibd/nsca_handler</a>.</td>
</tr>
<tr class="row-odd"><td>Simple Email</td>
<td>A Chef handler that collects exception and report handler data and then uses pony to send email reports that are based on Erubis templates. The simple email handler is available from: <a class="reference external" href="https://rubygems.org/gems/chef-handler-mail">https://rubygems.org/gems/chef-handler-mail</a>.</td>
</tr>
<tr class="row-even"><td>Splunk Storm</td>
<td>A Chef handler that supports exceptions and reports for Splunk Storm. The Splunk Storm handler is available from: <a class="reference external" href="http://ampledata.org/splunk_storm_chef_handler.html">http://ampledata.org/splunk_storm_chef_handler.html</a>.</td>
</tr>
<tr class="row-odd"><td>Updated Resources</td>
<td>A Chef handler that provides a simple way to display resources that were updated during a Chef run. The updated resources handler is available from: <a class="reference external" href="https://rubygems.org/gems/chef-handler-updated-resources">https://rubygems.org/gems/chef-handler-updated-resources</a>.</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="section" id="h1-workstations-done">
<h2>H1 &#8211; Workstations &#8211; DONE<a class="headerlink" href="#h1-workstations-done" title="Permalink to this headline">¶</a></h2>
<p>The workstation is a computer that is configured to run Knife, synchronize with the Chef repository, and to interact with a single Chef server. All of the most important details needed by Chef&#8212;cookbooks and recipes, role and environment data, important settings&#8212;are stored in the Chef repository using version source control. The workstation is the location from which most users of Chef will do most of their work, including:</p>
<ul class="simple">
<li>Developing cookbooks and recipes (and authoring them using Ruby)</li>
<li>Keeping the Chef repository synchronized with version source control</li>
<li>Using Knife to upload items from the Chef repository to the Chef server</li>
<li>Configuring organizational policy, including defining roles and environments and ensuring that critical data is stored in data bags</li>
<li>Interacting with nodes, as (or when) required, such as performing a bootstrap operation</li>
</ul>
<p>The following sections discuss these elements (and their various sub-components) in more detail:</p>
<ul class="simple">
<li>Repository</li>
<li>Knife</li>
<li>Ruby</li>
</ul>
<div class="section" id="h2-repository-done">
<h3>H2 &#8211; Repository &#8211; DONE<a class="headerlink" href="#h2-repository-done" title="Permalink to this headline">¶</a></h3>
<p>The Chef repository is a location in which important configuration data is stored:</p>
<ul class="simple">
<li>Cookbooks (including recipes, versions, and cookbook attributes)</li>
<li>Roles</li>
<li>Data bags</li>
<li>Environments</li>
<li>Configuration files (for clients, workstations, and servers)</li>
</ul>
<p>The repository is synchronized with a workstation. The Chef repository should be synchronized with a version control system, such as git, and then treated like source code.</p>
<p>The Chef repository is made available from github. It can be cloned from github or downloaded as a tar.gz file (and then associated with another version source control system, such as Subversion, Mercurial, or Bazaar).</p>
<p>Knife is used to upload repository data to the Chef server from the workstation. Once uploaded, that data is used to manage all of the nodes that are registered with the Chef server and to ensure that the correct cookbooks, environments, and roles are applied to the correct nodes.</p>
<div class="section" id="h3-directory-structure-done">
<h4>H3 &#8211; Directory Structure &#8211; DONE<a class="headerlink" href="#h3-directory-structure-done" title="Permalink to this headline">¶</a></h4>
<p>The chef-repo contains several directories, each with a README file that describes what it is for and how to use that directory when managing systems with Chef. The directories are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Directory</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">certificates/</span></tt></td>
<td>Stores SSL certificates that are generated by the <tt class="docutils literal"><span class="pre">rake</span> <span class="pre">ssl_cert</span></tt> command.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">.chef/</span></tt></td>
<td>A hidden directory that stores .pem files and the knife.rb file.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">config/</span></tt></td>
<td>Contains the Rake configuration file: <tt class="docutils literal"><span class="pre">rake.rb</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">cookbooks/</span></tt></td>
<td>Contains cookbooks that have been downloaded from the cookbooks.opscode.com or created locally.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">data_bags/</span></tt></td>
<td>Stores data bags (and data bag items) in JSON (.json).</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">environments/</span></tt></td>
<td>Stores environment in Ruby (.rb) or JSON (.json).</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">roles/</span></tt></td>
<td>Stores roles in Ruby (.rb) or JSON (.json).</td>
</tr>
</tbody>
</table>
<div class="section" id="h4-certificates-done">
<h5>H4 &#8211; certificates/ &#8211; DONE<a class="headerlink" href="#h4-certificates-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">certificates/</span></tt> directory is used to store the SSL certificates that are generated by the Rake task <tt class="docutils literal"><span class="pre">ssl_cert</span></tt>. The values that are used in the SSL certificates can be modified in the config/rake.rb file.</p>
<p>To generate a certificate for a monitoring server:</p>
<ol class="arabic">
<li><p class="first">Run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rake ssl_cert <span class="nv">FQDN</span><span class="o">=</span>monitoring.example.com
</pre></div>
</div>
</li>
<li><p class="first">Once the certificates are generated, copy them into each cookbook that will use them. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>cp certificates/monitoring.example.com* cookbooks/COOKBOOK_NAME/files/default
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">COOKBOOK_NAME</span></tt> is the name of the cookbook that will use the certificate.</p>
</li>
<li><p class="first">And then in the recipe for each cookbook, create a <tt class="docutils literal"><span class="pre">cookbook_file</span></tt> resource to configure a resource that puts them in-place on the destination server:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">cookbook_file</span> <span class="s1">&#39;/etc/apache2/ssl/monitoring.example.com.pem&#39;</span>
  <span class="nx">owner</span> <span class="s1">&#39;root&#39;</span>
  <span class="nx">group</span> <span class="s1">&#39;root&#39;</span>
  <span class="nx">mode</span> <span class="mi">0600</span>
<span class="nx">end</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="h4-chef-done">
<h5>H4 &#8211; .chef/ &#8211; DONE<a class="headerlink" href="#h4-chef-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">.chef/</span></tt> directory is a hidden directory that is used to store .pem validation that are provided by the Chef server and a knife.rb file. These files are required for interaction with a Chef server.</p>
</div>
<div class="section" id="h4-config-done">
<h5>H4 &#8211; config/ &#8211; DONE<a class="headerlink" href="#h4-config-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">config/</span></tt> directory is used to store the <tt class="docutils literal"><span class="pre">rake.rb</span></tt> file, which is the configuration file for Rake. Rake is a Ruby application (and a third-party build management tool) that is used by Chef to help manage the installation of various components, including Chef itself, cookbooks, and so on.</p>
<p>The Chef repository uses two configuration files: <tt class="docutils literal"><span class="pre">rake.rb</span></tt> (required) and <tt class="docutils literal"><span class="pre">knife.rb</span></tt> (optional):</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">File</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>knife.rb</td>
<td>A knife.rb file is used to store repository-specific configuration details for Knife. If a knife.rb file is present in the .chef/knife.rb directory in the Chef repository, the settings contained within that file will override the Knife configuration settings contained within the knife.rb file found at ~/.chef/knife.rb. A knife.rb file does not need to be in the Chef repository if the primary knife.rb file contains the correct settings.</td>
</tr>
<tr class="row-odd"><td>rake.rb</td>
<td><p class="first">The rake.rb file is used to store the configuration details used by Rake, which is a third-party build management tool that is used by Chef to help manage the installation of various components. The config/rake.rb file is also used to generate SSL certificates based on the configuration settings for SSL certificates and the Rake task <tt class="docutils literal"><span class="pre">ssl_cert</span></tt>.</p>
<p>Rake includes tasks that are installed with the Chef libraries. To view the tasks that are available, run <tt class="docutils literal"><span class="pre">rake</span> <span class="pre">-T</span></tt>. For more information about Rake, see <a class="reference external" href="http://en.wikipedia.org/wiki/Rake_(software">http://en.wikipedia.org/wiki/Rake_(software</a>).</p>
<p>The following Rake commands are not replaced by Knife sub-commands:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">bundle_cookbook</span></tt></td>
<td>Creates cookbook tar.gz files in the pkgs/ directory.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">install</span></tt></td>
<td>Calls the following Rake commands: <tt class="docutils literal"><span class="pre">update</span></tt>, <tt class="docutils literal"><span class="pre">roles</span></tt>, and <tt class="docutils literal"><span class="pre">upload_cookbooks</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">ssl_cert</span></tt></td>
<td>Creates self-signed SSL certificates in the <tt class="docutils literal"><span class="pre">certificates/</span></tt> directory.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">update</span></tt></td>
<td>Updates the repository from version control server; understands git and Subversion.</td>
</tr>
</tbody>
</table>
<p>The following Rake commands duplicate functionality in Chef and may be removed from future updates to the Chef libraries:</p>
<table border="1" class="last docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Command</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">metadata</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">metadata</span> <span class="pre">-a</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">new_cookbook</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">create</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">role</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">role</span> <span class="pre">from</span> <span class="pre">file</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">roles</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">role</span> <span class="pre">from</span> <span class="pre">file</span></tt>; iterates over roles and then uploads them.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">test_cookbooks</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">test</span> <span class="pre">-a</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">test_cookbook</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">test</span> <span class="pre">COOKBOOK_NAME</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">upload_cookbooks</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">upload</span> <span class="pre">-a</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">upload_cookbook</span></tt></td>
<td>Replaced by: <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">upload</span> <span class="pre">COOKBOOK_NAME</span></tt>.</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-cookbooks-done-this-is-the-cookbook-cache">
<h5>H4 &#8211; cookbooks/ &#8211; DONE &#8211; THIS IS THE COOKBOOK CACHE!<a class="headerlink" href="#h4-cookbooks-done-this-is-the-cookbook-cache" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">cookbooks/</span></tt> directory is used to store the cookbooks that are used by Chef when configuring the various systems in the organization. This directory contains the cookbooks that are used to configure systems in the infrastructure with Chef. Each cookbook can be configured to contain cookbook-specific copyright, email, and license data.</p>
<p>To configure cookbook-specific copyright, email, and license data, add the following to the knife.rb file in the Chef repository:</p>
<div class="highlight-bash"><div class="highlight"><pre>cookbook_copyright <span class="s2">&quot;Example, Com.&quot;</span>
cookbook_email     <span class="s2">&quot;cookbooks@example.com&quot;</span>
cookbook_license   <span class="s2">&quot;apachev2&quot;</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">cookbook_copyright</span></tt> and <tt class="docutils literal"><span class="pre">cookbook_email</span></tt> are specific to the organization and <tt class="docutils literal"><span class="pre">cookbook_license</span></tt> is either <tt class="docutils literal"><span class="pre">apachev2</span></tt> or <tt class="docutils literal"><span class="pre">none</span></tt>. These settings will be used in the default recipe and in corresponding values in the metadata.rb file, but can be modified in those locations as well (if they should be different from the default values contained in the knife.rb file.)</p>
<p>To create a cookbook (including all default components), run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook create COOKBOOK_NAME
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">COOKBOOK_NAME</span></tt> is the name of the cookbook that will be created. Any un-needed directory components can be left unused or deleted, if preferred.</p>
<p>To download a cookbook when git is used for version source control, run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook site install COOKBOOK_NAME
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">COOKBOOK_NAME</span></tt> is the name of a cookbook on cookbooks.opscode.com. This will start a process that:</p>
<blockquote>
<div><ul class="simple">
<li>downloads the cookbook from cookbooks.opscode.com as a tar.gz archive</li>
<li>ensures that its using the git master branch, and then checks out the cookbook from a vendor branch (creating a new vendor branch, if required)</li>
<li>removes the old (existing) version</li>
<li>expands the tar.gz archive and adds the expanded files to the git index and commits</li>
<li>creates a tag for the version that was downloaded</li>
<li>checks out the master branch</li>
<li>merges the cookbook into the master (to ensure that any local changes or modifications are preserved)</li>
</ul>
</div></blockquote>
<p>To download a cookbook when git is not used for version source controlrun the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook site download COOKBOOK_NAME
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">COOKBOOK_NAME</span></tt> is the name of a cookbook on cookbooks.opscode.com. This will download the tar.gz file associated with the cookbook and will create a file named COOKBOOK_NAME.tar.gz in the current directory (e.g., ~/chef-repo). Once downloaded, using a version source control system is recommended.</p>
<p><strong>jamescott: BELOW IS THE COOKBOOK CACHED DESCRIPTION. COMPARE THIS BELOW TO WHAT IS ABOVE AND INTEGRATE, REWRITE, MAKE NECESSARY CHANGES</strong></p>
<p>../../includes/includes_chef_node_cookbook_cached.rst</p>
<p><strong>jamescott: We need to say something about the fact that the cookbooks are uploaded to the Chef server and are then (from there) propagated across nodes when and where required (and cached on each of the nodes, refreshed as required).</strong></p>
</div>
<div class="section" id="h4-data-bags-done">
<h5>H4 &#8211; data_bags/ &#8211; DONE<a class="headerlink" href="#h4-data-bags-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">data_bags/</span></tt> directory is used to store all of the data bags that exist for a Chef organization. Each sub-directory corresponds to a single data bag on the Chef server and contains a JSON file for each data bag item. If a sub-directory does not exist, then create it using SSL commands. After a data bag item is created, it can then be uploaded to the Chef server.</p>
<p>To create a data bag sub-directory:</p>
<ol class="arabic">
<li><p class="first">Enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir data_bags/NAME_OF_DATA_BAG
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">NAME_OF_DATA_BAG</span></tt> is the name of the data bag to be created.</p>
</li>
<li><p class="first">Create the JSON files for each data bag item. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>data_bags/NAME_OF_DATA_BAG/NAME_OF_DATA_BAG_ITEM.json
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">NAME_OF_DATA_BAG_ITEM</span></tt> is the name of the data bag item, repeating for each data bag item as required.</p>
</li>
<li><p class="first">Add information to each data bag item. The JSON format is similar to the following:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;foo&quot;</span>
  <span class="s2">&quot;name_of_attribute&quot;</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">id</span></tt> is required (the name of the data bag item) and <tt class="docutils literal"><span class="pre">name_of_attribute</span></tt> is an attribute unique to this data bag item. <tt class="docutils literal"><span class="pre">foo</span></tt> and <tt class="docutils literal"><span class="pre">bar</span></tt> are attribute values. More than one attribute can be added to a data bag item (though, typically, they have as few attributes as possible).</p>
</li>
</ol>
<p>To upload a data bag item to the Chef server:</p>
<ol class="arabic">
<li><p class="first">Create the data bag on the Chef server. Enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create NAME_OF_DATA_BAG
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">NAME_OF_DATA_BAG</span></tt> is the name of the data bag to be created.</p>
</li>
<li><p class="first">Upload the data bag item from a local directory. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file NAME_OF_DATA_BAG NAME_OF_DATA_BAG_ITEM.json
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">NAME_OF_DATA_BAG_ITEM</span></tt> is the name of the data bag item to be uploaded. Repeat for each data bag item that needs to be uploaded.</p>
</li>
</ol>
</div>
<div class="section" id="h4-environments-done">
<h5>H4 &#8211; environments/ &#8211; DONE<a class="headerlink" href="#h4-environments-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">environments/</span></tt> directory is used to store the files that define the environments that are available to the Chef server. The environments files can be Ruby DSL files (.rb) or they can be JSON files (.json). Use Knife to install environments files to the Chef server.</p>
<p>To upload an environment to the Chef server:</p>
<ol class="arabic">
<li><p class="first">Verify the environment data:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">xxxxx</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife environment from file environment/environment.rb
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">environment</span></tt> is the name of the file that will be uploaded.</p>
</li>
</ol>
</div>
<div class="section" id="h4-roles-done">
<h5>H4 &#8211; roles/ &#8211; DONE<a class="headerlink" href="#h4-roles-done" title="Permalink to this headline">¶</a></h5>
<p>The <tt class="docutils literal"><span class="pre">roles/</span></tt> directory is used to store the files that define the roles that are available to the Chef server. The roles files can be Ruby DSL files (.rb) or they can be JSON files (.json). Use Knife to install role files to the Chef server.</p>
<p>To upload a role to the Chef server:</p>
<ol class="arabic">
<li><p class="first">Verify the role data:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">name</span> <span class="s2">&quot;base_example&quot;</span>
   <span class="n">description</span> <span class="s2">&quot;Example base role applied to all nodes.&quot;</span>
   <span class="c1"># List of recipes and roles to apply.</span>
   <span class="c1">#run_list()</span>
   <span class="c1"># Attributes applied if the node doesn&#39;t have it set already.</span>
   <span class="c1">#default_attributes()</span>
   <span class="c1"># Attributes applied no matter what the node has set already.</span>
   <span class="c1">#override_attributes()</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife role from file roles/base_example.rb
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">base_example</span></tt> is the name of the file that will be uploaded.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="h3-create-the-chef-repository-done">
<h4>H3 &#8211; Create the Chef Repository &#8211; DONE<a class="headerlink" href="#h3-create-the-chef-repository-done" title="Permalink to this headline">¶</a></h4>
<p>There are two ways to create a Chef repository:</p>
<ul class="simple">
<li>Clone the Opscode repository for Chef from github</li>
<li>Download the repository as a tar.gz file and place it into local version source control.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Opscode strongly recommends using some type of version control tool to manage the source code in the Chef repository. We use git for everything, including for cookbooks. If another version source control system is preferred over git (such as Subversion, Mercurial, or Bazaar) that is just fine.</p>
</div>
<div class="section" id="h4-clone-done">
<h5>H4 &#8211; Clone &#8211; DONE<a class="headerlink" href="#h4-clone-done" title="Permalink to this headline">¶</a></h5>
<p>The Chef repository is available on github: <a class="reference external" href="https://github.com/opscode/chef-repo">https://github.com/opscode/chef-repo</a>.</p>
<p>To clone the Chef repository from github:</p>
<ol class="arabic">
<li><p class="first">Download and install git.</p>
</li>
<li><p class="first">Run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git clone git://github.com/opscode/chef-repo.git
</pre></div>
</div>
</li>
<li><p class="first">(Optional) After the repository is cloned, the history of that repository can be wiped out be removing the &#8221;.git&#8221; directory, which allows the initialization of a new repository or to move the Chef repository into another version source control system, such as Subversion, Mercurial, or Bazaar.</p>
</li>
</ol>
</div>
<div class="section" id="h4-download-done">
<h5>H4 &#8211; Download &#8211; DONE<a class="headerlink" href="#h4-download-done" title="Permalink to this headline">¶</a></h5>
<p>Instead of cloning the Chef repository from github, a tar.gz file can be downloaded from github directly (<a class="reference external" href="http://github.com/opscode/chef-repo/tarball/master">http://github.com/opscode/chef-repo/tarball/master</a>) or through the command shell using GNU Wget (or a similar application).</p>
<p>To download the Chef repository:</p>
<ol class="arabic">
<li><p class="first">Run the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>wget http://github.com/opscode/chef-repo/tarball/master
</pre></div>
</div>
</li>
<li><p class="first">Extract the tar.gz file into a directory. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>tar -zxf master
</pre></div>
</div>
</li>
<li><p class="first">Move the extracted file to the Chef repository. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mv opscode-chef-repo-a3bec38 chef-repo
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="h2-knife-done">
<h3>H2 &#8211; Knife &#8211; DONE<a class="headerlink" href="#h2-knife-done" title="Permalink to this headline">¶</a></h3>
<p>Knife is a command-line tool that provides an interface between a local Chef repository and the Chef server. Knife helps users of Chef to manage:</p>
<ul class="simple">
<li>Nodes</li>
<li>Cookbooks and recipes</li>
<li>Roles</li>
<li>Stores of JSON data (data bags), including encrypted data</li>
<li>Environments</li>
<li>Cloud resources, including provisioning</li>
<li>The installation of Chef on management workstations</li>
<li>Searching of indexed data on the Chef server</li>
</ul>
<div class="section" id="h3-sub-commands-done">
<h4>H3 &#8211; Sub-commands &#8211; DONE<a class="headerlink" href="#h3-sub-commands-done" title="Permalink to this headline">¶</a></h4>
<p>Opscode provides the following plug-ins for Knife, which work in much the same way as the built-in sub-commands (including common options). Each plug-in must be downloaded separately from github and only works with a specific third-party environment:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">azure</span></tt> for Windows Azure</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">bluebox</span></tt> for Blue Box</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">ec2</span></tt> for Amazon EC2</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">eucalyptus</span></tt> for Eucalyptus</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">google</span></tt> for Google Compute Engine</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">hp</span></tt> for HP Cloud Compute</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">linode</span></tt> for Linode</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">openstack</span></tt> for OpenStack</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">rackspace</span></tt> for Rackspace</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">terremark</span></tt> for Terremark</li>
<li><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">windows</span></tt> for Microsoft Windows desktops and servers using Windows Remote Management</li>
</ul>
</div>
<div class="section" id="h3-plugins-done">
<h4>H3 &#8211; Plugins &#8211; DONE<a class="headerlink" href="#h3-plugins-done" title="Permalink to this headline">¶</a></h4>
<p>The workstation is a computer that is configured to run Knife, synchronize with the Chef repository, and to interact with a single Chef server. All of the most important details needed by Chef&#8212;cookbooks and recipes, role and environment data, important settings&#8212;are stored in the Chef repository using version source control. The workstation is the location from which most users of Chef will do most of their work, including:</p>
<ul class="simple">
<li>Developing cookbooks and recipes (and authoring them using Ruby)</li>
<li>Keeping the Chef repository synchronized with version source control</li>
<li>Using Knife to upload items from the Chef repository to the Chef server</li>
<li>Configuring organizational policy, including defining roles and environments and ensuring that critical data is stored in data bags</li>
<li>Interacting with nodes, as (or when) required, such as performing a bootstrap operation</li>
</ul>
</div>
</div>
<div class="section" id="h2-ruby-done">
<h3>H2 &#8211; Ruby &#8211; DONE<a class="headerlink" href="#h2-ruby-done" title="Permalink to this headline">¶</a></h3>
<p>Ruby is a simple programming language that is designed to be easy to read and to behave in a predictable manner. Chef uses Ruby as its reference language for creating cookbooks and defining recipes, with an extended domain-specific language that is used for specific resources. Chef provides a reasonable set of resources, enough to support many of the most common infrastructure automation scenarios; however, this DSL can also be extended when additional resources and capabilities are required.</p>
<p>Chef uses a domain-specific language in Ruby to define recipes and to store settings, such as those which define a role or an environment. These settings are saved as Ruby files and are stored in the Chef repository. When these files are uploaded to the Chef server, they are converted to JSON. Each time the Chef repository is refreshed, the contents of all domain-specific Ruby files are re-compiled to JSON and are re-uploaded to the Chef server.</p>
<div class="section" id="h3-just-enough-ruby-for-chef-done">
<h4>H3 &#8211; Just Enough Ruby for Chef &#8211; DONE<a class="headerlink" href="#h3-just-enough-ruby-for-chef-done" title="Permalink to this headline">¶</a></h4>
<p>Many people who are new to Ruby often find that it doesn&#8217;t take very long to get up to speed with the basics. For example, it&#8217;s useful to know how to check the syntax of a Ruby file, such as the contents of a cookbook named &#8220;my_cookbook.rb&#8221;:</p>
<div class="highlight-python"><pre>$ ruby -c my_cookbook_file.rb</pre>
</div>
<p>to return:</p>
<div class="highlight-python"><pre>Syntax OK</pre>
</div>
<p>Here is a quick rundown of some basic Ruby commands.:</p>
<div class="highlight-python"><pre># anything after # is a comment.

# assigning a local variable:
x = 1

# some basic arithmetic:
1 + 2           # =&gt; 3
2 * 7           # =&gt; 14
5 / 2           # =&gt; 2   (because both arguments are whole numbers)
5 / 2.0         # =&gt; 2.5 (because one of the numbers had a decimal place)
1 + (2 * 3)     # =&gt; 7   (you can use parens to group expressions)

# strings
'single quoted' # =&gt; "single quoted"
"double quoted" # =&gt; "double quoted"
'It\'s alive'   # =&gt; "It's alive!"
"1 + 2 = 5"     # =&gt; "1 + 2 = 5" (numbers surrounded by quotes may exhibit string-like behavior)

# a string with embedded ruby
x = "Bob"
"Hi, #{x}"      # =&gt; "Hi, Bob"
'Hello, #{x}'   # =&gt; "Hello, \#{x}" Notice that single quotes don't work with #{}

# some basic truths
true            # =&gt; true
false           # =&gt; false
nil             # =&gt; nil
1 == 1          # =&gt; true ( == tests for equality )
1 == true       # =&gt; false ( == tests for equality )

# ! means not
!true           # =&gt; false
!false          # =&gt; true
!nil            # =&gt; true
1 != 2          # =&gt; true (1 is not equal to 2)
1 != 1          # =&gt; false (1 is not not equal to itself)

# !! (not not) converts something to either true or false
!!true          # =&gt; true
!!false         # =&gt; false
!!nil           # =&gt; false (when pressed, nil is false)
!!0             # =&gt; true (zero is NOT false).

# arrays are lists
x = ["a", "b", "c"] # =&gt; ["a", "b", "c"]
x[0]                # =&gt; "a" (zero is the first index)
x.first             # =&gt; "a" (see?)
x.last              # =&gt; "c"
x + ["d"]           # =&gt; ["a", "b", "c", "d"]
x                   # =&gt; ["a", "b", "c"] ( x is unchanged)
x = x + ["d"]       # =&gt; ["a", "b", "c", "d"]
x                   # =&gt; ["a", "b", "c", "d"]

# a hash is a list with keys and values
# - but no set order (!)
h = {
"first_name" =&gt; "Bob",
"last_name"  =&gt; "Jones"
}
# =&gt; { "first_name =&gt; "Bob", "last_name" =&gt; "Jones" }
h.keys              # =&gt; ["first_name", "last_name"]
h["first_name"]     # =&gt; "Bob"
h["last_name"]      # =&gt; "Jones"
h["age"] = 23
h.keys              # =&gt; ["first_name", "age", "last_name"]
h.values            # =&gt; ["Jones", "Bob", 23]

# perl-style regular expressions
"I believe"  =~ /I/                       # =&gt; 0 (matches at the first character)
"I believe"  =~ /lie/                     # =&gt; 4 (matches at the 5th character)
"I am human" =~ /bacon/                   # =&gt; nil (no match - bacon comes from pigs)
"I am human" !~ /bacon/                   # =&gt; true (correct, no bacon here)
/give me a ([0-9]+)/ =~ "give me a 7"     # =&gt; 0 (matched)

# you can do things conditionally

# with an if statement
if false
  # this won't happen
elsif nil
  # this won't either
else
  # code here will run though
end

# or a case statement
x = "dog"
case x
when "fish"
 # this won't happen
when "dog", "cat", "monkey"
  # this will run
else
  # the else is an optional catch-all
end

# def defines a method (functions, if you like)

def do_something_useless( first_argument, second_argument)
  puts "You gave me #{first_argument} and #{second_argument}"
end

do_something_useless( "apple", "banana")
# =&gt; "You gave me apple and banana"
do_something_useless 1, 2
# =&gt; "You gave me 1 and 2"
# see how the parens are optional if there's no confusion about what to do

# call a method on something with .method_name()
x = "My String"
x.split(" ")            # =&gt; ["My", "String"]
x.split(" ").join(", ") # =&gt; "My, String"</pre>
</div>
<p>In addition, see the following:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.ruby-lang.org/en/documentation/">http://www.ruby-lang.org/en/documentation/</a></li>
<li><a class="reference external" href="http://blog.loftninjas.org/2011/02/16/the-power-of-chef-and-ruby/">http://blog.loftninjas.org/2011/02/16/the-power-of-chef-and-ruby/</a></li>
<li><a class="reference external" href="http://mislav.uniqpath.com/poignant-guide/">http://mislav.uniqpath.com/poignant-guide/</a></li>
<li><a class="reference external" href="http://www.rubycentral.com/book/">http://www.rubycentral.com/book/</a></li>
<li><a class="reference external" href="http://www.ruby-doc.org/stdlib/">http://www.ruby-doc.org/stdlib/</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="h1-the-chef-server">
<h2>H1 &#8211; The Chef Server<a class="headerlink" href="#h1-the-chef-server" title="Permalink to this headline">¶</a></h2>
<p>The Chef server acts as a hub, ensuring that the right cookbooks are used, that the right policies are being applied, that all of the node objects are up-to-date, and that all of the nodes that will be maintained are registered and known to the Chef server. The Chef server distributes configuration details (such as recipes, templates, and file distributions) to every node within the organization. Chef then does as much of the configuration work as possible on the nodes themselves (and not on the Chef server). This scalable approach distributes the configuration effort throughout the organization.</p>
<p>There are three types of Chef servers:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Feature</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><img alt="_images/icon_chef_hosted.png" class="first last" src="_images/icon_chef_hosted.png" />
</td>
<td><p class="first">Hosted Chef is a version of a Chef server that is cloud-based, scalable, and available (24x7/365), with resource-based access control and all of the automation capabilities of Chef, but without requiring it to be set up and managed within the organization.</p>
<p class="last">Hosted Chef evolved out of a need for an infrastructure management tool to be built around the notion of API primitives. By using an API to talk to a cloud provider (such as Amazon Virtual Private Cloud, Windows Azure, or Rackspace), it allows the freedom to think of those primitives as building blocks. Hosted Chef evolved out of this idea. Chef only needs to know about the desired state, how it should get there, and what the proper functionality of that desired state should be.</p>
</td>
</tr>
<tr class="row-odd"><td><img alt="_images/icon_chef_private.png" class="first last" src="_images/icon_chef_private.png" />
</td>
<td><p class="first">Private Chef is a version of a Chef server that is designed to provide all of the infrastructure automation capabilities of Chef, set up and managed from within the organization.</p>
<p class="last">Private Chef evolved out of a need for customers to have the same functionality provided by Hosted Chef, but located within the organization&#8217;s firewall. Private Chef is the same as Hosted Chef. Hosted Chef is the largest Private Chef deployment in the world.</p>
</td>
</tr>
<tr class="row-even"><td>NEED IMAGE FOR CHEF OPEN SERVER</td>
<td><p class="first">Open Source Chef Server is xxxxx.</p>
<ul class="simple">
<li>xxxxx</li>
<li>xxxxx</li>
</ul>
<p class="last">Open Source Chef Server is an open source version of the Chef server that contains much of the same functionality as either Hosted Chef or Private Chef, but does not include support directly from Opscode. <strong>jamescott: AND?????</strong></p>
</td>
</tr>
</tbody>
</table>
<div class="section" id="h2-policy">
<h3>H2 &#8211; Policy<a class="headerlink" href="#h2-policy" title="Permalink to this headline">¶</a></h3>
<p>MAYBE JUST PUT THIS IN THE INTRO SECTION OF THE CHEF SERVER? ENVIRONMENTS, DATA BAGS, AND ROLES DON&#8217;T HAVE TO BE A SUBSET OF A HEADER NAMED POLICY TO HAVE AN EFFECTIVE SET OF TOPICS ABOUT. PARAGRAPH INCLUDED FOR NOW.</p>
<p>Policy settings can be used to map the capabilities of Chef to organizational requirements. For example, custom environments can be mapped to an organization&#8217;s actual processes and workflow. Roles define server types, such as &#8220;web server&#8221; or &#8220;database server&#8221;. Certain types of data, such as passwords, user account data, and other sensitive items can be placed in data bags, which are located in a secure sub-area of Chef that can only be accessed by nodes that have the correct SSL certificates.</p>
</div>
<div class="section" id="h2-environments-done">
<h3>H2 &#8211; Environments &#8211; DONE<a class="headerlink" href="#h2-environments-done" title="Permalink to this headline">¶</a></h3>
<p>An environment is a way to map an organization&#8217;s real-life workflow to what can be configured and managed when using Chef server. Every Chef organization begins with a single environment called the <tt class="docutils literal"><span class="pre">_default</span></tt> environment, which cannot be modified (or deleted). Additional environments can be created, such as production, staging, testing, and development. Generally, an environment is also associated with one (or more) cookbook versions.</p>
<div class="section" id="h3-the-default-environment-done">
<h4>H3 &#8211; The _default Environment &#8211; DONE<a class="headerlink" href="#h3-the-default-environment-done" title="Permalink to this headline">¶</a></h4>
<p>Every Chef organization must have at least one environment. Every Chef organization starts out with a single environment that is named <tt class="docutils literal"><span class="pre">_default</span></tt>, which ensures that an environment is always available to the Chef server. The <tt class="docutils literal"><span class="pre">_default</span></tt> environment cannot be modified in any way. Nodes, roles, run-lists, cookbooks (and cookbook versions), and attributes specific to an organization can only be associated with a custom environment.</p>
<p><strong>jamescott: is it true that the _default environment cannot be modified? But that things like nodes and stuff can be added to them? It would make sense that nodes and stuff could be associated with the _default environment; it&#8217;s custom environment settings that are required for a new environment.</strong></p>
</div>
<div class="section" id="h3-environment-formats-done">
<h4>H3 &#8211; Environment Formats &#8211; DONE<a class="headerlink" href="#h3-environment-formats-done" title="Permalink to this headline">¶</a></h4>
<p>Environment data is stored in two formats: as domain-specific language in Ruby and as JSON data.</p>
<div class="section" id="h4-ruby-dsl-done">
<h5>H4 &#8211; Ruby DSL &#8211; DONE<a class="headerlink" href="#h4-ruby-dsl-done" title="Permalink to this headline">¶</a></h5>
<p>Chef uses a domain-specific language in Ruby to define recipes and to store settings, such as those which define a role or an environment. These settings are saved as Ruby files and are stored in the Chef repository. When these files are uploaded to the Chef server, they are converted to JSON. Each time the Chef repository is refreshed, the contents of all domain-specific Ruby files are re-compiled to JSON and are re-uploaded to the Chef server.</p>
<p>Domain-specific Ruby attributes for environments include the following:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">cookbook</span></tt></td>
<td><p class="first">A version constraint for a single cookbook. For example:</p>
<div class="highlight-python"><pre>cookbook "couchdb", "&lt; 11.0.0"</pre>
</div>
<p>Or:</p>
<div class="highlight-python"><pre>cookbook "my_rails_app", "&lt; 1.2.0"</pre>
</div>
<p>Or:</p>
<div class="last highlight-python"><pre>cookbook "gems", "&lt; 1.4.0"</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">cookbook_versions</span></tt></td>
<td><p class="first">A version constraint for a group of cookbooks. For example:</p>
<div class="last highlight-python"><pre>cookbook_versions({
  "couchdb"=&gt;"= 11.0.0",
  "my_rails_app"=&gt;"~&gt; 1.2.0"
})</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default_attributes</span></tt></td>
<td><p class="first">Optional. A set of attributes that should be applied to all nodes, assuming the node does not already have a value for the attribute. This is useful for setting global defaults that can then be overridden for specific nodes. If more than one role attempts to set a default value for the same attribute, the last role applied will win. When nested attributes are present, they will be preserved. For example, to specify that a node that has the attribute <tt class="docutils literal"><span class="pre">apache2</span></tt> should listen on ports 80 and 443 (unless ports are already specified):</p>
<div class="last highlight-python"><pre>default_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "80", "443" ] }</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">description</span></tt></td>
<td><p class="first">A description of the functionality that is covered. For example:</p>
<div class="last highlight-python"><pre>description 'The development environment'</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">env_run_lists</span></tt></td>
<td><p class="first">Optional. A list of environments, each specifying a recipe or a role that will be applied to that environment. Each environment in the list may only have a single recipe or role assigned to it. This setting must specify the <tt class="docutils literal"><span class="pre">_default</span></tt> environment. If the <tt class="docutils literal"><span class="pre">_default</span></tt> environment is set to <tt class="docutils literal"><span class="pre">[]</span></tt> or <tt class="docutils literal"><span class="pre">nil</span></tt> then the run list will be empty. <strong>jamescott: SEE CHEF-2636.</strong> For example:</p>
<div class="last highlight-python"><pre>env_run_lists "prod" =&gt; ["recipe[apache2]"],
                         "staging" =&gt; ["recipe[apache2::staging]"],
                         "_default" =&gt; []</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">name</span></tt></td>
<td><p class="first">A unique name within the Chef organization. Each name must be unique and must be made up of letters (upper- and lower-case), numbers, underscores, and hyphens: [A-Z][a-z][0-9] and [_-]. Spaces are not allowed. For example:</p>
<div class="last highlight-python"><pre>name 'dev01-24'</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override_attributes</span></tt></td>
<td><p class="first">Optional. A set of attributes that should be applied to all nodes, even if the node already has a value for an attribute. This is useful for ensuring that certain attributes always have specific values. If more than one role attempts to set an override value for the same attribute, the last role applied will win. When nested attributes are present, they will be preserved. For example:</p>
<div class="highlight-python"><pre>override_attributes "apache2" =&gt; { "max_children" =&gt; "50" }</pre>
</div>
<p>The parameters in a Ruby file are actually Ruby method calls, so parentheses can be used to provide clarity when specifying numerous or deeply-nested attributes. For example:</p>
<div class="highlight-python"><pre>override_attributes(
  :apache2 =&gt; {
    :prefork =&gt; { :min_spareservers =&gt; "5" }
  }
)</pre>
</div>
<p>Or:</p>
<div class="last highlight-python"><pre>override_attributes(
  :apache2 =&gt; {
    :prefork =&gt; { :min_spareservers =&gt; "5" }
  },
  :tomcat =&gt; {
    :worker_threads =&gt; "100"
  }
)</pre>
</div>
</td>
</tr>
</tbody>
</table>
<p>A Ruby file for each non-default environment must exist in the (jamescott: PATH) environments subdirectory of the Chef repository. (If the repository does not have this subdirectory, then create it.) Each Ruby file should have the .rb suffix. The complete environment Ruby has the following syntax:</p>
<div class="highlight-python"><pre>name "environment_name"
description "environment_description"
cookbook OR cookbook_versions  "cookbook" OR "cookbook" =&gt; "cookbook_version"
default_attributes "node" =&gt; { "attribute" =&gt; [ "value", "value", "etc." ] }
override_attributes "node" =&gt; { "attribute" =&gt; [ "value", "value", "etc." ] }</pre>
</div>
<p>where both default and override attributes are optional and either a cookbook or cookbook versions (one or more) are specified. For example, an environment named &#8220;dev&#8221; that uses the &#8220;couchdb&#8221; cookbook (version 11.0.0 or higher) that listens on ports 80 and 443:</p>
<div class="highlight-python"><pre>name "dev"
description "The development environment"
cookbook_versions  "couchdb" =&gt; "11.0.0"
default_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "80", "443" ] }</pre>
</div>
<p>Or (using the same scenario) to specify a version constraint for only one cookbook:</p>
<div class="highlight-python"><pre>cookbook "couchdb", "= 11.0.0"</pre>
</div>
<p>More than one cookbook version can be specified:</p>
<div class="highlight-python"><pre>cookbook_versions({
  "couchdb"=&gt;"= 11.0.0",
  "my_rails_app"=&gt;"~&gt; 1.2.0"
})</pre>
</div>
<p>Attributes are optional and can be set at the default and override levels. These will be processed according to attribute precedence. An environment attribute will be applied to all nodes within the environment, except in places where it is overridden by an attribute with higher precedence. For example:</p>
<div class="highlight-python"><pre>default_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "80", "443" ] }</pre>
</div>
<p>will have all nodes in the environment (<tt class="docutils literal"><span class="pre">node[:apache2][:listen_ports]</span></tt>) set to &#8220;80&#8221; and &#8220;443&#8221; unless they were overridden by an attribute with higher precedence. For example:</p>
<div class="highlight-python"><pre>override_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "99", "999" ] }</pre>
</div>
</div>
<div class="section" id="h4-json-done">
<h5>H4 &#8211; JSON &#8211; DONE<a class="headerlink" href="#h4-json-done" title="Permalink to this headline">¶</a></h5>
<p>The JSON format for environments maps directly to the domain-specific Ruby format: the same settings, attributes, and values, and a similar structure and organization. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
  <span class="s">&quot;default_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;apache2&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;listen_ports&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">&quot;80&quot;</span><span class="p">,</span>
        <span class="s">&quot;443&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;json_class&quot;</span><span class="p">:</span> <span class="s">&quot;Chef::Environment&quot;</span><span class="p">,</span>
  <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
   <span class="s">&quot;cookbook_versions&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;couchdb&quot;</span><span class="p">:</span> <span class="s">&quot;11.0.0&quot;</span>
  <span class="p">},</span>
  <span class="s">&quot;chef_type&quot;</span><span class="p">:</span> <span class="s">&quot;environment&quot;</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>The JSON format has two additional settings:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">chef_type</span></tt></td>
<td>This should always be set to <tt class="docutils literal"><span class="pre">environment</span></tt>. Use this setting for any custom process that consumes environment objects outside of Ruby.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">json_class</span></tt></td>
<td>This should always be set to <tt class="docutils literal"><span class="pre">Chef::Environment</span></tt>. This setting is used internally by Chef to auto-inflate an environment object. If objects are being rebuilt outside of Ruby, ignore it.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="h3-environment-attributes-done">
<h4>H3 &#8211; Environment Attributes &#8211; DONE<a class="headerlink" href="#h3-environment-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>An attribute can be defined in an environment and then used to override the default settings on a node. When an environment is applied during a Chef run, these attributes are compared to the attributes that are already present on the node. When the environment attributes take precedence over the default attributes, Chef will apply those new settings and values during the Chef run on the node.</p>
<p>An environment attribute can only be set to be a default attribute or an override attribute. An environment attribute cannot be set to be a normal attribute. Use the <tt class="docutils literal"><span class="pre">default_attribute</span></tt> and <tt class="docutils literal"><span class="pre">override_attribute</span></tt> methods in the Ruby DSL file or the <tt class="docutils literal"><span class="pre">default_attributes</span></tt> and <tt class="docutils literal"><span class="pre">override_attributes</span></tt> hashes in a JSON data file.</p>
<div class="section" id="h4-types-done">
<h5>H4 &#8211; Types &#8211; DONE<a class="headerlink" href="#h4-types-done" title="Permalink to this headline">¶</a></h5>
<p>There are four types of attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default</span></tt></td>
<td>A default attribute is <strong>jamescott: &#8220;A default attribute is what?&#8221; (other than the obvious) &#8211; but what&#8217;s the difference between default an normal and how does an attribute become a &#8220;default attribute&#8221;?</strong>. A default attribute has the lowest attribute precedence. A default attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses default attributes whenever possible.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">normal</span></tt></td>
<td>A normal attribute is an attribute that persists on the target system . A normal attribute is never reset during a Chef run. A normal attribute has a higher attribute precedence than a default attribute.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override</span></tt></td>
<td>An override attribute is an attribute that is specified in a recipe (or a run-list) and are often set only for specific roles or nodes. An override attribute has a higher attribute precedence than default or normal attributes. An override attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses override attributes for role-specific or node-specific values when required.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">automatic</span></tt></td>
<td>An automatic attribute contains data that is automatically-generated by Ohai during every Chef run (all previous values are overwritten by the newly-generated values). An automatic attribute cannot be modified. An automatic attribute has the highest attribute precedence. An automatic attribute is automatically reset each time Chef runs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-precedence-vs-priority-pick-a-word-done">
<h5>H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE<a class="headerlink" href="#h4-precedence-vs-priority-pick-a-word-done" title="Permalink to this headline">¶</a></h5>
<p>During a Chef run, saved attributes are retrieved from the Chef server and are merged with the attributes on the local system. The attribute type and the source of the attribute determines which attribute values have priority over others. Attribute values are applied in the following order (from low to high priority):</p>
<ul class="simple">
<li>Default attributes applied in an attributes file</li>
<li>Default attributes applied in an environment</li>
<li>Default attributes applied in a role</li>
<li>Default attributes applied on a node directly in a recipe</li>
<li>Normal attributes applied in an attributes file</li>
<li>Normal attributes applied on a node directly in a recipe</li>
<li>Override attributes applied in an attributes file</li>
<li>Override attributes applied in a role</li>
<li>Override attributes applied in an environment</li>
<li>Override attributes applied on a node directly in a recipe</li>
<li>Automatic attributes, re-generated by Ohai during each Chef run.</li>
</ul>
</div>
<div class="section" id="h4-persistence-done">
<h5>H4 &#8211; Persistence &#8211; DONE<a class="headerlink" href="#h4-persistence-done" title="Permalink to this headline">¶</a></h5>
<p>At the beginning of a Chef run, all default, override, and automatic attributes are reset. Chef rebuilds these attributes by based on attributes contained in cookbooks, recipes, roles, and environments, plus Ohai data that is collected about that node at the beginning of the Chef run. Normal attributes are never reset. During a Chef run, any new attributes that are passed to the chef-client are merged with the existing normal attributes on the node and any new settings are applied according to attribute precedence. At the conclusion of the Chef run, all default, override, and automatic attributes disappear, leaving only a collection of normal attributes that will persist until the next Chef run.</p>
<p><strong>jamescott: THIS ONE NEEDS TO BE REVIEWED. SEE http://wiki.opscode.com/display/chef/Attributes AND READ &#8220;ATTRIBUTE PERSISTENCE&#8221; AND THEN READ THE ABOVE AND PROVIDE FEEDBACK.</strong></p>
</div>
<div class="section" id="h4-automatic-attributes-done">
<h5>H4 &#8211; Automatic Attributes &#8211; DONE<a class="headerlink" href="#h4-automatic-attributes-done" title="Permalink to this headline">¶</a></h5>
<p>An automatic attribute is data that must be understood, but not modified. For example, the IP address of a node, a host name, or the number of loaded kernel modules. When Chef makes changes to a system during a Chef run, automatic attributes are used to ensure that Chef does not make changes to the larger environment on which a node is running. An automatic attribute always has the highest attribute precedence. Automatic attributes are saved to the Chef server where they are indexed for search. Automatic attributes are detected by Ohai before every Chef run.</p>
</div>
<div class="section" id="h4-notation-done">
<h5>H4 &#8211; Notation &#8211; DONE<a class="headerlink" href="#h4-notation-done" title="Permalink to this headline">¶</a></h5>
<p>Attributes are a special key-value store called a mash within the context of the Ruby DSL. A mash is just a hash where the key can be either a symbol (:key) or a string (&#8220;key&#8221;).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individuals who are new to Ruby and Chef may have an easier time using only string notation. This approach allows attributes to &#8220;be quoted&#8221; and doesn&#8217;t require learning about special cases, namespace overlap (and <tt class="docutils literal"><span class="pre">method_missing</span></tt>), character constraints, and escaping.</p>
</div>
</div>
</div>
<div class="section" id="h3-create-environments-done">
<h4>H3 &#8211; Create Environments &#8211; DONE<a class="headerlink" href="#h3-create-environments-done" title="Permalink to this headline">¶</a></h4>
<p>An environment can be created in five different ways:</p>
<ul class="simple">
<li>Creating a Ruby file in the environments sub-directory of the Chef repository and then pushing it to the Chef server.</li>
<li>Creating a JSON file directly in the Chef repository (<strong>jamescott: where?</strong>) and then pushing it to the Chef server (<strong>jamescott: HOW?</strong>).</li>
<li>Using Knife.</li>
<li>Using the Management Console (in Hosted Chef, Private Chef, or Open Source Chef Server).</li>
<li>Using the Chef server REST API.</li>
</ul>
<p>Once an environment exists on the Chef server, a node can be associated with that environment using the <tt class="docutils literal"><span class="pre">chef_environment</span></tt> method. (<strong>jamescott: method?</strong>)</p>
</div>
<div class="section" id="h3-manage-environments-done">
<h4>H3 &#8211; Manage Environments &#8211; DONE<a class="headerlink" href="#h3-manage-environments-done" title="Permalink to this headline">¶</a></h4>
<p>Once created, an environment can be managed in several ways:</p>
<ul class="simple">
<li>Using Knife, using the <tt class="docutils literal"><span class="pre">-E</span> <span class="pre">ENVIRONMENT_NAME</span></tt> option for the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">upload</span></tt> sub-command and argument.</li>
<li>Using the Management Console (in Hosted Chef, Private Chef, or Open Source Chef Server).</li>
<li>Using Ruby or JSON files that are stored in a version source control system and pushed to the Chef server. This approach allows dynamically-generated environment data (using Ruby).</li>
</ul>
<p>These workflows are mutually exclusive: only the most recent environment changes will be kept on the Chef server, regardless of the source of those changes. All previous changes are overwritten when environment data is updated.</p>
<p>The settings for environments can be modified and environments can be integrated into the larger Chef infrastructure by associating them with nodes, using recipes to call specific environment settings, and so on. (<strong>jamescott: this could be a better lead-in</strong>)</p>
<div class="section" id="h4-save-environment-data-in-a-data-bag-done">
<h5>H4 &#8211; Save Environment Data in a Data Bag &#8211; DONE<a class="headerlink" href="#h4-save-environment-data-in-a-data-bag-done" title="Permalink to this headline">¶</a></h5>
<p>Values that are stored in a data bag are global to the organization and are available to any environment. There are two main strategies that can be used to store per-environment data within a data bag: by using a top-level key that corresponds to the environment or by using separate items for each environment.</p>
<p>A data bag that is storing a top-level key for an environment might look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="s">&quot;some_data_bag_item&quot;</span><span class="p">,</span>
  <span class="s">&quot;production&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="c"># Hash with all your data here</span>
  <span class="p">},</span>
  <span class="s">&quot;testing&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="c"># Hash with all your data here</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When using the data bag in a recipe, that data can be accessed from a recipe using code similar to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">bag_item</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="p">][</span><span class="s">&quot;some_other_key&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The other approach is to use separate items for each environment. Depending on the amount of data, it may all fit nicely within a single item. If this is the case, then creating different items for each environment may be a simple approach to providing per-environment values within a data bag. However, this approach is more time-consuming and may not scale to very large environments or when the data must be stored in many data bag items.</p>
</div>
<div class="section" id="h4-override-environment-attributes-in-roles-done">
<h5>H4 &#8211; Override Environment Attributes in Roles - DONE<a class="headerlink" href="#h4-override-environment-attributes-in-roles-done" title="Permalink to this headline">¶</a></h5>
<p>Environment attributes that are used with roles can be overridden. Typically, this is done by using attribute precedence, but sometimes it may be necessary to ensure that specific attributes are used based on the presence of specific environments. This type of scenario is best addressed in using a recipe that relies on a top-level key that is stored in a data bag. For example, to retrieve a value from a data bag based on a specific environment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mything</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s">&quot;things&quot;</span><span class="p">,</span> <span class="s">&quot;mything&quot;</span><span class="p">)</span>
<span class="n">attribute_i_want</span> <span class="o">=</span> <span class="n">mything</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-set-the-environment-for-a-node-done">
<h5>H4 &#8211; Set the Environment for a Node &#8211; DONE<a class="headerlink" href="#h4-set-the-environment-for-a-node-done" title="Permalink to this headline">¶</a></h5>
<p>A node is considered to be associated with an environment when the <tt class="docutils literal"><span class="pre">chef_environment</span></tt> attribute is set (<strong>jamescott: set to what?</strong>). The <tt class="docutils literal"><span class="pre">chef_environment</span></tt> attribute cannot be set with normal or override attributes (i.e. in a role) since it is actually a method. It must be set explicitly using the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">edit</span></tt> or <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">exec</span></tt> sub-commands, or by using one of the following methods:</p>
<ul class="simple">
<li>By editing the <tt class="docutils literal"><span class="pre">chef_environment</span></tt> directly using Knife or a management console.</li>
<li>By editing the <tt class="docutils literal"><span class="pre">environment</span></tt> configuration details in the knife.rb file and then using the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">bootstrap</span></tt> subcommand to boostrap the changes to the specified environment.</li>
<li>By setting the <tt class="docutils literal"><span class="pre">environment</span></tt> configuration entry in the chef-client configuration file (by default: /etc/chef/client.rb). When the chef-client runs, it will pick up the value and then set the <tt class="docutils literal"><span class="pre">chef_environment</span></tt> attribute of the node.</li>
<li>By calling the <tt class="docutils literal"><span class="pre">node.chef_environment(&quot;node_name&quot;)</span></tt> object and then using <tt class="docutils literal"><span class="pre">node.save</span></tt> to update the <tt class="docutils literal"><span class="pre">chef_environment</span></tt> with the attribute specified by <tt class="docutils literal"><span class="pre">node_name</span></tt>. (The <tt class="docutils literal"><span class="pre">chef_environment</span></tt> attribute cannot be accessed using the typical attribute sequence: <tt class="docutils literal"><span class="pre">node[:attribute_name]</span></tt>.) (<strong>jamescott: is this correct?</strong>)</li>
</ul>
</div>
<div class="section" id="h4-move-nodes-between-environments-done">
<h5>H4 &#8211; Move Nodes Between Environments &#8211; DONE<a class="headerlink" href="#h4-move-nodes-between-environments-done" title="Permalink to this headline">¶</a></h5>
<p>Nodes can be moved between environments, such as from a &#8220;dev&#8221; to a &#8220;production&#8221; environment by using the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">exec</span></tt> sub-command in Knife. For example:</p>
<div class="highlight-python"><pre>knife exec -E 'nodes.transform("chef_environment:dev") { |n| n.chef_environment("production") }'</pre>
</div>
</div>
<div class="section" id="h4-set-per-environment-run-lists-in-roles-done">
<h5>H4 &#8211; Set Per-environment Run-lists in Roles &#8211; DONE<a class="headerlink" href="#h4-set-per-environment-run-lists-in-roles-done" title="Permalink to this headline">¶</a></h5>
<p>A per-environment run-list is a run-list that is associated with a role and a specific environment. More than one environment can be specified in a role, but each specific environment may be associated with only one run-list. If a run-list is not specified, the default run-list will be used. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;webserver&quot;</span><span class="p">,</span>
  <span class="s">&quot;default_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="p">},</span>
  <span class="s">&quot;json_class&quot;</span><span class="p">:</span> <span class="s">&quot;Chef::Role&quot;</span><span class="p">,</span>
  <span class="s">&quot;env_run_lists&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;production&quot;</span><span class="p">:</span> <span class="p">[</span>

    <span class="p">],</span>
    <span class="s">&quot;preprod&quot;</span><span class="p">:</span> <span class="p">[</span>

    <span class="p">],</span>
    <span class="s">&quot;test&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">&quot;role[base]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache]&quot;</span>
    <span class="p">],</span>
    <span class="s">&quot;dev&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">&quot;role[base]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache::copy_dev_configs]&quot;</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s">&quot;run_list&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s">&quot;role[base]&quot;</span><span class="p">,</span>
    <span class="s">&quot;recipe[apache]&quot;</span>
  <span class="p">],</span>
  <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;The webserver role&quot;</span><span class="p">,</span>
  <span class="s">&quot;chef_type&quot;</span><span class="p">:</span> <span class="s">&quot;role&quot;</span><span class="p">,</span>
  <span class="s">&quot;override_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-searching-environments-done">
<h5>H4 &#8211; Searching Environments &#8211; DONE<a class="headerlink" href="#h4-searching-environments-done" title="Permalink to this headline">¶</a></h5>
<p>When searching, a Chef environment (<tt class="docutils literal"><span class="pre">chef_environment</span></tt>) is treated much like an attribute. This allows search results to be limited to a specified environment by using Boolean operators and extra search terms. For example, to use Knife to search for all of the servers running CentOS in an environment named &#8220;QA&#8221;, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife search node <span class="s2">&quot;chef_environment:QA AND platform:centos&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search in a recipe, use a code block similar to:</p>
<div class="highlight-python"><pre>qa_nodes = search(:node,"chef_environment:QA")
qa_nodes.each do |qa_node|
    # Do useful specific to qa nodes only
end</pre>
</div>
</div>
</div>
</div>
<div class="section" id="h2-data-bags">
<h3>H2 &#8211; Data Bags<a class="headerlink" href="#h2-data-bags" title="Permalink to this headline">¶</a></h3>
<p>A data bag is a read-only global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords). The contents of a data bag can also be encrypted to prevent the contents of that data bag from being compromised.</p>
<div class="section" id="h3-storing-data-bags-done">
<h4>H3 &#8211; Storing Data Bags &#8211; DONE?<a class="headerlink" href="#h3-storing-data-bags-done" title="Permalink to this headline">¶</a></h4>
<p>When the Chef repository is cloned from github, the following occurs:</p>
<ul class="simple">
<li>A directory named <tt class="docutils literal"><span class="pre">data_bags</span></tt> is created.</li>
<li>For each data bag, a sub-directory is created that has the same name as the data bag.</li>
<li>For each data bag item, a JSON file is created and placed in the appropriate sub-directory.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory can be placed under version source control.</p>
<p><strong>jamescott: the following seems *really* out of place.</strong></p>
<p>When deploying from a private repository using a data bag, use the <tt class="docutils literal"><span class="pre">deploy_key</span></tt> option to ensure the private key is present:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;my_app&quot;</span><span class="p">,</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="p">(</span><span class="n">truncated</span><span class="p">)</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="s2">&quot;deploy_key&quot;</span><span class="p">:</span> <span class="s2">&quot;ssh_private_key&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">ssh_private_key</span></tt> is the same SSH private key as used with a private git repository and the new lines converted to <tt class="docutils literal"><span class="pre">\n</span></tt>.</p>
<div class="section" id="h4-directory-structure-done">
<h5>H4 &#8211; Directory Structure &#8211; DONE?<a class="headerlink" href="#h4-directory-structure-done" title="Permalink to this headline">¶</a></h5>
<p>All data bags are stored in the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory of the Chef repository. This directory structure is understood by Knife so that the full path does not need to be entered when working with data bags from the command line. An example of the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory structure:</p>
<div class="highlight-python"><pre>data_bags
         |_admins
                    |_charlie.json
                    |_bob.json
                    |_tom.json
         |_db_users
                    |_charlie.json
                    |_bob.json
                    |_sarah.json
         |_db_config
                    |_small.json
                    |_medium.json
                    |_large.json
         |_standard_packages.json
         |_global_shell_settings.json</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">_admins</span></tt>, <tt class="docutils literal"><span class="pre">_db_users</span></tt>, <tt class="docutils literal"><span class="pre">_db_config</span></tt>, <tt class="docutils literal"><span class="pre">_standard_packages</span></tt>, and <tt class="docutils literal"><span class="pre">_global_shell_settings</span></tt> are the names of individual data bags and all of the files that end with <tt class="docutils literal"><span class="pre">.json</span></tt> are the individual data bag items. When using Knife, using the following syntax:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag argument DATA_BAG_NAME <span class="o">[</span>DATA_BAG_ITEM<span class="o">]</span> <span class="o">(</span>options<span class="o">)</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">argument</span></tt> is one of <tt class="docutils literal"><span class="pre">create</span></tt>, <tt class="docutils literal"><span class="pre">delete</span></tt>, or <tt class="docutils literal"><span class="pre">edit</span></tt>, <tt class="docutils literal"><span class="pre">DATA_BAG_NAME</span></tt> is the name of the data bag, and <tt class="docutils literal"><span class="pre">DATA_BAG_ITEM</span></tt> is the name of the data bag item.</p>
<p>For example, to edit the data bag item (from the above example) named <tt class="docutils literal"><span class="pre">_sarah.json</span></tt>, use the following Knife command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag edit db_users sarah
</pre></div>
</div>
</div>
<div class="section" id="h4-data-bag-items-done">
<h5>H4 &#8211; Data Bag Items &#8211; DONE?<a class="headerlink" href="#h4-data-bag-items-done" title="Permalink to this headline">¶</a></h5>
<p>A data bag is a container of related data bag items, where each individual data bag item is a JSON file. The only structural requirement of a data bag item is that it must have an <tt class="docutils literal"><span class="pre">id</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;ITEM_NAME&quot;</span>
  <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;value&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">key</span></tt> and <tt class="docutils literal"><span class="pre">value</span></tt> are the key:value pair for each additional attribute within the data bag item. Knife can load a data bag item by specifying the name of the data bag to which the item belongs and then the filename of the data bag item.</p>
</div>
</div>
<div class="section" id="h3-create-data-bags-done">
<h4>H3 &#8211; Create Data Bags &#8211; DONE?<a class="headerlink" href="#h3-create-data-bags-done" title="Permalink to this headline">¶</a></h4>
<p>A data bag can be created in two ways: using Knife or manually. In general, using Knife to create data bags is recommended, but as long as the data bag folders and data bag item JSON files are created correctly, either method is safe and effective.</p>
<div class="section" id="h4-using-knife-done">
<h5>H4 &#8211; Using Knife &#8211; DONE?<a class="headerlink" href="#h4-using-knife-done" title="Permalink to this headline">¶</a></h5>
<p>Knife can be used to create data bags and data bag items when the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command is run with the <tt class="docutils literal"><span class="pre">create</span></tt> argument and to update the Chef server with local changes to data bag items with the <tt class="docutils literal"><span class="pre">from_file</span></tt> argument. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create DATA_BAG_NAME <span class="o">(</span>DATA_BAG_ITEM<span class="o">)</span>
</pre></div>
</div>
<p>As long as a file is in the correct directory structure Knife will be able to find the data bag and data bag item with only the name. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file BAG_NAME ITEM_NAME.json
</pre></div>
</div>
<p>will load the following file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data_bags</span><span class="o">/</span><span class="n">BAG_NAME</span><span class="o">/</span><span class="n">ITEM_NAME</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Continuing the example above, if you are in the &#8220;admins&#8221; directory and make changes to the file charlie.json, then to upload that change to the Chef server use the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag from file admins charlie.json
</pre></div>
</div>
<p>In some cases, such as when Knife is not being run from the root directory for Chef, the full path to the data bag item may be required. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife data bag from file BAG_NAME /path/to/file/ITEM_NAME.json
</pre></div>
</div>
</div>
<div class="section" id="h4-manually-done">
<h5>H4 &#8211; Manually &#8211; DONE?<a class="headerlink" href="#h4-manually-done" title="Permalink to this headline">¶</a></h5>
<p>One or more data bags and data bag items can be created manually under the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory in the Chef repository. Any method can be used to create the data bag folders and data bag item JSON files. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir data_bags/admins
</pre></div>
</div>
<p>would create a data bag folder named &#8220;admins&#8221;. The equivalent command for using Knife is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create admins
</pre></div>
</div>
<p>A data bag item can be created manually in the same way as the data bag, but by also specifying the file name for the data bag item (this example is using the Unix Visual Editor):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vi data_bags/admins/charlie.json
</pre></div>
</div>
<p>would create a data bag item named &#8220;charlie.json&#8221; under the &#8220;admins&#8221; sub-directory in the <tt class="docutils literal"><span class="pre">data_bags</span></tt> directory of the Chef repository. The equivalent command for using Knife is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife data bag create admins charlie
</pre></div>
</div>
</div>
</div>
<div class="section" id="h3-encrypting-data-bags-done">
<h4>H3 &#8211; Encrypting Data Bags &#8211; DONE?<a class="headerlink" href="#h3-encrypting-data-bags-done" title="Permalink to this headline">¶</a></h4>
<p>The contents of a data bag can be encrypted. Data is encrypted using a combination of YAML, AES-256-CBC (as defined by the <tt class="docutils literal"><span class="pre">openssl</span></tt> package in the Ruby Standard Library), and Base64 encoding. This allows a data bag to store confidential information (such as a database password) or to be managed in a source control system (without plain-text data appearing in revision history). Only designated nodes are able to decrypt values stored in an encrypted data bag. The system uses shared-key encryption. An encrypted file can only be decrypted by a node or a user with the same shared-key. A recipe can load encrypted data as long as the shared secret is present in a file on the node or is accessible from a URI path. Only the values of a data bag item are decrypted; keys are still searchable. The values associated with the <tt class="docutils literal"><span class="pre">id</span></tt> key of a data bag item are not encrypted (because they are needed by Chef when tracking the data bag item).</p>
<div class="section" id="h4-knife-options-for-encryption-done">
<h5>H4 &#8211; Knife Options for Encryption &#8211; DONE?<a class="headerlink" href="#h4-knife-options-for-encryption-done" title="Permalink to this headline">¶</a></h5>
<p>Knife can encrypt and decrypt data when the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command is run with the <tt class="docutils literal"><span class="pre">create</span></tt>, <tt class="docutils literal"><span class="pre">edit</span></tt>, <tt class="docutils literal"><span class="pre">from</span> <span class="pre">file</span></tt>, or <tt class="docutils literal"><span class="pre">show</span></tt> arguments and the following options:</p>
<p>This argument has the following options:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">--secret</span> <span class="pre">SECRET</span></tt></td>
<td>The encryption key that is used for values contained within a data bag.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">--secret-file</span> <span class="pre">FILE</span></tt></td>
<td>The path to the file that contains the encryption key.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-scenario-create-an-encrypted-data-bag-item-done">
<h5>H4 &#8211; Scenario: Create an encrypted data bag item &#8211; DONE?<a class="headerlink" href="#h4-scenario-create-an-encrypted-data-bag-item-done" title="Permalink to this headline">¶</a></h5>
<p>An encrypted data bag item can be created with a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife data bag create passwords mysql --secret-file /tmp/my_data_bag_key
</pre></div>
</div>
<p>where &#8220;passwords&#8221; is the name of the data bag, &#8220;mysql&#8221; is the name of the data bag item, and &#8220;/tmp/my_data_bag_key&#8221; is the path to the location in which the file that contains the secret-key is located. Knife will ask for user credentials before the encrypted data bag item is saved.</p>
</div>
<div class="section" id="h4-scenario-verify-that-a-data-bag-item-is-encrypted-done">
<h5>H4 &#8211; Scenario: Verify that a data bag item is encrypted &#8211; DONE?<a class="headerlink" href="#h4-scenario-verify-that-a-data-bag-item-is-encrypted-done" title="Permalink to this headline">¶</a></h5>
<p>When the contents of a data bag are encrypted, they will not be readable until they are decrypted. Encryption can be verified with a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife data bag create passwords mysql
</pre></div>
</div>
<p>where &#8220;passwords&#8221; is the name of the data bag, &#8220;mysql&#8221; is the name of the data bag item. This will return something similar to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;trywgFA6R70NO28PNhMpGhEvKBZuxouemnbnAUQsUyo=\n&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;e/p+8WJYVHY9fHcEgAAReg==\n&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-scenario-decrypt-an-encrypted-data-bag-item-done">
<h5>H4 &#8211; Scenario: Decrypt an encrypted data bag item &#8211; DONE?<a class="headerlink" href="#h4-scenario-decrypt-an-encrypted-data-bag-item-done" title="Permalink to this headline">¶</a></h5>
<p>An encrypted data bag item can be decrypted with a Knife command similar to:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife data bag show --secret-file /tmp/my_data_bag_key passwords mysql
</pre></div>
</div>
<p>that will return JSON output similar to:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span>
  <span class="s2">&quot;pass&quot;</span><span class="o">:</span> <span class="s2">&quot;thesecret123&quot;</span><span class="p">,</span>
   <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;fred&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-scenario-storing-encryption-keys-on-nodes-done">
<h5>H4 &#8211; Scenario: Storing encryption keys on nodes &#8211; DONE?<a class="headerlink" href="#h4-scenario-storing-encryption-keys-on-nodes-done" title="Permalink to this headline">¶</a></h5>
<p>An encryption key can also be stored in an alternate file on the nodes that need it and specify the path location to the file inside an attribute; however, <tt class="docutils literal"><span class="pre">EncryptedDataBagItem.load</span></tt> expects to see the actual secret as the third argument, rather than a path to the secret file. In this case, you can use <tt class="docutils literal"><span class="pre">EncryptedDataBagItem.load_secret</span></tt> to slurp the secret file contents and then pass them:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># inside your attribute file:</span>
<span class="c1"># default[:mysql][:secretpath] = &quot;C:\\chef\\any_secret_filename&quot;</span>
<span class="c1">#</span>
<span class="c1"># inside your recipe:</span>
<span class="c1"># look for secret in file pointed to by mysql attribute :secretpath</span>
<span class="n">mysql_secret</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load_secret</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:mysql</span><span class="o">][</span><span class="ss">:secretpath</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">mysql_secret</span><span class="p">)</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-example-done">
<h5>H4 &#8211; Example &#8211; DONE?<a class="headerlink" href="#h4-example-done" title="Permalink to this headline">¶</a></h5>
<p>To demonstrate the use of encrypted data bags on a node, we&#8217;ll start by copying the secret_key file created above to an example node using scp and moving it to /etc/chef/encrypted_data_bag_secret:</p>
<div class="highlight-bash"><div class="highlight"><pre>scp ./secret_key <span class="nv">$MY_NODE_IP</span>:~/
ssh <span class="nv">$MY_NODE_IP</span>
sudo mv ./secret_key /etc/chef/encrypted_data_bag_secret
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">bootstrap</span></tt> sub-command supports the <tt class="docutils literal"><span class="pre">encrypted_data_bag_secret</span></tt> setting in knife.rb. You will want to add this line:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">encrypted_data_bag_secret</span> <span class="s1">&#39;/path/to/your/data_bag_key&#39;</span>
</pre></div>
</div>
<p>And change <tt class="docutils literal"><span class="pre">/path/to/your/data_bag_key</span></tt> to the location of where the data bag key is located. When you run knife bootstrap afterwards it automatically adds this line to the client.rb for the node you are bootstrapping and copies the key over.</p>
<p>Next, we&#8217;ll create a recipe that will log the decrypted values for demonstration purposes (if these were real secrets, you would want to avoid logging them). Use Knife and run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife cookbook create edb_demo
</pre></div>
</div>
<p>Then edit cookbooks/edb_demo/recipes/default.rb so that it contains the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># cookbooks/edb_demo/recipes/default.rb</span>
<span class="n">passwords</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;prod&quot;</span><span class="p">,</span> <span class="s2">&quot;passwords&quot;</span><span class="p">)</span>
<span class="n">mysql</span> <span class="o">=</span> <span class="n">passwords</span><span class="o">[</span><span class="s2">&quot;mysql&quot;</span><span class="o">]</span>
<span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The mysql password is: ‘</span><span class="si">#{</span><span class="n">mysql</span><span class="si">}</span><span class="s2">’&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, upload the cookbook and run chef-client on the node. You should see something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife cookbook upload edb_demo
<span class="c"># output clipped</span>
knife ssh name:i-8a436fe5 -a ec2.public_hostname &amp;#8216;sudo chef-client&amp;#8217;
INFO: *** Chef 0.10.0 ***
INFO: Run List is <span class="o">[</span>recipe<span class="o">[</span>edb_demo<span class="o">]]</span>
INFO: Run List expands to <span class="o">[</span>edb_demo<span class="o">]</span>
INFO: Starting Chef Run <span class="k">for </span>i-8a436fe5
INFO: Loading cookbooks <span class="o">[</span>edb_demo<span class="o">]</span>
INFO: The mysql password is: &amp;#8216;open-sesame-123&amp;#8242;
INFO: Chef Run <span class="nb">complete </span>in 3.122228 seconds
INFO: Running report handlers
INFO: Report handlers <span class="nb">complete</span>
</pre></div>
</div>
<p>As you can see, the recipe was able to decrypt the values in the encrypted data bag. It did so by using the shared secret located in the default location of /etc/chef/encrypted_data_bag_secret.</p>
</div>
</div>
<div class="section" id="h3-use-data-bags-in-recipes-done">
<h4>H3 &#8211; Use Data Bags in Recipes &#8211; DONE?<a class="headerlink" href="#h3-use-data-bags-in-recipes-done" title="Permalink to this headline">¶</a></h4>
<p>Data bags can be accessed by a recipe in the following ways:</p>
<ul class="simple">
<li>Loaded by name when using the recipe DSL. Use this approach when a only single, known data bag item is required.</li>
<li>Accessed via the search indexes. Use this approach when more than one data bag item is required or when the contents of a data bag are looped through. The search indexes will bulk-load all of the data bag items, which will result in a lower overhead than if each data bag item were loaded by name.</li>
</ul>
<div class="section" id="h4-scenario-loading-a-data-bag-item-using-the-recipe-dsl-done">
<h5>H4 &#8211; Scenario: Loading a Data Bag Item using the Recipe DSL &#8211; DONE?<a class="headerlink" href="#h4-scenario-loading-a-data-bag-item-using-the-recipe-dsl-done" title="Permalink to this headline">¶</a></h5>
<p>The recipe DSL provides access to data bags and data bag items with the following methods:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">data_bag(bag)</span></tt>, where <tt class="docutils literal"><span class="pre">bag</span></tt> is the name of the data bag.</li>
<li><tt class="docutils literal"><span class="pre">data_bag_item('bag',</span> <span class="pre">'item')</span></tt>, where <tt class="docutils literal"><span class="pre">bag</span></tt> is the name of the data bag and <tt class="docutils literal"><span class="pre">item</span></tt> is the name of the data bag item.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">data_bag</span></tt> method returns an array with a key for each of the data bag items that are found in the data bag. For example, a data bag named &#8220;admins&#8221; with a single data bag item named &#8220;charlie&#8221; could be loaded with:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">data_bag</span><span class="p">(</span><span class="s2">&quot;admins&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>to return this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># =&gt; [&quot;charlie&quot;]</span>
</pre></div>
</div>
<p>To load the contents of the data bag item named &#8220;charlie&#8221;:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="s1">&#39;charlie&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>to return something like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># =&gt; {&quot;comment&quot;=&gt;&quot;Crazy Charlie&quot;, &quot;gid&quot;=&gt;1005, &quot;id&quot;=&gt;&quot;charlie&quot;, &quot;uid&quot;=&gt;1005, &quot;shell&quot;=&gt;&quot;/bin/zsh&quot;}</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-scenario-creating-and-editing-data-bag-within-a-recipe-done">
<h5>H4 &#8211; Scenario: Creating and Editing Data Bag within a Recipe &#8211; DONE?<a class="headerlink" href="#h4-scenario-creating-and-editing-data-bag-within-a-recipe-done" title="Permalink to this headline">¶</a></h5>
<p>Creating and editing the contents of a data bag or a data bag item from a recipe is not recommended. The recommended method of updating a data bag or a data bag item is to use Knife and the <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">data</span> <span class="pre">bag</span></tt> sub-command. If this action must be done from a recipe, please note the following:</p>
<ul class="simple">
<li>If two chef-client operations concurrently attempt to update the contents of a data bag, the last-written attempt will win. This situation can lead to data loss, so organizations should take steps to ensure that only one chef-client is making updates to a data bag at a time.</li>
<li>Altering data bags from the node when using Open Source Chef Server requires the node&#8217;s API client to be granted admin privileges. In most cases, this is not advisable.</li>
</ul>
<p>and then take steps to ensure that any actions are done carefully. The following examples show how a recipe can be used to create and edit the contents of a data bag or a data bag item using the <tt class="docutils literal"><span class="pre">Chef::DataBag</span></tt> and <tt class="docutils literal"><span class="pre">Chef::DataBagItem</span></tt> objects.</p>
<p>To create a data bag from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">users</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">DataBag</span><span class="o">.</span><span class="n">new</span>
<span class="n">users</span><span class="o">.</span><span class="n">name</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<span class="n">users</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>To create a data bag item from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">sam</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sam&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Full Name&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sammy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;shell&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/bin/zsh&quot;</span>
<span class="p">}</span>
<span class="n">databag_item</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">DataBagItem</span><span class="o">.</span><span class="n">new</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">data_bag</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">sam</span>
<span class="n">databag_item</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>To edit the contents of a data bag item from a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">sam</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> <span class="s2">&quot;sam&quot;</span><span class="p">)</span>
<span class="n">sam</span><span class="o">[</span><span class="s2">&quot;Full Name&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Samantha&quot;</span>
<span class="n">sam</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-scenario-access-encrypted-data-from-a-recipe-done">
<h5>H4 &#8211; Scenario: Access Encrypted Data from a Recipe &#8211; DONE?<a class="headerlink" href="#h4-scenario-access-encrypted-data-from-a-recipe-done" title="Permalink to this headline">¶</a></h5>
<p>A recipe can access encrypted data bag items as long as the recipe is running on a node that has access to the shared-key that is required to decrypt the data. A secret can be specified by using the <tt class="docutils literal"><span class="pre">Chef::EncryptedDataBagItem.load</span></tt> method. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">secret_key</span><span class="p">)</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
<p>where &#8220;secret_key&#8221; is the argument that specifies the location of the file that contains encryption key. An encryption key can be stored in a file on the nodes that need it and then configured so that Chef knows where to look using the <tt class="docutils literal"><span class="pre">Chef::Config[:encrypted_data_bag_secret]</span></tt> method, which defaults to /etc/chef/encrypted_data_bag_secret. When the default location is used, the argument that specifies the secret key file location is assumed to be the default and does not need to be explicitly specified in the recipe. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">mysql_creds</span> <span class="o">=</span> <span class="no">Chef</span><span class="o">::</span><span class="no">EncryptedDataBagItem</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;passwords&quot;</span><span class="p">,</span> <span class="s2">&quot;mysql&quot;</span><span class="p">)</span> <span class="c1"># no secret_key</span>
<span class="n">mysql_creds</span><span class="o">[</span><span class="s2">&quot;pass&quot;</span><span class="o">]</span> <span class="c1"># will be decrypted</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-scenario-create-a-user-for-each-item-in-a-data-bag-done">
<h5>H4 &#8211; Scenario: Create a user for each item in a data bag &#8211; DONE?<a class="headerlink" href="#h4-scenario-create-a-user-for-each-item-in-a-data-bag-done" title="Permalink to this headline">¶</a></h5>
<p>Chef can create users on systems based on the contents of a data bag. For example, a data bag named &#8220;admins&#8221; can contain a data bag item for each of the administrators that will manage the various systems that Chef is maintaining. A recipe can load the data bag items and then create user accounts on the target system with code similar to the following:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># Load the keys of the items in the &#39;admins&#39; data bag</span>
<span class="n">admins</span> <span class="o">=</span> <span class="n">data_bag</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">)</span>

<span class="n">admins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">login</span><span class="o">|</span>
  <span class="c1"># This causes a round-trip to the server for each admin in the data bag</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s1">&#39;admins&#39;</span><span class="p">,</span> <span class="n">login</span><span class="p">)</span>
  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># for each admin in the data bag, make a user resource</span>
  <span class="c1"># to ensure they exist</span>
  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>

    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Create an &quot;admins&quot; group on the system</span>
<span class="c1"># You might use this group in the /etc/sudoers file</span>
<span class="c1"># to provide sudo access to the admins</span>
<span class="n">group</span> <span class="s2">&quot;admins&quot;</span> <span class="k">do</span>
  <span class="n">gid</span>     <span class="mi">999</span>
  <span class="n">members</span> <span class="n">admins</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="h3-using-search-done">
<h4>H3 &#8211; Using Search &#8211; DONE?<a class="headerlink" href="#h3-using-search-done" title="Permalink to this headline">¶</a></h4>
<p>A data bag is a read-only global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords). The contents of a data bag can also be encrypted to prevent the contents of that data bag from being compromised.</p>
<p>Any search for a data bag (or a data bag item) must specify the name of the data bag and then provide the search query string that will be used during the search. For example, to use Knife to search within a data bag named &#8220;admin_data&#8221; across all items, except for the &#8220;admin_users&#8221; item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admin_data <span class="s2">&quot;(NOT id:admin_users)&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search query in a recipe, use a code block similar to (<strong>jamescott: the following code sample is probably wrong</strong>):</p>
<div class="highlight-python"><pre>search(:admin_data, "NOT id:admin_users")</pre>
</div>
<p>It may not be possible to know which data bag items will be needed. It may be necessary to load everything in a data bag (but not know what &#8220;everything&#8221; is). Using a search query is the ideal way to deal with that ambiguity, yet still ensure that all of the required data is returned. The following examples show how a recipe can use a series of search queries to search within a data bag named &#8220;admins&#8221;. For example, to find every administrator:</p>
<div class="highlight-python"><pre>search(:admins, "*:*")</pre>
</div>
<p>Or to search for an administrator named &#8220;charlie&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:charlie")</pre>
</div>
<p>Or to search for an administrator with a group identifier of &#8220;ops&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "gid:ops")</pre>
</div>
<p>Or to search for an administrator whose name begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:c*")</pre>
</div>
<p>Data bag items that are returned by a search query can be used as if they were a hash. For example:</p>
<div class="highlight-python"><pre>charlie = search(:admins, "id:charlie").first
# =&gt; variable 'charlie' is set to the charlie data bag item
charlie["gid"]
# =&gt; "ops"
charlie["shell"]
# =&gt; "/bin/zsh"</pre>
</div>
<p>The following recipe can be used to create a user for each administrator by loading all of the items from the &#8220;admins&#8221; data bag, looping through each admin in the data bag, and then creating a user resource so that each of those admins exist:</p>
<div class="highlight-python"><pre>admins = data_bag('admins')

admins.each do |login|
  admin = data_bag_item('admins', login)
  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']
    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
<p>And then the same recipe, modified to load administrators using a search query (and using an array to store the results of the search query):</p>
<div class="highlight-python"><pre>admins = []

search(:admins, "*:*") do |admin|
  login = admin["id"]

  admins &lt;&lt; login

  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']

    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
<p><strong>jamescott: should these also be in the Search place? Ideally, this can be squeezed down so that it&#8217;s not completely redundant. The overview should be able to handle the cross-references elegantly.</strong></p>
<p><strong>jamescott: this should sync up with the Search essentials topics too.</strong></p>
<p><strong>jamescott: first two paragraphs above are includes. Try to make them not so redundantredundant (if they are).</strong></p>
<div class="section" id="h4-search-syntax-done">
<h5>H4 &#8211; Search Syntax &#8211; DONE?<a class="headerlink" href="#h4-search-syntax-done" title="Permalink to this headline">¶</a></h5>
<p>In some situations, it may not be possible to know exactly which data bags (or data bag items) should be used. Or in other situations, loading all of the data in a data bag might be the desired result. Use the search index to find data that is stored in one or more data bags in the Chef environment and the various search patterns to fine-tune the search queries. Any data that is returned as the result of a search query can then be loaded by a recipe. <strong>jamescott: are their other examples here?</strong> Use the following syntax when searching for data in a data bag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="n">name_of_data_bag</span><span class="p">,</span> <span class="n">search_query</span><span class="p">)</span>
</pre></div>
</div>
<p>For example, to find every admin in a data bag named &#8220;admins&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "*:*")</pre>
</div>
<p>Or, to search for an administrator with an ID of &#8220;charlie&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:charlie")</pre>
</div>
<p>Or, to search for all administrators with a group ID of &#8220;ops&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "gid:ops")</pre>
</div>
<p>Or, to search for all administrators with an ID that begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:c*")</pre>
</div>
<p>Once returned, this data can be used as if it were a hash. For example:</p>
<div class="highlight-python"><pre>charlie = search(:admins, "id:charlie").first
# =&gt; variable 'charlie' is set to the charlie data bag item
charlie["gid"]
# =&gt; "ops"
charlie["shell"]
# =&gt; "/bin/ssh"</pre>
</div>
</div>
<div class="section" id="h4-accessing-data-bags-using-search-indexes-done">
<h5>H4 &#8211; Accessing Data Bags using Search Indexes &#8211; DONE?<a class="headerlink" href="#h4-accessing-data-bags-using-search-indexes-done" title="Permalink to this headline">¶</a></h5>
<p><strong>jamescott: check this one!</strong></p>
<p>Any search for a data bag (or a data bag item) must specify the name of the data bag and then provide the search query string that will be used during the search. For example, to use Knife to search within a data bag named &#8220;admin_data&#8221; across all items, except for the &#8220;admin_users&#8221; item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admin_data <span class="s2">&quot;(NOT id:admin_users)&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search query in a recipe, use a code block similar to (<strong>jamescott: the following code sample is probably wrong</strong>):</p>
<div class="highlight-python"><pre>search(:admin_data, "NOT id:admin_users")</pre>
</div>
<p>It may not be possible to know which data bag items will be needed. It may be necessary to load everything in a data bag (but not know what &#8220;everything&#8221; is). Using a search query is the ideal way to deal with that ambiguity, yet still ensure that all of the required data is returned. The following examples show how a recipe can use a series of search queries to search within a data bag named &#8220;admins&#8221;. For example, to find every administrator:</p>
<div class="highlight-python"><pre>search(:admins, "*:*")</pre>
</div>
<p>Or to search for an administrator named &#8220;charlie&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:charlie")</pre>
</div>
<p>Or to search for an administrator with a group identifier of &#8220;ops&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "gid:ops")</pre>
</div>
<p>Or to search for an administrator whose name begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:c*")</pre>
</div>
<p>Data bag items that are returned by a search query can be used as if they were a hash. For example:</p>
<div class="highlight-python"><pre>charlie = search(:admins, "id:charlie").first
# =&gt; variable 'charlie' is set to the charlie data bag item
charlie["gid"]
# =&gt; "ops"
charlie["shell"]
# =&gt; "/bin/zsh"</pre>
</div>
<p>The following recipe can be used to create a user for each administrator by loading all of the items from the &#8220;admins&#8221; data bag, looping through each admin in the data bag, and then creating a user resource so that each of those admins exist:</p>
<div class="highlight-python"><pre>admins = data_bag('admins')

admins.each do |login|
  admin = data_bag_item('admins', login)
  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']
    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
<p>And then the same recipe, modified to load administrators using a search query (and using an array to store the results of the search query):</p>
<div class="highlight-python"><pre>admins = []

search(:admins, "*:*") do |admin|
  login = admin["id"]

  admins &lt;&lt; login

  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']

    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
</div>
<div class="section" id="id1">
<h5>H4 &#8211; Example &#8211; DONE?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h5>
<p>The following example shows how to use the search index to find all of the items in a data bag (called &#8220;admins&#8221; that stores the user data for each system administrator), add each data bag item to an array, ensure that each data bag item exists as a user resource, and then to create a security group to which each of the data bag items belongs.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1"># An empty array to which we&#39;ll add the admins&#39; logins as we go.</span>
<span class="n">admins</span> <span class="o">=</span> <span class="o">[]</span>

<span class="c1"># search for all items in the &#39;admins&#39; data bag and loop over them</span>
<span class="n">search</span><span class="p">(</span><span class="ss">:admins</span><span class="p">,</span> <span class="s2">&quot;*:*&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
  <span class="c1"># Set `login` to the id of the data bag item</span>
  <span class="n">login</span> <span class="o">=</span> <span class="n">admin</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>

  <span class="c1"># build up the list of the admins logins</span>
  <span class="n">admins</span> <span class="o">&lt;&lt;</span> <span class="n">login</span>

  <span class="n">home</span> <span class="o">=</span> <span class="s2">&quot;/home/</span><span class="si">#{</span><span class="n">login</span><span class="si">}</span><span class="s2">&quot;</span>

  <span class="c1"># for each admin in the data bag, make a user resource</span>
  <span class="c1"># to ensure they exist</span>
  <span class="n">user</span><span class="p">(</span><span class="n">login</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">uid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;uid&#39;</span><span class="o">]</span>
    <span class="n">gid</span>       <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;gid&#39;</span><span class="o">]</span>
    <span class="n">shell</span>     <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;shell&#39;</span><span class="o">]</span>
    <span class="n">comment</span>   <span class="n">admin</span><span class="o">[</span><span class="s1">&#39;comment&#39;</span><span class="o">]</span>

    <span class="n">home</span>      <span class="n">home</span>
    <span class="n">supports</span>  <span class="ss">:manage_home</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c1"># Create an &quot;admins&quot; group on the system</span>
<span class="c1"># You might use this group in the /etc/sudoers file</span>
<span class="c1"># to provide sudo access to the admins</span>
<span class="n">group</span> <span class="s2">&quot;admins&quot;</span> <span class="k">do</span>
  <span class="n">gid</span>     <span class="mi">999</span>
  <span class="n">members</span> <span class="n">admins</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="h3-use-data-bags-with-environments-done">
<h4>H3 &#8211; Use Data Bags with Environments &#8211; DONE?<a class="headerlink" href="#h3-use-data-bags-with-environments-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: the following contents in this section are IDENTICAL to what is in the essentials_environments topic. This either needs to be better-consolidated or INCLUDED.</strong></p>
<p>Values that are stored in a data bag are global to the organization and are available to any environment. There are two main strategies that can be used to store per-environment data within a data bag: by using a top-level key that corresponds to the environment or by using separate items for each environment.</p>
<p>A data bag that is storing a top-level key for an environment might look something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="s">&quot;some_data_bag_item&quot;</span><span class="p">,</span>
  <span class="s">&quot;production&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="c"># Hash with all your data here</span>
  <span class="p">},</span>
  <span class="s">&quot;testing&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="c"># Hash with all your data here</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When using the data bag in a recipe, that data can be accessed from a recipe using code similar to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">bag_item</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">chef_environment</span><span class="p">][</span><span class="s">&quot;some_other_key&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The other approach is to use separate items for each environment. Depending on the amount of data, it may all fit nicely within a single item. If this is the case, then creating different items for each environment may be a simple approach to providing per-environment values within a data bag. However, this approach is more time-consuming and may not scale to very large environments or when the data must be stored in many data bag items.</p>
</div>
<div class="section" id="h3-use-data-bags-with-chef-solo-done">
<h4>H3 &#8211; Use Data Bags with Chef Solo &#8211; DONE?<a class="headerlink" href="#h3-use-data-bags-with-chef-solo-done" title="Permalink to this headline">¶</a></h4>
<p>Chef Solo can load data from a data bag as long as the contents of that data bag are accessible from a directory structure that exists on the same machine as Chef Solo. The location of this directory is configurable using the <tt class="docutils literal"><span class="pre">data_bag_path</span></tt> option in the solo.rb file. The name of each sub-directory corresponds to a data bag and each JSON file within a sub-directory corresponds to a data bag item. Search is not available in recipes when they are run with Chef Solo; use the <tt class="docutils literal"><span class="pre">data_bag()</span></tt> and <tt class="docutils literal"><span class="pre">data_bag_item()</span></tt> functions to access data bags and data bag items.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use the <tt class="docutils literal"><span class="pre">chef-solo-search</span></tt> cookbook library (developed by Opscode community member &#8220;edelight&#8221; and available from github) to add data bag search capabilities to a Chef Solo environment: <a class="reference external" href="https://github.com/edelight/chef-solo-search">https://github.com/edelight/chef-solo-search</a>.</p>
</div>
</div>
</div>
<div class="section" id="h2-roles-done">
<h3>H2 &#8211; Roles &#8211; DONE<a class="headerlink" href="#h2-roles-done" title="Permalink to this headline">¶</a></h3>
<p>A role is a way to define certain patterns and processes that exist across nodes in a Chef organization as belonging to a single job function. Each role consists of one (or more) attributes and a run list. Each node can have one (or more) roles assigned to it. When a role is run against a node the configuration details of that node are compared against the attributes of the role, and then the contents of that role&#8217;s run list are applied to the node&#8217;s configuration details. When a chef-client runs, it merges its own attributes and run lists with those contained within each assigned role.</p>
<div class="section" id="h3-role-formats-done">
<h4>H3 &#8211; Role Formats &#8211; DONE<a class="headerlink" href="#h3-role-formats-done" title="Permalink to this headline">¶</a></h4>
<p>Role data is stored in two formats: as a Ruby file that contains domain-specific language and as JSON data.</p>
<div class="section" id="id2">
<h5>H4 &#8211; Ruby DSL &#8211; DONE<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>Chef uses a domain-specific language in Ruby to define recipes and to store settings, such as those which define a role or an environment. These settings are saved as Ruby files and are stored in the Chef repository. When these files are uploaded to the Chef server, they are converted to JSON. Each time the Chef repository is refreshed, the contents of all domain-specific Ruby files are re-compiled to JSON and are re-uploaded to the Chef server.</p>
<p>Domain-specific Ruby attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default_attributes</span></tt></td>
<td><p class="first">Optional. A set of attributes that should be applied to all nodes, assuming the node does not already have a value for the attribute. This is useful for setting global defaults that can then be overridden for specific nodes. If more than one role attempts to set a default value for the same attribute, the last role applied will win. When nested attributes are present, they will be preserved. For example, to specify that a node that has the attribute <tt class="docutils literal"><span class="pre">apache2</span></tt> should listen on ports 80 and 443 (unless ports are already specified):</p>
<div class="last highlight-python"><pre>default_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "80", "443" ] }</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">description</span></tt></td>
<td><p class="first">A description of the functionality that is covered. For example:</p>
<div class="last highlight-python"><pre>description 'The base role for systems that serve HTTP traffic'</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">env_run_lists</span></tt></td>
<td><p class="first">Optional. A list of environments, each specifying a recipe or a role that will be applied to that environment. Each environment in the list may only have a single recipe or role assigned to it. This setting must specify the <tt class="docutils literal"><span class="pre">_default</span></tt> environment. If the <tt class="docutils literal"><span class="pre">_default</span></tt> environment is set to <tt class="docutils literal"><span class="pre">[]</span></tt> or <tt class="docutils literal"><span class="pre">nil</span></tt> then the run list will be empty. <strong>jamescott: SEE CHEF-2636.</strong> For example:</p>
<div class="last highlight-python"><pre>env_run_lists "prod" =&gt; ["recipe[apache2]"], "staging" =&gt; ["recipe[apache2::staging]"</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">name</span></tt></td>
<td><p class="first">A unique name within the Chef organization. Each name must be unique and must be made up of letters (upper- and lower-case), numbers, underscores, and hyphens: [A-Z][a-z][0-9] and [_-]. Spaces are not allowed. For example:</p>
<div class="last highlight-python"><pre>name 'dev01-24'</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override_attributes</span></tt></td>
<td><p class="first">Optional. A set of attributes that should be applied to all nodes, even if the node already has a value for an attribute. This is useful for ensuring that certain attributes always have specific values. If more than one role attempts to set an override value for the same attribute, the last role applied will win. When nested attributes are present, they will be preserved. For example:</p>
<div class="highlight-python"><pre>override_attributes "apache2" =&gt; { "max_children" =&gt; "50" }</pre>
</div>
<p>The parameters in a Ruby file are actually Ruby method calls, so parentheses can be used to provide clarity when specifying numerous or deeply-nested attributes. For example:</p>
<div class="highlight-python"><pre>override_attributes(
  :apache2 =&gt; {
    :prefork =&gt; { :min_spareservers =&gt; "5" }
  }
)</pre>
</div>
<p>Or:</p>
<div class="last highlight-python"><pre>override_attributes(
  :apache2 =&gt; {
    :prefork =&gt; { :min_spareservers =&gt; "5" }
  },
  :tomcat =&gt; {
    :worker_threads =&gt; "100"
  }
)</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">run_list</span></tt></td>
<td><p class="first">A list of recipes and/or roles that will be applied <strong>and</strong> the order in which those recipes and/or roles will be applied. For example, the following run list:</p>
<div class="highlight-python"><pre>run_list "recipe[apache2]", "recipe[apache2::mod_ssl]", "role[monitor]"</pre>
</div>
<p class="last">would apply the <tt class="docutils literal"><span class="pre">apache2</span></tt> recipe first, then the <tt class="docutils literal"><span class="pre">apache2::mod_ssl</span></tt> recipe, and then the <tt class="docutils literal"><span class="pre">role[monitor]</span></tt> recipe.</p>
</td>
</tr>
</tbody>
</table>
<p>A Ruby DSL file for each role must exist in the (jamescott: PATH) roles subdirectory of the Chef repository. (If the repository does not have this subdirectory, then create it.) Each Ruby file should have the .rb suffix. The complete roles Ruby has the following syntax:</p>
<div class="highlight-python"><pre>name "role_name"
description "role_description"
run_list "recipe[name]", "recipe[name::attribute]", "recipe[name::attribute]"
env_run_lists "name" =&gt; ["recipe[name]"], "environment_name" =&gt; ["recipe[name::attribute]"]
default_attributes "node" =&gt; { "attribute" =&gt; [ "value", "value", "etc." ] }
override_attributes "node" =&gt; { "attribute" =&gt; [ "value", "value", "etc." ] }</pre>
</div>
<p><strong>jamescott: need to verify the base syntax above.</strong></p>
<p>where both default and override attributes are optional and at least one run-list (with at least one run-list item) is specified. For example, a role named &#8220;webserver&#8221; that has a run-list that defines actions for three different roles, and for certain roles takes extra steps (such as the &#8220;apache2&#8221; role listening on ports 80 and 443):</p>
<div class="highlight-python"><pre>name "webserver"
description "The base role for systems that serve HTTP traffic"
run_list "recipe[apache2]", "recipe[apache2::mod_ssl]", "role[monitor]"
env_run_lists "prod" =&gt; ["recipe[apache2]"], "staging" =&gt; ["recipe[apache2::staging]"], "_default" =&gt; []
default_attributes "apache2" =&gt; { "listen_ports" =&gt; [ "80", "443" ] }
override_attributes "apache2" =&gt; { "max_children" =&gt; "50" }</pre>
</div>
</div>
<div class="section" id="id3">
<h5>H4 &#8211; JSON &#8211; DONE<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h5>
<p>The JSON format for environments maps directly to the domain-specific Ruby format: same settings, attributes, and values, and a similar structure and organization. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;webserver&quot;</span><span class="p">,</span>
  <span class="s">&quot;chef_type&quot;</span><span class="p">:</span> <span class="s">&quot;role&quot;</span><span class="p">,</span>
  <span class="s">&quot;json_class&quot;</span><span class="p">:</span> <span class="s">&quot;Chef::Role&quot;</span><span class="p">,</span>
  <span class="s">&quot;default_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;apache2&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;listen_ports&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s">&quot;80&quot;</span><span class="p">,</span>
        <span class="s">&quot;443&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="s">&quot;The base role for systems that serve HTTP traffic&quot;</span><span class="p">,</span>
  <span class="s">&quot;run_list&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s">&quot;recipe[apache2]&quot;</span><span class="p">,</span>
    <span class="s">&quot;recipe[apache2::mod_ssl]&quot;</span><span class="p">,</span>
    <span class="s">&quot;role[montior]&quot;</span>
  <span class="p">],</span>
  <span class="s">&quot;env_run_lists&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;production&quot;</span> <span class="p">:</span> <span class="p">[],</span>
    <span class="s">&quot;preprod&quot;</span> <span class="p">:</span> <span class="p">[],</span>
    <span class="s">&quot;dev&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">&quot;role[base]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache::copy_dev_configs]&quot;</span><span class="p">,</span>
    <span class="p">],</span>
     <span class="s">&quot;test&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s">&quot;role[base]&quot;</span><span class="p">,</span>
      <span class="s">&quot;recipe[apache]&quot;</span>
    <span class="p">]</span>
   <span class="p">},</span>
  <span class="s">&quot;override_attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s">&quot;apache2&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;max_children&quot;</span><span class="p">:</span> <span class="s">&quot;50&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The JSON format has two additional settings:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Setting</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">chef_type</span></tt></td>
<td>This should always be set to <tt class="docutils literal"><span class="pre">environment</span></tt>. Use this setting for any custom process that consumes environment objects outside of Ruby.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">json_class</span></tt></td>
<td>This should always be set to <tt class="docutils literal"><span class="pre">Chef::Environment</span></tt>. This setting is used internally by Chef to auto-inflate an environment object. If objects are being rebuilt outside of Ruby, ignore it.</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="h3-role-attributes-done">
<h4>H3 &#8211; Role Attributes &#8211; DONE<a class="headerlink" href="#h3-role-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>An attribute can be defined in a role and then used to override the default settings on a node. When a role is applied during a Chef run, these attributes are compared to the attributes that are already present on the node. When the role attributes take precedence over the default attributes, Chef will apply those new settings and values during the Chef run on the node.</p>
<p>A role attribute can only be set to be a default attribute or an override attribute. A role attribute cannot be set to be a normal attribute. Use the <tt class="docutils literal"><span class="pre">default_attribute</span></tt> and <tt class="docutils literal"><span class="pre">override_attribute</span></tt> methods in the Ruby DSL file or the <tt class="docutils literal"><span class="pre">default_attributes</span></tt> and <tt class="docutils literal"><span class="pre">override_attributes</span></tt> hashes in a JSON data file.</p>
<div class="section" id="id4">
<h5>H4 &#8211; Types &#8211; DONE<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h5>
<p>There are four types of attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default</span></tt></td>
<td>A default attribute is <strong>jamescott: &#8220;A default attribute is what?&#8221; (other than the obvious) &#8211; but what&#8217;s the difference between default an normal and how does an attribute become a &#8220;default attribute&#8221;?</strong>. A default attribute has the lowest attribute precedence. A default attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses default attributes whenever possible.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">normal</span></tt></td>
<td>A normal attribute is an attribute that persists on the target system . A normal attribute is never reset during a Chef run. A normal attribute has a higher attribute precedence than a default attribute.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override</span></tt></td>
<td>An override attribute is an attribute that is specified in a recipe (or a run-list) and are often set only for specific roles or nodes. An override attribute has a higher attribute precedence than default or normal attributes. An override attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses override attributes for role-specific or node-specific values when required.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">automatic</span></tt></td>
<td>An automatic attribute contains data that is automatically-generated by Ohai during every Chef run (all previous values are overwritten by the newly-generated values). An automatic attribute cannot be modified. An automatic attribute has the highest attribute precedence. An automatic attribute is automatically reset each time Chef runs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id5">
<h5>H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h5>
<p>During a Chef run, saved attributes are retrieved from the Chef server and are merged with the attributes on the local system. The attribute type and the source of the attribute determines which attribute values have priority over others. Attribute values are applied in the following order (from low to high priority):</p>
<ul class="simple">
<li>Default attributes applied in an attributes file</li>
<li>Default attributes applied in an environment</li>
<li>Default attributes applied in a role</li>
<li>Default attributes applied on a node directly in a recipe</li>
<li>Normal attributes applied in an attributes file</li>
<li>Normal attributes applied on a node directly in a recipe</li>
<li>Override attributes applied in an attributes file</li>
<li>Override attributes applied in a role</li>
<li>Override attributes applied in an environment</li>
<li>Override attributes applied on a node directly in a recipe</li>
<li>Automatic attributes, re-generated by Ohai during each Chef run.</li>
</ul>
</div>
<div class="section" id="id6">
<h5>H4 &#8211; Persistence &#8211; DONE<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h5>
<p>At the beginning of a Chef run, all default, override, and automatic attributes are reset. Chef rebuilds these attributes by based on attributes contained in cookbooks, recipes, roles, and environments, plus Ohai data that is collected about that node at the beginning of the Chef run. Normal attributes are never reset. During a Chef run, any new attributes that are passed to the chef-client are merged with the existing normal attributes on the node and any new settings are applied according to attribute precedence. At the conclusion of the Chef run, all default, override, and automatic attributes disappear, leaving only a collection of normal attributes that will persist until the next Chef run.</p>
<p><strong>jamescott: THIS ONE NEEDS TO BE REVIEWED. SEE http://wiki.opscode.com/display/chef/Attributes AND READ &#8220;ATTRIBUTE PERSISTENCE&#8221; AND THEN READ THE ABOVE AND PROVIDE FEEDBACK.</strong></p>
</div>
<div class="section" id="id7">
<h5>H4 &#8211; Automatic Attributes &#8211; DONE<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h5>
<p>An automatic attribute is data that must be understood, but not modified. For example, the IP address of a node, a host name, or the number of loaded kernel modules. When Chef makes changes to a system during a Chef run, automatic attributes are used to ensure that Chef does not make changes to the larger environment on which a node is running. An automatic attribute always has the highest attribute precedence. Automatic attributes are saved to the Chef server where they are indexed for search. Automatic attributes are detected by Ohai before every Chef run.</p>
</div>
<div class="section" id="id8">
<h5>H4 &#8211; Notation &#8211; DONE<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h5>
<p>Attributes are a special key-value store called a mash within the context of the Ruby DSL. A mash is just a hash where the key can be either a symbol (:key) or a string (&#8220;key&#8221;).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individuals who are new to Ruby and Chef may have an easier time using only string notation. This approach allows attributes to &#8220;be quoted&#8221; and doesn&#8217;t require learning about special cases, namespace overlap (and <tt class="docutils literal"><span class="pre">method_missing</span></tt>), character constraints, and escaping.</p>
</div>
</div>
</div>
<div class="section" id="h3-manage-roles-done">
<h4>H3 &#8211; Manage Roles &#8211; DONE<a class="headerlink" href="#h3-manage-roles-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: THIS TOPIC IS STILL A BIT OF A MESS.</strong></p>
<p>There are several ways to manage roles:</p>
<ul class="simple">
<li>Knife can be used to create, edit, view, list, tag, and delete roles.</li>
<li>The Management Console can be used to create, edit, view, list, tag, and delete roles. In addition, role attributes can be modified and roles can be moved between environments.</li>
<li>The chef-client can be used to manage role data using the command line and JSON files (that contain a hash, the elements of which are added as role attributes). In addition, the <tt class="docutils literal"><span class="pre">run_list</span></tt> setting allows roles and/or recipes to be added to the role.</li>
<li>Open Source Chef Server can be used to manage role data using the command line and JSON files (that contain a hash, the elements of which are added as role attributes). In addition, the <tt class="docutils literal"><span class="pre">run_list</span></tt> setting allows roles and/or recipes to be added to the role.</li>
<li>The Chef Server API can be used to create and manage roles directly. <strong>jamescott: what?</strong></li>
<li>The command line can also be used with JSON files and 3rd party services, such as Amazon EC2, where the JSON files can contain per-instance metadata stored in a file on-disk and then read by Chef Solo or chef-client as required. <strong>jamescott: weak statement here.</strong></li>
<li>Chef Solo does not allow roles.</li>
</ul>
<p><strong>jamescott: this needs to be sync&#8217;d up for &#8220;versions&#8221; at some point in the future, i.e. &#8220;Hosted Chef Docs&#8221; should not have the bullet about Chef Solo.</strong></p>
<p>By creating and editing files using the Ruby DSL or JSON. Role data can be dynamically generated with the Ruby DSL. Roles created and edited using files are compatible with all versions of Chef, including Chef Solo. Roles created and edited using files can be kept in version source control, which also keeps a history of what changed when. When roles are created and edited using files, they should not be managed using Knife or the Management Console, as changes will be overwritten.</p>
<p>A run-list that is associated with a role can be edited using the Management Console. The canonical source of a role&#8217;s data is stored on the Chef server, which means that keeping role data in version source control can be challenging.</p>
<p>When files are uploaded to a Chef server from a file and then edited using the Management Console, if the file is edited and uploaded again, the changes made in the Management Console will be lost. The same is true with Knife, in that if they are created and managed using Knife and then arbitrarily updated JSON and uploaded, that action will overwrite what has been done previously using Knife.</p>
<p>It is strongly recommended to keep to one process and not switch back and forth. When using [version of Chef] do [action].</p>
<div class="section" id="deleting-environments-from-a-role-s-run-list-done">
<h5>Deleting Environments from a Role&#8217;s Run-list &#8211; DONE<a class="headerlink" href="#deleting-environments-from-a-role-s-run-list-done" title="Permalink to this headline">¶</a></h5>
<p>When an environment is deleted, it will remain within a run-list for a role until it is removed from that run-list. If a new environment is created that has an identical name to an environment that was deleted, a run-list that contains an old environment name will use the new one.</p>
</div>
</div>
</div>
<div class="section" id="h2-node-objects">
<h3>H2 &#8211; Node Objects<a class="headerlink" href="#h2-node-objects" title="Permalink to this headline">¶</a></h3>
<p>For Chef, two important aspects of nodes are groups of attributes and run-lists. An attribute is a specific piece of data about the node, such as a network interface, a file system, or the number of clients that may be accepted. A run-list is an ordered list of recipes and/or roles that are run in an exact order. The run-list and node attributes comprise the node object, which is a JSON file that is stored on the Chef server and cached locally on every node by the chef-client. The chef-client ensures that the locally cached node object is up-do-date at the beginning of every Chef run and then uses the data stored in the node object while it brings the system to the desired state.</p>
<div class="section" id="h3-node-attributes-done">
<h4>H3 &#8211; Node Attributes &#8211; DONE<a class="headerlink" href="#h3-node-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>An attribute is a specific detail about a node, such as an IP address, a host name, a list of loaded kernel modules, the version(s) of available programming languages that are available, and so on. Attributes can be maintained in a variety of ways, such as by re-loading a cookbook (that contains new attributes), by using Knife, or by using JSON data. During a Chef run, a chef-client will save node attributes to the Chef server so they can be indexed for search. When a chef-client runs, all of the attributes saved on the Chef server are compared to the attributes cached on the chef-client. The chef-client will update the attributes based on attribute precedence rules that are defined for each attribute.</p>
<p>Attributes may be set on a node from the following objects:</p>
<ul class="simple">
<li>Cookbooks</li>
<li>Environments</li>
<li>Roles</li>
<li>Nodes</li>
</ul>
<p><strong>jamescott: need to make sure that each of cookbooks, environments, roles, and nodes has a section that explains the &#8220;how to set the attributes&#8221; part of this story. The five sections below should be NEUTRAL to all locations. AND THEN WHEN THEY ARE, remove them from here?</strong></p>
<p><strong>BELOW NEEDS REWRITE</strong></p>
<p>Setting Node Attributes</p>
<p>Node attributes can be set in recipes. This use of node attributes should do done when you want to calculate a derived value, or store some data on the node that should be persisted the next time Chef runs. Use the &#8220;set&#8221; method on the node.:</p>
<blockquote>
<div>node.set[&#8216;some_attribute&#8217;] = &#8220;Some Value&#8221; + &#8220;Some other value&#8221;
node.set[&#8216;some_attribute&#8217;][&#8216;sub_attribute&#8217;] = &#8220;Sub attribute Value&#8221;</div></blockquote>
<p>Attributes are applied in precedence order; node attributes are automatic and have the highest precedence. As these automatic attributes will be re-written with each Ohai run - Chef doesn&#8217;t provide any way to modify them. See Setting Attributes for more detail on the attribute types and precedences.</p>
<p><strong>ABOVE NEEDS REWRITE</strong></p>
<div class="section" id="h4-attribute-types-done">
<h5>H4 &#8211; Attribute Types &#8211; DONE<a class="headerlink" href="#h4-attribute-types-done" title="Permalink to this headline">¶</a></h5>
<p>There are four types of attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default</span></tt></td>
<td>A default attribute is <strong>jamescott: &#8220;A default attribute is what?&#8221; (other than the obvious) &#8211; but what&#8217;s the difference between default an normal and how does an attribute become a &#8220;default attribute&#8221;?</strong>. A default attribute has the lowest attribute precedence. A default attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses default attributes whenever possible.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">normal</span></tt></td>
<td>A normal attribute is an attribute that persists on the target system . A normal attribute is never reset during a Chef run. A normal attribute has a higher attribute precedence than a default attribute.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override</span></tt></td>
<td>An override attribute is an attribute that is specified in a recipe (or a run-list) and are often set only for specific roles or nodes. An override attribute has a higher attribute precedence than default or normal attributes. An override attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses override attributes for role-specific or node-specific values when required.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">automatic</span></tt></td>
<td>An automatic attribute contains data that is automatically-generated by Ohai during every Chef run (all previous values are overwritten by the newly-generated values). An automatic attribute cannot be modified. An automatic attribute has the highest attribute precedence. An automatic attribute is automatically reset each time Chef runs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-attribute-precedence-done">
<h5>H4 &#8211; Attribute Precedence &#8211; DONE<a class="headerlink" href="#h4-attribute-precedence-done" title="Permalink to this headline">¶</a></h5>
<p>During a Chef run, saved attributes are retrieved from the Chef server and are merged with the attributes on the local system. The attribute type and the source of the attribute determines which attribute values have priority over others. Attribute values are applied in the following order (from low to high priority):</p>
<ul class="simple">
<li>Default attributes applied in an attributes file</li>
<li>Default attributes applied in an environment</li>
<li>Default attributes applied in a role</li>
<li>Default attributes applied on a node directly in a recipe</li>
<li>Normal attributes applied in an attributes file</li>
<li>Normal attributes applied on a node directly in a recipe</li>
<li>Override attributes applied in an attributes file</li>
<li>Override attributes applied in a role</li>
<li>Override attributes applied in an environment</li>
<li>Override attributes applied on a node directly in a recipe</li>
<li>Automatic attributes, re-generated by Ohai during each Chef run.</li>
</ul>
</div>
<div class="section" id="h4-attribute-persistence-done">
<h5>H4 &#8211; Attribute Persistence &#8211; DONE<a class="headerlink" href="#h4-attribute-persistence-done" title="Permalink to this headline">¶</a></h5>
<p>At the beginning of a Chef run, all default, override, and automatic attributes are reset. Chef rebuilds these attributes by based on attributes contained in cookbooks, recipes, roles, and environments, plus Ohai data that is collected about that node at the beginning of the Chef run. Normal attributes are never reset. During a Chef run, any new attributes that are passed to the chef-client are merged with the existing normal attributes on the node and any new settings are applied according to attribute precedence. At the conclusion of the Chef run, all default, override, and automatic attributes disappear, leaving only a collection of normal attributes that will persist until the next Chef run.</p>
<p><strong>jamescott: THIS ONE NEEDS TO BE REVIEWED. SEE http://wiki.opscode.com/display/chef/Attributes AND READ &#8220;ATTRIBUTE PERSISTENCE&#8221; AND THEN READ THE ABOVE AND PROVIDE FEEDBACK.</strong></p>
</div>
<div class="section" id="id9">
<h5>H4 &#8211; Automatic Attributes &#8211; DONE<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h5>
<p>An automatic attribute is data that must be understood, but not modified. For example, the IP address of a node, a host name, or the number of loaded kernel modules. When Chef makes changes to a system during a Chef run, automatic attributes are used to ensure that Chef does not make changes to the larger environment on which a node is running. An automatic attribute always has the highest attribute precedence. Automatic attributes are saved to the Chef server where they are indexed for search. Automatic attributes are detected by Ohai before every Chef run.</p>
</div>
<div class="section" id="h4-attribute-notation-done">
<h5>H4 &#8211; Attribute Notation &#8211; DONE<a class="headerlink" href="#h4-attribute-notation-done" title="Permalink to this headline">¶</a></h5>
<p>Attributes are a special key-value store called a mash within the context of the Ruby DSL. A mash is just a hash where the key can be either a symbol (:key) or a string (&#8220;key&#8221;).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individuals who are new to Ruby and Chef may have an easier time using only string notation. This approach allows attributes to &#8220;be quoted&#8221; and doesn&#8217;t require learning about special cases, namespace overlap (and <tt class="docutils literal"><span class="pre">method_missing</span></tt>), character constraints, and escaping.</p>
</div>
</div>
</div>
<div class="section" id="h3-deep-merging-of-attributes-done">
<h4>H3 &#8211; Deep Merging of Attributes &#8211; DONE<a class="headerlink" href="#h3-deep-merging-of-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>Attributes are typically stored in cookbooks and recipes, roles, and environments. These attributes are rolled-up to the node level during a Chef run. For example, a recipe can store attributes using a multi-level hash or array; a group of attributes for web servers might be:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">override_attributes</span><span class="p">(</span>
  <span class="ss">:apache</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:listen_ports</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="mi">80</span> <span class="o">]</span><span class="p">,</span>
    <span class="ss">:prefork</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:startservers</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="ss">:minspareservers</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="ss">:maxspareservers</span> <span class="o">=&gt;</span> <span class="mi">40</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>But what if all of the web servers aren&#8217;t the same? What if some of the web servers required a single attribute to have a different value? You could store these settings in two locations, once just like above and once just like below:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">override_attributes</span><span class="p">(</span>
  <span class="ss">:apache</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:listen_ports</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="mi">80</span> <span class="o">]</span><span class="p">,</span>
    <span class="ss">:prefork</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:startservers</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
      <span class="ss">:minspareservers</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="ss">:maxspareservers</span> <span class="o">=&gt;</span> <span class="mi">40</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>But that is not very efficient, especially since most of them are identical. The deep merge capabilities of Chef allows attributes to be layered across recipes and cookbooks, roles, and environments. This allows an attribute to be reused across nodes, making use of default attributes set at the cookbook level, but also providing a way for certain attributes (with a higher attribute precedence) to be applied only when they are supposed to be. For example, a role named <tt class="docutils literal"><span class="pre">baseline.rb</span></tt>:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">name</span> <span class="s2">&quot;baseline&quot;</span>
<span class="n">description</span> <span class="s2">&quot;The most basic role for all configurations&quot;</span>
<span class="n">run_list</span> <span class="s2">&quot;recipe[baseline]&quot;</span>

<span class="n">override_attributes</span><span class="p">(</span>
  <span class="ss">:apache</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:listen_ports</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="mi">80</span> <span class="o">]</span><span class="p">,</span>
    <span class="ss">:prefork</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:startservers</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="ss">:minspareservers</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
      <span class="ss">:maxspareservers</span> <span class="o">=&gt;</span> <span class="mi">40</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>and then a role named <tt class="docutils literal"><span class="pre">web.rb</span></tt>:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">name</span> <span class="s2">&quot;web&quot;</span>
<span class="n">description</span> <span class="s2">&quot;Web server config&quot;</span>
<span class="n">run_list</span> <span class="s2">&quot;role[baseline]&quot;</span>

<span class="n">override_attributes</span><span class="p">(</span>
  <span class="ss">:apache</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:prefork</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:startservers</span> <span class="o">=&gt;</span> <span class="mi">30</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Both of these files are similar. They share the same structure. When an attribute is of the same type of data, such as  a hash or an array, the contents are merged. This is true even with different levels of precedence, such as default and override attributes. If the attribute is of a different data type, it is overwritten at higher levels of precedence.</p>
<p>For example, the <tt class="docutils literal"><span class="pre">web.rb</span></tt> references the <tt class="docutils literal"><span class="pre">baseline.rb</span></tt> role. The <tt class="docutils literal"><span class="pre">web.rb</span></tt> file only provides a value for one attribute: <tt class="docutils literal"><span class="pre">:startservers</span></tt>. When Chef compares these attributes, the deep merge feature will ensure that <tt class="docutils literal"><span class="pre">:startservers</span></tt> (and it&#8217;s value of <tt class="docutils literal"><span class="pre">30</span></tt>) will be applied to any node for which the <tt class="docutils literal"><span class="pre">web.rb</span></tt> attribute structure should be applied.</p>
<p>This approach will allow a recipe like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>
<span class="no">Chef</span><span class="o">::</span><span class="no">Log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;apache&#39;</span><span class="o">][</span><span class="s1">&#39;prefork&#39;</span><span class="o">].</span><span class="n">to_hash</span><span class="p">)</span>
</pre></div>
</div>
<p>and a <tt class="docutils literal"><span class="pre">run_list</span></tt> like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">run_list</span><span class="o">/</span><span class="n">web</span><span class="o">.</span><span class="n">json</span>
<span class="p">{</span>
  <span class="s2">&quot;run_list&quot;</span><span class="p">:</span> <span class="o">[</span> <span class="s2">&quot;role[web]&quot;</span> <span class="o">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>to produce results like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="o">[</span><span class="no">Tue</span><span class="p">,</span> <span class="mi">16</span> <span class="no">Aug</span> <span class="mi">2011</span> <span class="mi">14</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">26</span> <span class="o">-</span><span class="mo">0700</span><span class="o">]</span> <span class="no">INFO</span><span class="p">:</span>
         <span class="p">{</span>
           <span class="s2">&quot;startservers&quot;</span><span class="o">=&gt;</span><span class="mi">30</span><span class="p">,</span>
           <span class="s2">&quot;minspareservers&quot;</span><span class="o">=&gt;</span><span class="mi">20</span><span class="p">,</span>
           <span class="s2">&quot;maxspareservers&quot;</span><span class="o">=&gt;</span><span class="mi">40</span><span class="p">,</span>
           <span class="s2">&quot;serverlimit&quot;</span><span class="o">=&gt;</span><span class="mi">400</span><span class="p">,</span>
           <span class="s2">&quot;maxclients&quot;</span><span class="o">=&gt;</span><span class="mi">400</span><span class="p">,</span>
           <span class="s2">&quot;maxrequestsperchild&quot;</span><span class="o">=&gt;</span><span class="mi">10000</span>
         <span class="p">}</span>
</pre></div>
</div>
<p>Even though the <tt class="docutils literal"><span class="pre">web.rb</span></tt> file does not contain attributes and values for <tt class="docutils literal"><span class="pre">minspareservers</span></tt>, <tt class="docutils literal"><span class="pre">maxspareservers</span></tt>, <tt class="docutils literal"><span class="pre">serverlimit</span></tt>, <tt class="docutils literal"><span class="pre">maxclients</span></tt>, and <tt class="docutils literal"><span class="pre">maxrequestsperchild</span></tt>, the deep merge capabilities pulled them in.</p>
<p>The following sections show how the logic works for using deep merge to perform substitutions and additions of attributes.</p>
<div class="section" id="h4-substitution-done">
<h5>H4 &#8211; Substitution &#8211; DONE<a class="headerlink" href="#h4-substitution-done" title="Permalink to this headline">¶</a></h5>
<p>The following examples show how the logic works for substituting an existing string using a hash:</p>
<div class="highlight-python"><pre>role_or_environment 1 { :x =&gt; "1", :y =&gt; "2" }
+
role_or_environment 2 { :y =&gt; "3" }
=
{ :x =&gt; "1", :y =&gt; "3" }</pre>
</div>
<p>For substituting an existing boolean using a hash:</p>
<div class="highlight-python"><pre>role_or_environment 1 { :x =&gt; true, :y =&gt; false }
+
role_or_environment 2 { :y =&gt; true }
=
{ :x =&gt; true, :y =&gt; true }</pre>
</div>
<p>For substituting an existing string in an array:</p>
<div class="highlight-python"><pre>role_or_environment 1 [ "1", "2" ]
+
role_or_environment 2 [ "!merge:2", "3" ]
=
[ "1", "3" ]</pre>
</div>
<p>For substituting an array with a hash:</p>
<div class="highlight-python"><pre>role_or_environment 1 [ "1", "2", "3" ]
+
role_or_environment 2 { :x =&gt; "1" , :y =&gt; "2" }
=
{ :x =&gt; "1", :y =&gt; "3" }</pre>
</div>
<p>When items can&#8217;t be merged through substitution, the original data is overwritten.</p>
</div>
<div class="section" id="h4-addition-done">
<h5>H4 &#8211; Addition &#8211; DONE<a class="headerlink" href="#h4-addition-done" title="Permalink to this headline">¶</a></h5>
<p>The following examples show how the logic works for adding a string using a hash:</p>
<div class="highlight-python"><pre>role_or_environment 1 { :x =&gt; "1", :y =&gt; "2" }
+
role_or_environment 2 { :z =&gt; "3" }
=
{ :x =&gt; "1", :y =&gt; "2", :z =&gt; "3" }</pre>
</div>
<p>For adding a string using an array:</p>
<div class="highlight-python"><pre>role_or_environment 1 [ "1", "2" ]
+
role_or_environment 2 [ "3" ]
=
[ "1", "2", "3" ]</pre>
</div>
<p>For adding a string using a multi-level hash:</p>
<div class="highlight-python"><pre>role_or_environment 1 { :x =&gt; { :y =&gt; "2" } }
+
role_or_environment 2 { :x =&gt; { :z =&gt; "3" } }
=
{ :x =&gt; { :y =&gt; "2", :z =&gt; "3" } }</pre>
</div>
<p>For adding a string using a multi-level array:</p>
<div class="highlight-python"><pre>role_or_environment 1 [ [ 1, 2 ] ]
+
role_or_environment 2 [ [ 3 ] ]
=
[ [ 1, 2 ], [ 3 ] ]</pre>
</div>
</div>
</div>
<div class="section" id="h3-run-lists">
<h4>H3 &#8211; Run-lists<a class="headerlink" href="#h3-run-lists" title="Permalink to this headline">¶</a></h4>
<p>A run-list is an ordered list of recipes and/or roles that are run in an exact order. A run-list is always specific to the node on which it runs, though it is possible for many nodes to have run-lists that are similar or even identical. The items within a run-list are maintained using Knife and are uploaded to the Chef server and stored as part of the node object for each node. Chef always configures a node in the exact order specified by its run-list and will never run the same recipe twice.</p>
<p>A recipe is the most fundamental configuration element within the Chef environment. A recipe:</p>
<ul class="simple">
<li>Is authored using Ruby, which is a programming language designed to read and behave exactly as expected. (Ruby is a fairly simple programming language that does not require any previous programming experience.)</li>
<li>Is mostly a collection of resources in a Ruby syntax with some helper code around it</li>
<li>Must define everything that is required to configure part of a system</li>
<li>Must be stored in a cookbook</li>
<li>May be included in a recipe</li>
<li>May use the results of a search query and read the contents of a data bag (including an encrypted data bag)</li>
<li>May have a dependency on one (or more) recipes</li>
<li>May be tagged to facilitate the creation of arbitrary groupings that exist outside of the normal naming conventions an organization may have</li>
<li>Must be added to a run-list before it can be used by Chef</li>
<li>Is always executed in the same order as listed in a run-list</li>
</ul>
<p>A role is a way to define certain patterns and processes that exist across nodes in a Chef organization as belonging to a single job function. Each role consists of one (or more) attributes and a run list. Each node can have one (or more) roles assigned to it. When a role is run against a node the configuration details of that node are compared against the attributes of the role, and then the contents of that role&#8217;s run list are applied to the node&#8217;s configuration details. When a chef-client runs, it merges its own attributes and run lists with those contained within each assigned role.</p>
<div class="section" id="h4-xxxxx">
<h5>H4 &#8211; xxxxx<a class="headerlink" href="#h4-xxxxx" title="Permalink to this headline">¶</a></h5>
<p>xxxxx</p>
</div>
</div>
</div>
<div class="section" id="h2-search-done">
<h3>H2 &#8211; Search &#8211; DONE<a class="headerlink" href="#h2-search-done" title="Permalink to this headline">¶</a></h3>
<p>Search indexes allow queries to be made for any type of data that is indexed by a Chef server, including data for a chef-client, data bags (and data bag items), environments, nodes, and roles. Chef has a defined query syntax that includes search patterns like exact, wildcard, range, and fuzzy. The search engine is based on Apache Solr and is run from a Chef server. A search is a full-text query that can be done from within a recipe or by using the <tt class="docutils literal"><span class="pre">search</span></tt> sub-command in Knife.</p>
<p>Many of the examples in this section use Knife, but the search indexes and search query syntax can be used in many locations, including recipes, xxxxx, xxxxx, and xxxxx.</p>
<p><strong>jamescott: This article needs to evolve into being the definitive topic on search. including: What is search? What can be searched? How do you search? Where can search queries be located?</strong></p>
<div class="section" id="h3-search-indexes-done">
<h4>H3 &#8211; Search Indexes &#8211; DONE<a class="headerlink" href="#h3-search-indexes-done" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">search</span></tt> sub-command in Knife is used to run a search query for information that is indexed on a Chef server. The sub-command has the following syntax:</p>
<div class="highlight-python"><pre>knife search INDEX SEARCH_QUERY</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">INDEX</span></tt> is one of <tt class="docutils literal"><span class="pre">client</span></tt>, <tt class="docutils literal"><span class="pre">environment</span></tt>, <tt class="docutils literal"><span class="pre">node</span></tt>, <tt class="docutils literal"><span class="pre">role</span></tt>, or the name of a data bag and SEARCH_QUERY is the search query syntax for the query that will be executed.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Search Target</th>
<th class="head">Knife Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>chef-client</td>
<td><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">search</span> <span class="pre">client</span> <span class="pre">&quot;key:search_pattern&quot;</span></tt></td>
</tr>
<tr class="row-odd"><td>Data bag</td>
<td><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">search</span> <span class="pre">name_of_data_bag</span> <span class="pre">&quot;key:search_pattern&quot;</span></tt></td>
</tr>
<tr class="row-even"><td>Environment</td>
<td><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">search</span> <span class="pre">environment</span> <span class="pre">&quot;key:search_pattern&quot;</span></tt></td>
</tr>
<tr class="row-odd"><td>Node</td>
<td><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">search</span> <span class="pre">node</span> <span class="pre">&quot;key:search_pattern&quot;</span></tt></td>
</tr>
<tr class="row-even"><td>Role</td>
<td><tt class="docutils literal"><span class="pre">knife</span> <span class="pre">search</span> <span class="pre">role</span> <span class="pre">&quot;key:search_pattern&quot;</span></tt></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-search-query-syntax-done">
<h4>H3 &#8211; Search Query Syntax &#8211; DONE<a class="headerlink" href="#h3-search-query-syntax-done" title="Permalink to this headline">¶</a></h4>
<p>A search query has the following syntax:</p>
<div class="highlight-python"><pre>key:search_pattern</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">key</span></tt> is a field name that is found in the JSON description of an indexable object on the Chef server (a role, node, client, environment, or data bag) and <tt class="docutils literal"><span class="pre">search_pattern</span></tt> defines what will be searched for, using one of the following search patterns: exact, wildcard, range, or fuzzy matching. Both <tt class="docutils literal"><span class="pre">key</span></tt> and <tt class="docutils literal"><span class="pre">search_pattern</span></tt> are case-sensitive; <tt class="docutils literal"><span class="pre">key</span></tt> has limited support for multiple character wildcard matching using an asterisk (*) (and as long as it is not the first character).</p>
</div>
<div class="section" id="h3-keys-or-field-names-done">
<h4>H3 &#8211; Keys (or Field Names) &#8211; DONE<a class="headerlink" href="#h3-keys-or-field-names-done" title="Permalink to this headline">¶</a></h4>
<p>A key (or field name) is located in the JSON description for the Chef object that is to be searched. Any key that exists in any JSON description for any role, node, chef-client, environment, or data bag can be searched for. To search for the available keys for a particular object, use the <tt class="docutils literal"><span class="pre">show</span></tt> sub-commands for any of the following Knife sub-commands: <tt class="docutils literal"><span class="pre">client</span></tt>, <tt class="docutils literal"><span class="pre">data</span> <span class="pre">bag</span></tt>, <tt class="docutils literal"><span class="pre">environment</span></tt>, <tt class="docutils literal"><span class="pre">node</span></tt>, or <tt class="docutils literal"><span class="pre">role</span></tt>.</p>
<p>To see the available keys for a node, enter the following (for a node named &#8220;staging&#8221;):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife node show staging -Fj | less
</pre></div>
</div>
<p>to return a full JSON description of the node and to view the available keys with which any search query can be based.</p>
<p>To use a question mark(&#8221;?&#8221;) to replace a single character in a wildcard search, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;platfor?:ubuntu&#39;</span>
</pre></div>
</div>
<p>To use an asterisk (&#8220;*&#8221;) to replace zero (or more) characters in a wildcard search, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;platfo*:ubuntu&#39;</span>
</pre></div>
</div>
<p>Nested Fields:</p>
<p>A nested key is a key that appears deeper in the JSON data structure. For example, information about a network interface might be several layers deep: <tt class="docutils literal"><span class="pre">node[:network][:interfaces][:en1]</span></tt>. When nested keys are present in a JSON structure, Chef will extract those nested fields to the top-level, flattening them into compound keys that support wildcards.</p>
<p>By combining wildcards with range matching patterns and wildcard queries, it is possible to perform very powerful searches such as using the vendor part of the MAC address to find every node that has a network card made by the specified vendor.</p>
<p>Consider the following snippet of JSON data:</p>
<div class="highlight-python"><pre>{"network":
  [
  //snipped...
    "interfaces",
      {"en1": {
        "number": "1",
        "flags": [
          "UP",
          "BROADCAST",
          "SMART",
          "RUNNING",
          "SIMPLEX",
          "MULTICAST"
        ],
        "addresses": {
          "fe80::fa1e:dfff:fed8:63a2": {
            "scope": "Link",
            "prefixlen": "64",
            "family": "inet6"
          },
          "f8:1e:df:d8:63:a2": {
            "family": "lladdr"
          },
          "192.168.0.195": {
            "netmask": "255.255.255.0",
            "broadcast": "192.168.0.255",
            "family": "inet"
          }
        },
        "mtu": "1500",
        "media": {
          "supported": {
            "autoselect": {
              "options": [

              ]
            }
          },
          "selected": {
            "autoselect": {
              "options": [

              ]
            }
          }
        },
        "type": "en",
        "status": "active",
        "encapsulation": "Ethernet"
      },
  //snipped...</pre>
</div>
<p>Before this data is indexed on the Chef server, the nested fields are extracted into the top level, similar to:</p>
<div class="highlight-python"><pre>"broadcast" =&gt; "192.168.0.255",
"flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"mtu"       =&gt; "1500"</pre>
</div>
<p>This allows searches like the following to find data that is present in this node:</p>
<div class="highlight-python"><pre>knife search node "broadcast:192.168.0.*"</pre>
</div>
<p>Or:</p>
<div class="highlight-python"><pre>knife search node "mtu:1500"</pre>
</div>
<p>Or:</p>
<div class="highlight-python"><pre>knife search node "flags:UP"</pre>
</div>
<p>This data is also flattened into various compound keys, which follow the same pattern as the JSON hierarchy and use underscores (&#8220;_&#8221;) to separate the levels of data, similar to:</p>
<div class="highlight-python"><pre># ...snip...
"network_interfaces_en1_addresses_192.168.0.195_broadcast" =&gt; "192.168.0.255",
"network_interfaces_en1_addresses_fe80::fa1e:tldr_family"  =&gt; "inet6",
"network_interfaces_en1_addresses"                         =&gt; ["fe80::fa1e:tldr","f8:1e:df:tldr","192.168.0.195"]
# ...snip...</pre>
</div>
<p>This allows searches like the following to find data that is present in this node:</p>
<div class="highlight-python"><pre>knife search node "network_interfaces_en1_addresses:192.168.0.195"</pre>
</div>
<p>This flattened data structure also supports using wildcard compound keys, which allow searches to omit levels within the JSON data structure that are not important to the search query. In the following example, an asterisk (&#8220;*&#8221;) is used to show where the wildcard can exist when searching for nested key:</p>
<div class="highlight-python"><pre>"network_interfaces_*_flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"network_interfaces_*_addresses" =&gt; ["fe80::fa1e:dfff:fed8:63a2", "192.168.0.195", "f8:1e:df:d8:63:a2"]
"network_interfaces_en0_media_*" =&gt; ["autoselect", "none", "1000baseT", "10baseT/UTP", "100baseTX"]
"network_interfaces_en1_*"       =&gt; ["1", "UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST",
                                     "fe80::fa1e:dfff:fed8:63a2", "f8:1e:df:d8:63:a2", "192.168.0.195",
                                     "1500", "supported", "selected", "en", "active", "Ethernet"]</pre>
</div>
<p>For each of the wildcard examples above, the possible values are shown contained within the brackets. When running a search query, the query syntax for wildcards is to simply omit the name of the node (while preserving the underscores), like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">network_interfaces__flags</span>
</pre></div>
</div>
<p>This query will search within the <tt class="docutils literal"><span class="pre">flags</span></tt> node within the JSON structure for each of <tt class="docutils literal"><span class="pre">UP</span></tt>, <tt class="docutils literal"><span class="pre">BROADCAST</span></tt>, <tt class="docutils literal"><span class="pre">SMART</span></tt>, <tt class="docutils literal"><span class="pre">RUNNING</span></tt>, <tt class="docutils literal"><span class="pre">SIMPLEX</span></tt>, and <tt class="docutils literal"><span class="pre">MULTICAST</span></tt>.</p>
<p>To find all IP address that are on the same network, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;network_interfaces__addresses:192.168*&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">192.168*</span></tt> is the network address for which the search will be run.</p>
<p>To use a range search to find IP addresses within a subnet, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;network_interfaces_X_addresses:[192.168.0.* TO 192.168.127.*]&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">192.168.0.*</span> <span class="pre">TO</span> <span class="pre">192.168.127.*</span></tt> defines the subnet range.</p>
</div>
<div class="section" id="h3-search-patterns-done">
<h4>H3 &#8211; Search Patterns &#8211; DONE<a class="headerlink" href="#h3-search-patterns-done" title="Permalink to this headline">¶</a></h4>
<p>There are four types of search patterns: exact, wildcard, range, and fuzzy.</p>
<div class="section" id="h4-exact-matching-done">
<h5>H4 &#8211; Exact Matching &#8211; DONE<a class="headerlink" href="#h4-exact-matching-done" title="Permalink to this headline">¶</a></h5>
<p>An exact matching search pattern is used to search for a key with a name that exactly matches a search query. If the name of the key contains spaces, quotes must be used in the search pattern to ensure the search query finds the key. The entire query must also be contained within quotes, so as to prevent it from being interpreted by Ruby or a command shell. The best way to ensure that quotes are used consistently is to quote the entire query using single quotes (&#8216; &#8216;) and a search pattern with double quotes (&#8221; &#8221;).</p>
<p>To search in a specific data bag for a specific data bag item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admins <span class="s1">&#39;id:charlie&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">id</span></tt> is the name of the data bag and <tt class="docutils literal"><span class="pre">charlie</span></tt> is the name of the data bag item. Something like the following will be returned:</p>
<div class="highlight-bash"><div class="highlight"><pre>1 items found
_rev:       1-39ff4099f2510f477b4c26bef81f75b9
chef_type:  data_bag_item
comment:    Charlie the Unicorn
data_bag:   admins
gid:        ops
id:         charlie
shell:      /bin/zsh
uid:        1005
</pre></div>
</div>
<p>To search in a specific data bag using a string to find any matching data bag item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admins <span class="s1">&#39;comment:&quot;Charlie the Unicorn&quot;&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">comment</span></tt> is the name of the data bag and <tt class="docutils literal"><span class="pre">Charlie</span> <span class="pre">the</span> <span class="pre">Unicorn</span></tt> is the string that will be used during the search. Something like the following will be returned:</p>
<div class="highlight-bash"><div class="highlight"><pre>1 items found
_rev:       1-39ff4099f2510f477b4c26bef81f75b9
chef_type:  data_bag_item
comment:    Charlie the Unicorn
data_bag:   admins
gid:        ops
id:         charlie
shell:      /bin/zsh
uid:        1005
</pre></div>
</div>
</div>
<div class="section" id="h4-wildcard-matching-done">
<h5>H4 &#8211; Wildcard Matching &#8211; DONE<a class="headerlink" href="#h4-wildcard-matching-done" title="Permalink to this headline">¶</a></h5>
<p>A wildcard matching search pattern is used to query for substring matches that replace zero (or more) characters in the search pattern with anything that could match the replaced character. There are two types of wildcard searches:</p>
<ul class="simple">
<li>A question mark (&#8221;?&#8221;) can be used to replace exactly one character (as long as that character is not the first character in the search pattern)</li>
<li>An asterisk (&#8220;*&#8221;) can be used to replace any number of characters (including zero)</li>
</ul>
<p>To search for any node that contains the specified key, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;foo:*&#39;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">foo</span></tt> is the name of the node.</p>
<p>To search for a node using a partial name, enter one of the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;name:app*&#39;</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;name:app1*.example.com&#39;</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;name:app?.example.com&#39;</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node <span class="s1">&#39;name:app1.example.???&#39;</span>
</pre></div>
</div>
<p>to return &#8220;app1.example.com&#8221; (and any other node that matches any of the string searches above).</p>
</div>
<div class="section" id="h4-range-matching-done">
<h5>H4 &#8211; Range Matching &#8211; DONE<a class="headerlink" href="#h4-range-matching-done" title="Permalink to this headline">¶</a></h5>
<p>A range matching search pattern is used to query for values that are within a range defined by upper and lower boundaries. A range matching search pattern can be inclusive or exclusive of the boundaries. Use square brackets (&#8220;[ ]&#8221;) to denote inclusive boundaries and curly braces (&#8220;{ }&#8221;) to denote exclusive boundaries and with the following syntax:</p>
<div class="highlight-python"><pre>boundary TO boundary</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">TO</span></tt> is required (and must be capitalized).</p>
<p>A data bag named &#8220;sample&#8221; contains four data bag items: &#8220;abc&#8221;, &#8220;bar&#8221;, &#8220;baz&#8221;, and &#8220;quz&#8221;. All of the items in-between &#8220;bar&#8221; and &#8220;foo&#8221;, inclusive, can be searched for using an inclusive search pattern.</p>
<p>To search using an inclusive range, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search sample <span class="s2">&quot;id:[bar TO foo]&quot;</span>
</pre></div>
</div>
<p>where square brackets (&#8220;[ ]&#8221;) are used to define the range.</p>
<p>A data bag named &#8220;sample&#8221; contains four data bag items: &#8220;abc&#8221;, &#8220;bar&#8221;, &#8220;baz&#8221;, and &#8220;quz&#8221;. All of the items that are exclusive to &#8220;bar&#8221; and &#8220;foo&#8221; can be searched for using an exclusive search pattern.</p>
<p>To search using an exclusive range, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search sample <span class="s2">&quot;id:{bar TO foo}&quot;</span>
</pre></div>
</div>
<p>where curly braces (&#8220;{ }&#8221;) are used to define the range.</p>
</div>
<div class="section" id="h4-fuzzy-matching-done">
<h5>H4 &#8211; Fuzzy Matching &#8211; DONE<a class="headerlink" href="#h4-fuzzy-matching-done" title="Permalink to this headline">¶</a></h5>
<p>A fuzzy matching search pattern is used to search based on the proximity of two strings of characters. An (optional) integer may be used as part of the search query to more closely define the proximity. A fuzzy matching search pattern has the following syntax:</p>
<div class="highlight-python"><pre>"search_query"~edit_distance</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">search_query</span></tt> is the string that will be used during the search and <tt class="docutils literal"><span class="pre">edit_distance</span></tt> is the proximity. A tilde (&#8220;~&#8221;) is used to separate the edit distance from the search query.</p>
<p>To search, using fuzzy results, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search client <span class="s2">&quot;name:boo~&quot;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">boo~</span></tt> defines the fuzzy search pattern. Something like the following will be returned:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
  <span class="s2">&quot;total&quot;</span>: 1,
  <span class="s2">&quot;start&quot;</span>: 0,
  <span class="s2">&quot;rows&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;public_key&quot;</span>: <span class="s2">&quot;too long didn&#39;t read&quot;</span>,
      <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;foo&quot;</span>,
      <span class="s2">&quot;_rev&quot;</span>: <span class="s2">&quot;1-f11a58043906e33d39a686e9b58cd92f&quot;</span>,
      <span class="s2">&quot;json_class&quot;</span>: <span class="s2">&quot;Chef::ApiClient&quot;</span>,
      <span class="s2">&quot;admin&quot;</span>: <span class="nb">false</span>,
      <span class="s2">&quot;chef_type&quot;</span>: <span class="s2">&quot;client&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="h3-boolean-operators-done">
<h4>H3 &#8211; Boolean Operators &#8211; DONE<a class="headerlink" href="#h3-boolean-operators-done" title="Permalink to this headline">¶</a></h4>
<p>A Boolean operator can be used to make a search query more specific by ensuring that certain terms are included in the results, excluded from the results, or not included even when other aspects of the query match:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Boolean Operator</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">AND</span></tt></td>
<td>Use to find a match when both terms exist.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">OR</span></tt></td>
<td>Use to find a match if either term exists.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">NOT</span></tt></td>
<td>Use to exclude the term after NOT from the search results.</td>
</tr>
</tbody>
</table>
<p>Boolean operators must be in ALL CAPS. Parentheses can be used to group clauses and to form sub-queries.</p>
<p>To negate search results using the NOT boolean operator, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search sample <span class="s2">&quot;(NOT id:foo)&quot;</span>
</pre></div>
</div>
<p>to return something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
  <span class="s2">&quot;total&quot;</span>: 4,
  <span class="s2">&quot;start&quot;</span>: 0,
  <span class="s2">&quot;rows&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named bar&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;bar&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;cat&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named baz&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;baz&quot;</span>
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;dog&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named abc&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;abc&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;unicorn&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named qux&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;qux&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>, <span class="s2">&quot;penguin&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To join queries using the OR boolean operator, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search sample <span class="s2">&quot;id:foo OR id:abc&quot;</span>
</pre></div>
</div>
<p>to return something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
  <span class="s2">&quot;total&quot;</span>: 2,
  <span class="s2">&quot;start&quot;</span>: 0,
  <span class="s2">&quot;rows&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named foo&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;foo&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;pony&quot;</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named abc&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;abc&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;unicorn&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>To join queries using the AND boolean operator, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search sample <span class="s2">&quot;id:b* AND animal:dog&quot;</span>
</pre></div>
</div>
<p>to return something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
  <span class="s2">&quot;total&quot;</span>: 1,
  <span class="s2">&quot;start&quot;</span>: 0,
  <span class="s2">&quot;rows&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;comment&quot;</span>: <span class="s2">&quot;an item named baz&quot;</span>,
      <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;baz&quot;</span>,
      <span class="s2">&quot;animal&quot;</span>: <span class="s2">&quot;dog&quot;</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-special-characters-done">
<h4>H3 &#8211; Special Characters &#8211; DONE<a class="headerlink" href="#h3-special-characters-done" title="Permalink to this headline">¶</a></h4>
<p>The following characters can be included as part of the search query syntax, but must be escaped with a backslash ():</p>
<div class="highlight-python"><pre>+  -  &amp;&amp;  | |  !  ( )  { }  [ ]  ^  "  ~  *  ?  :  \</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>\(1\+1\)\:2</pre>
</div>
</div>
<div class="section" id="h3-search-targets-done">
<h4>H3 &#8211; Search Targets &#8211; DONE<a class="headerlink" href="#h3-search-targets-done" title="Permalink to this headline">¶</a></h4>
<p>Searches can be made against roles (in run-lists), nodes, clients, environments, and data bags.</p>
<div class="section" id="h4-roles-in-run-lists-done">
<h5>H4 &#8211; Roles in Run-lists: &#8211; DONE<a class="headerlink" href="#h4-roles-in-run-lists-done" title="Permalink to this headline">¶</a></h5>
<p>A search query can be made for roles that are at the top-level of a run-list and also for a role that is part of an expanded run-list.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">roles</span></tt> field is updated each time the chef-client is run; changes to a run-list will not affect <tt class="docutils literal"><span class="pre">roles</span></tt> until the next time the chef-client is run on the node.</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Role Location</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Top-level</td>
<td><p class="first">To find a node with a role in the top-level of its run-list, search within the <tt class="docutils literal"><span class="pre">role</span></tt> field (and escaping any special characters with the slash symbol) using the following syntax:</p>
<div class="highlight-python"><pre>role:ROLE_NAME</pre>
</div>
<p class="last">where <tt class="docutils literal"><span class="pre">role</span></tt> (singlular!) indicates the top-level run-list.</p>
</td>
</tr>
<tr class="row-odd"><td>Expanded</td>
<td><p class="first">To find a node with a role in an expanded run-list, search within the <tt class="docutils literal"><span class="pre">roles</span></tt> field (and escaping any special characters with the slash symbol) using the following syntax:</p>
<div class="highlight-python"><pre>roles:ROLE_NAME</pre>
</div>
<p class="last">where <tt class="docutils literal"><span class="pre">roles</span></tt> (plural!) indicates the expanded run-list.</p>
</td>
</tr>
</tbody>
</table>
<p>To search a top-level run list for a role named &#8220;load_balancer&#8221;, enter the following (from Knife):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search node role:load_balancer
</pre></div>
</div>
<p>or add the following (to a recipe):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s1">&#39;role:load_balancer&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To search an expanded run list for all nodes with the role &#8220;load_balancer&#8221;, enter the following (using Knife):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ $ </span>knife search node roles:load_balancer
</pre></div>
</div>
<p>or add the following (to a recipe):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">search</span><span class="p">(</span><span class="ss">:node</span><span class="p">,</span> <span class="s1">&#39;roles:load_balancer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-nodes-done">
<h5>H4 &#8211; Nodes: &#8211; DONE<a class="headerlink" href="#h4-nodes-done" title="Permalink to this headline">¶</a></h5>
<p>A node can be searched from a recipe by using the following syntax:</p>
<div class="highlight-python"><pre>search(:node, "key:attribute")</pre>
</div>
<p>A wildcard can be used to replace characters within the search query.</p>
<p>Chef saves expanded lists of roles (all of the roles that apply to a node, including nested roles) and recipes to the role and recipe attributes on a node. This allows searching within nodes that run a given recipe, even if that recipe is included by a role.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <tt class="docutils literal"><span class="pre">recipes</span></tt> field is updated each time the chef-client is run; changes to a run-list will not affect <tt class="docutils literal"><span class="pre">recipes</span></tt> until the next time the chef-client is run on the node.</p>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Node Location</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>In a specified recipe</td>
<td><p class="first">To find a node with a specified recipe in the run-list, search within the <tt class="docutils literal"><span class="pre">run_list</span></tt> field (and escaping any special characters with the slash symbol) using the following syntax:</p>
<div class="highlight-python"><pre>search(:node, 'run_list:recipe\[foo\:\:bar\]')</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">recipe</span></tt> (singular!) indicates the top-level run-list. Variables can be interpolated into search strings using the Ruby alternate quoting syntax:</p>
<div class="last highlight-python"><pre>search(:node, %Q{run_list:"recipe[#{the_recipe}]"} )</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td>In an expanded run-list</td>
<td><p class="first">To find a node with a recipe in an expanded run-list, search within the <tt class="docutils literal"><span class="pre">recipes</span></tt> field (and escaping any special characters with the slash symbol) using the following syntax:</p>
<div class="highlight-python"><pre>recipes:RECIPE_NAME</pre>
</div>
<p class="last">where <tt class="docutils literal"><span class="pre">recipes</span></tt> (plural!) indicates to search within an expanded run-list.</p>
</td>
</tr>
</tbody>
</table>
<p>If you just want to use each result of the search and don&#8217;t care about the aggregate result you can provide a code block to the search method. Each result will be passed to the block in turn:</p>
<div class="highlight-python"><pre># Print every node matching the search pattern
search(:node, "*:*") do |matching_node|
  puts matching_node.to_s
end</pre>
</div>
</div>
<div class="section" id="h4-clients-done">
<h5>H4 &#8211; Clients: &#8211; DONE<a class="headerlink" href="#h4-clients-done" title="Permalink to this headline">¶</a></h5>
<p><strong>jamescott: need to check this for chef-client vs. NODE issues</strong></p>
<p>A chef-client is an agent that runs locally on every node that is registered with the Chef server. When a chef-client is run, it will perform all of the steps that are required to bring the node into the expected state, including:</p>
<ul class="simple">
<li>Building, registering, and authenticating the node with the Chef server</li>
<li>Synchronizing each required cookbook with the local file cache</li>
<li>Compiling the resource collection by loading each of the required cookbooks, including recipes, attributes, and all other dependencies</li>
<li>Taking the appropriate and required actions to configure the node</li>
<li>Looking for exceptions and notifications, handling each as required</li>
</ul>
<p>Sometimes when a role isn&#8217;t fully defined (or implemented), it may be necessary for a machine to connect to a database, search engine, or some other service within an environment by using the settings located on another machine, such as a host name, IP address, or private IP address. The following simplified settings file is for a web server named &#8220;mysqlchef&#8221; and a database server named mysqlchefutil:</p>
<div class="highlight-python"><pre>username: "mysql"
password: "MoveAlong"
host:     "10.40.64.202"
port:     "3306"</pre>
</div>
<p>where <tt class="docutils literal"><span class="pre">host</span></tt> is the private IP address of the database server. Use the following Knife query to view information about the node:</p>
<p>To access these settings as part of a recipe that is run on the web server, do something similar to:</p>
<div class="highlight-python"><pre>db_server = search(:node, "name:mysqlchefutil")
private_ip = "#{db_server[0][:rackspace][:private_ip]}"
puts private_ip</pre>
</div>
<p>where the &#8220;[0]&#8221; is the 0 (zero) index for the db_server identifier. This is because a single document is returned because the node is being searched on its unique name. The identifier <tt class="docutils literal"><span class="pre">private_ip</span></tt> will now have the value of the private IP address of the database server (<tt class="docutils literal"><span class="pre">10.40.64.202</span></tt>) and can be used in templates as a variable, among other possible uses.</p>
</div>
<div class="section" id="id10">
<h5>H4 &#8211; Environments: &#8211; DONE<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h5>
<p>An environment is a way to map an organization&#8217;s real-life workflow to what can be configured and managed when using Chef server. Every Chef organization begins with a single environment called the <tt class="docutils literal"><span class="pre">_default</span></tt> environment, which cannot be modified (or deleted). Additional environments can be created, such as production, staging, testing, and development. Generally, an environment is also associated with one (or more) cookbook versions.</p>
<p>When searching, a Chef environment (<tt class="docutils literal"><span class="pre">chef_environment</span></tt>) is treated much like an attribute. This allows search results to be limited to a specified environment by using Boolean operators and extra search terms. For example, to use Knife to search for all of the servers running CentOS in an environment named &#8220;QA&#8221;, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>knife search node <span class="s2">&quot;chef_environment:QA AND platform:centos&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search in a recipe, use a code block similar to:</p>
<div class="highlight-python"><pre>qa_nodes = search(:node,"chef_environment:QA")
qa_nodes.each do |qa_node|
    # Do useful specific to qa nodes only
end</pre>
</div>
</div>
<div class="section" id="id11">
<h5>H4 &#8211; Data Bags: &#8211; DONE<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h5>
<p>A data bag is a read-only global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords). The contents of a data bag can also be encrypted to prevent the contents of that data bag from being compromised.</p>
<p>Any search for a data bag (or a data bag item) must specify the name of the data bag and then provide the search query string that will be used during the search. For example, to use Knife to search within a data bag named &#8220;admin_data&#8221; across all items, except for the &#8220;admin_users&#8221; item, enter the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife search admin_data <span class="s2">&quot;(NOT id:admin_users)&quot;</span>
</pre></div>
</div>
<p>Or, to include the same search query in a recipe, use a code block similar to (<strong>jamescott: the following code sample is probably wrong</strong>):</p>
<div class="highlight-python"><pre>search(:admin_data, "NOT id:admin_users")</pre>
</div>
<p>It may not be possible to know which data bag items will be needed. It may be necessary to load everything in a data bag (but not know what &#8220;everything&#8221; is). Using a search query is the ideal way to deal with that ambiguity, yet still ensure that all of the required data is returned. The following examples show how a recipe can use a series of search queries to search within a data bag named &#8220;admins&#8221;. For example, to find every administrator:</p>
<div class="highlight-python"><pre>search(:admins, "*:*")</pre>
</div>
<p>Or to search for an administrator named &#8220;charlie&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:charlie")</pre>
</div>
<p>Or to search for an administrator with a group identifier of &#8220;ops&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "gid:ops")</pre>
</div>
<p>Or to search for an administrator whose name begins with the letter &#8220;c&#8221;:</p>
<div class="highlight-python"><pre>search(:admins, "id:c*")</pre>
</div>
<p>Data bag items that are returned by a search query can be used as if they were a hash. For example:</p>
<div class="highlight-python"><pre>charlie = search(:admins, "id:charlie").first
# =&gt; variable 'charlie' is set to the charlie data bag item
charlie["gid"]
# =&gt; "ops"
charlie["shell"]
# =&gt; "/bin/zsh"</pre>
</div>
<p>The following recipe can be used to create a user for each administrator by loading all of the items from the &#8220;admins&#8221; data bag, looping through each admin in the data bag, and then creating a user resource so that each of those admins exist:</p>
<div class="highlight-python"><pre>admins = data_bag('admins')

admins.each do |login|
  admin = data_bag_item('admins', login)
  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']
    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
<p>And then the same recipe, modified to load administrators using a search query (and using an array to store the results of the search query):</p>
<div class="highlight-python"><pre>admins = []

search(:admins, "*:*") do |admin|
  login = admin["id"]

  admins &lt;&lt; login

  home = "/home/#{login}"

  user(login) do
    uid       admin['uid']
    gid       admin['gid']
    shell     admin['shell']
    comment   admin['comment']

    home      home
    supports  :manage_home =&gt; true
  end

end</pre>
</div>
</div>
</div>
</div>
<div class="section" id="h2-cookbooks-uploaded-placeholder">
<h3>H2 &#8211; Cookbooks (Uploaded) &#8211; PLACEHOLDER<a class="headerlink" href="#h2-cookbooks-uploaded-placeholder" title="Permalink to this headline">¶</a></h3>
<p>../../includes/includes_chef_node_cookbook_cached.rst</p>
<p><strong>jamescott: We need to say something about the fact that the cookbooks are uploaded to the Chef server and are then (from there) propagated across nodes when and where required (and cached on each of the nodes, refreshed as required).</strong></p>
<p>THIS IS THE TOPIC THAT NEEDS TO BE ABOUT THE FOLLOWING:</p>
<ul class="simple">
<li>HOW COOKBOOKS GET TO THE SERVER</li>
<li>WHAT HAPPENS TO COOKBOOKS ONCE THEY ARE THERE</li>
<li>ETC.</li>
</ul>
</div>
<div class="section" id="h2-manager-management-console-done">
<h3>H2 &#8211; Manager (Management Console) &#8211; DONE<a class="headerlink" href="#h2-manager-management-console-done" title="Permalink to this headline">¶</a></h3>
<p>The Chef manager is a web-based interface that provides users of Chef a way to manage the following:</p>
<ul class="simple">
<li>Nodes</li>
<li>Cookbooks and recipes</li>
<li>Roles</li>
<li>Stores of JSON data (data bags), including encrypted data</li>
<li>Environments</li>
<li>Searching of indexed data on the Chef server</li>
<li>User accounts and user data for the individuals who have permission to log on to and access the Chef server</li>
</ul>
<p><strong>jamescott: My understanding is that the Chef 11 UI may be different and that I am going to wait until I see it to re-do that specific part of the helpz.</strong></p>
</div>
</div>
<div class="section" id="h1-cookbooks">
<h2>H1 &#8211; Cookbooks<a class="headerlink" href="#h1-cookbooks" title="Permalink to this headline">¶</a></h2>
<p>A cookbook is the fundamental unit of distribution across Chef organizations. Each cookbook defines an automation scenario and then contains all of the components that are required to run it, including:</p>
<ul class="simple">
<li>Attributes that set values on nodes</li>
<li>Definitions that allow the creation of reusable collections of resources</li>
<li>File distributions</li>
<li>Libraries that extend Chef and/or provide helpers to Ruby code</li>
<li>Recipes that specify which resources to manage and the order in which those resources will be applied.</li>
<li>Custom resources and providers</li>
<li>Templates</li>
<li>Metadata about recipes (including dependencies), version constraints, supported platforms, and so on</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A cookbook includes a readme file that is used to xxxxx.</p>
</div>
<div class="section" id="h2-cookbooks-directory-structure-done">
<h3>H2 &#8211; Cookbooks Directory Structure &#8211; DONE<a class="headerlink" href="#h2-cookbooks-directory-structure-done" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">cookbooks/</span></tt> directory is used to store the cookbooks that are used by Chef when configuring the various systems in the organization. This directory contains the cookbooks that are used to configure systems in the infrastructure with Chef. Each cookbook can be configured to contain cookbook-specific copyright, email, and license data.</p>
</div>
<div class="section" id="h2-cookbook-attributes-done">
<h3>H2 &#8211; Cookbook Attributes &#8211; DONE<a class="headerlink" href="#h2-cookbook-attributes-done" title="Permalink to this headline">¶</a></h3>
<p>An attribute can be defined in a cookbook (or a recipe) and then used to override the default settings on a node. When a cookbook is loaded during a Chef run, these attributes are compared to the attributes that are already present on the node. When the cookbook attributes take precedence over the default attributes, Chef will apply those new settings and values during the Chef run on the node.</p>
<div class="section" id="h3-when-to-use-attributes-done">
<h4>H3 &#8211; When to Use Attributes &#8211; DONE<a class="headerlink" href="#h3-when-to-use-attributes-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: TECHNICALLY NOT DONE HERE. SHOULD HAVE SUBTOPIC HERE FOR EACH TYPE, NO?</strong>
An attribute is a specific detail about a node, such as an IP address, a host name, a list of loaded kernel modules, the version(s) of available programming languages that are available, and so on. An attribute may be unique to a specific node or it can be identical across every node in the organization. Attributes are most commonly set from a cookbook, by using Knife, or are retrieved by Ohai from each node prior to every Chef run. All attributes are indexed for search on the Chef server. Good candidates for attributes include:</p>
<ul class="simple">
<li>any cross-platform abstraction for an application, such as the path to a configuration file,</li>
<li>default values for tunable settings, such as the amount of memory assigned to a process or the number of workers to spawn,</li>
<li>anything that may need to be persisted in node data between Chef runs.</li>
</ul>
<p>In general, attribute precedence is set to enable cookbooks and roles to define attribute defaults, for normal attributes to define the values that should be specific for a node, and for override attributes to force a certain value, even when a node already has that value specified.</p>
<p>One approach is to set attributes at the same precedence level by setting attributes in a cookbook&#8217;s attribute files, and then also setting the same default attributes (but with different values) using a role. The attributes set in the role will be deep merged on top of the attributes from the attribute file and the attributes set by the role will take precedence over the attributes specified in the cookbook&#8217;s attribute files.</p>
<p>Another (much less common) approach is to set a value only if an attribute has no value. This can be done by using the <tt class="docutils literal"><span class="pre">_unless</span></tt> variants of the attribute priority methods: <tt class="docutils literal"><span class="pre">default_unless</span></tt>, <tt class="docutils literal"><span class="pre">set_unless</span></tt>, and <tt class="docutils literal"><span class="pre">override_unless</span></tt>. These variants should be use carefully because when they are used the attributes applied to nodes may become out of sync with the values in the cookbooks as these cookbooks are updated. This can create situations where two otherwise identical nodes end up having slightly different configurations. This can be a challenge to debug, so use the <tt class="docutils literal"><span class="pre">_unless</span></tt> variants carefully (and only when they are really necessary).</p>
<div class="section" id="h4-node-environment-role-and-attribute-file">
<h5>H4 &#8211; NODE, ENVIRONMENT, ROLE, and ATTRIBUTE FILE<a class="headerlink" href="#h4-node-environment-role-and-attribute-file" title="Permalink to this headline">¶</a></h5>
<p>NO TOPIC, BUT CONSIDER THIS.</p>
</div>
</div>
<div class="section" id="types-done">
<h4>Types &#8211; DONE<a class="headerlink" href="#types-done" title="Permalink to this headline">¶</a></h4>
<p>There are four types of attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default</span></tt></td>
<td>A default attribute is <strong>jamescott: &#8220;A default attribute is what?&#8221; (other than the obvious) &#8211; but what&#8217;s the difference between default an normal and how does an attribute become a &#8220;default attribute&#8221;?</strong>. A default attribute has the lowest attribute precedence. A default attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses default attributes whenever possible.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">normal</span></tt></td>
<td>A normal attribute is an attribute that persists on the target system . A normal attribute is never reset during a Chef run. A normal attribute has a higher attribute precedence than a default attribute.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override</span></tt></td>
<td>An override attribute is an attribute that is specified in a recipe (or a run-list) and are often set only for specific roles or nodes. An override attribute has a higher attribute precedence than default or normal attributes. An override attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses override attributes for role-specific or node-specific values when required.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">automatic</span></tt></td>
<td>An automatic attribute contains data that is automatically-generated by Ohai during every Chef run (all previous values are overwritten by the newly-generated values). An automatic attribute cannot be modified. An automatic attribute has the highest attribute precedence. An automatic attribute is automatically reset each time Chef runs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="precedence-vs-priority-pick-a-word-done">
<h4>Precedence vs. Priority (PICK A WORD!) &#8211; DONE<a class="headerlink" href="#precedence-vs-priority-pick-a-word-done" title="Permalink to this headline">¶</a></h4>
<p>During a Chef run, saved attributes are retrieved from the Chef server and are merged with the attributes on the local system. The attribute type and the source of the attribute determines which attribute values have priority over others. Attribute values are applied in the following order (from low to high priority):</p>
<ul class="simple">
<li>Default attributes applied in an attributes file</li>
<li>Default attributes applied in an environment</li>
<li>Default attributes applied in a role</li>
<li>Default attributes applied on a node directly in a recipe</li>
<li>Normal attributes applied in an attributes file</li>
<li>Normal attributes applied on a node directly in a recipe</li>
<li>Override attributes applied in an attributes file</li>
<li>Override attributes applied in a role</li>
<li>Override attributes applied in an environment</li>
<li>Override attributes applied on a node directly in a recipe</li>
<li>Automatic attributes, re-generated by Ohai during each Chef run.</li>
</ul>
</div>
<div class="section" id="persistence-done">
<h4>Persistence &#8211; DONE<a class="headerlink" href="#persistence-done" title="Permalink to this headline">¶</a></h4>
<p>At the beginning of a Chef run, all default, override, and automatic attributes are reset. Chef rebuilds these attributes by based on attributes contained in cookbooks, recipes, roles, and environments, plus Ohai data that is collected about that node at the beginning of the Chef run. Normal attributes are never reset. During a Chef run, any new attributes that are passed to the chef-client are merged with the existing normal attributes on the node and any new settings are applied according to attribute precedence. At the conclusion of the Chef run, all default, override, and automatic attributes disappear, leaving only a collection of normal attributes that will persist until the next Chef run.</p>
<p><strong>jamescott: THIS ONE NEEDS TO BE REVIEWED. SEE http://wiki.opscode.com/display/chef/Attributes AND READ &#8220;ATTRIBUTE PERSISTENCE&#8221; AND THEN READ THE ABOVE AND PROVIDE FEEDBACK.</strong></p>
</div>
<div class="section" id="automatic-attributes-done">
<h4>Automatic Attributes &#8211; DONE<a class="headerlink" href="#automatic-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>An automatic attribute is data that must be understood, but not modified. For example, the IP address of a node, a host name, or the number of loaded kernel modules. When Chef makes changes to a system during a Chef run, automatic attributes are used to ensure that Chef does not make changes to the larger environment on which a node is running. An automatic attribute always has the highest attribute precedence. Automatic attributes are saved to the Chef server where they are indexed for search. Automatic attributes are detected by Ohai before every Chef run.</p>
</div>
<div class="section" id="notation-done">
<h4>Notation &#8211; DONE<a class="headerlink" href="#notation-done" title="Permalink to this headline">¶</a></h4>
<p>Attributes are a special key-value store called a mash within the context of the Ruby DSL. A mash is just a hash where the key can be either a symbol (:key) or a string (&#8220;key&#8221;).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individuals who are new to Ruby and Chef may have an easier time using only string notation. This approach allows attributes to &#8220;be quoted&#8221; and doesn&#8217;t require learning about special cases, namespace overlap (and <tt class="docutils literal"><span class="pre">method_missing</span></tt>), character constraints, and escaping.</p>
</div>
</div>
<div class="section" id="h3-attribute-files">
<h4>H3 &#8211; Attribute Files<a class="headerlink" href="#h3-attribute-files" title="Permalink to this headline">¶</a></h4>
<p>An attribute file is located in the <tt class="docutils literal"><span class="pre">attributes/</span></tt> sub-directory for a cookbook. <strong>jamescott: TESTING THE NEXT SENTENCE</strong> The sub-directory in which attributes are located.</p>
<p>When a cookbook is run against a node, the attributes contained in all attribute files are evaluated in the context of the node object. Node methods (when present) are used to set attribute values on a node. For example, the Apache cookbook contains the following attribute file (called <tt class="docutils literal"><span class="pre">default.rb</span></tt>):</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;dir&quot;</span><span class="o">]</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
<span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;listen_ports&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</pre></div>
</div>
<p>The use of the node object is implicit here. The following example is equivalent to the one above:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;dir&quot;</span><span class="o">]</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
<span class="n">node</span><span class="o">.</span><span class="n">default</span><span class="o">[</span><span class="s2">&quot;apache&quot;</span><span class="o">][</span><span class="s2">&quot;listen_ports&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</pre></div>
</div>
<div class="section" id="h4-attribute-file-methods">
<h5>H4 &#8211; Attribute File Methods<a class="headerlink" href="#h4-attribute-file-methods" title="Permalink to this headline">¶</a></h5>
<p><strong>jamescott: THIS IS NOT DONE. NEED DEFINITION/LIST TABLE FOR BELOW.</strong></p>
<p>Use the following methods within a cookbook&#8217;s attributes file or in a recipe. They correspond to the attribute type of the same name (set is an alias for normal).</p>
<ul class="simple">
<li>override</li>
<li>default</li>
<li>normal (or set)</li>
<li>_unless</li>
<li>attribute?</li>
</ul>
<p>Additionally, there are _unless methods available. See the end of this document for information on conditionally setting attributes</p>
<p>Another handy method available related to attributes is the attribute? method. This will check for the existence of an attribute, so you can do processing in an attributes file or recipe only if a specific attribute exists.</p>
<p>attribute?() in attributes file</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;ec2&quot;</span><span class="p">)</span>
  <span class="c1"># ... set stuff related to EC2</span>
<span class="k">end</span>
</pre></div>
</div>
<p>attribute?() in recipe</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;ec2&quot;</span><span class="p">)</span>
  <span class="c1"># ... do stuff on EC2 nodes</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the recipe, we need to use the method on the node object. In the attributes file, the node object is implicit. In either, we can also look for a sub-key of an attribute by chaining the attribute as methods:</p>
<p>attribute?() in recipe</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">chef</span><span class="o">.</span><span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;webui_enabled&quot;</span><span class="p">)</span>
  <span class="c1"># set up webui stuff</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-cookbook-attribute-file-ordering">
<h5>H4 &#8211; Cookbook Attribute File Ordering<a class="headerlink" href="#h4-cookbook-attribute-file-ordering" title="Permalink to this headline">¶</a></h5>
<p><strong>jamescott: NOT DONE</strong></p>
<p>When Chef loads cookbook attribute files, it does so in alphabetical order for all the cookbooks. If you need to ensure that one attribute file is loaded before another (for example, if your Rails cookbook requires that the Apache attributes are available first) you can use the include_attribute method, like so:</p>
<p>include_attribute</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">include_attribute</span> <span class="s2">&quot;apache2&quot;</span>
</pre></div>
</div>
<p>This loads apache/attributes/default.rb before continuing the processing of the current attribute file.</p>
<p>The syntax for this follows the same &#8220;double colon&#8221; pattern as include_recipe, so a statement like:</p>
<p>include_attribute</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">include_attribute</span> <span class="s2">&quot;rails::tunables&quot;</span>
</pre></div>
</div>
<p>This loads the attributes/tunables.rb file in a rails cookbook.</p>
</div>
<div class="section" id="h4-attribute-accessor-methods">
<h5>H4 &#8211; Attribute Accessor Methods<a class="headerlink" href="#h4-attribute-accessor-methods" title="Permalink to this headline">¶</a></h5>
<p>Attribute accessor methods are automatically created and the method invocation can be used interchangeably with the keys. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">dir</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
<span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">listen_ports</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</pre></div>
</div>
<p>This is a matter of style and preference for how attributes are reloaded from recipes <strong>jamescott: check the wiki page here</strong>, and may be seen when &#8220;retrieving&#8221; the value of an attribute.</p>
</div>
<div class="section" id="h4-reloading-attribute-files-from-recipes">
<h5>H4 &#8211; Reloading Attribute Files From Recipes<a class="headerlink" href="#h4-reloading-attribute-files-from-recipes" title="Permalink to this headline">¶</a></h5>
<p>Attributes sometimes depend on actions taken from within recipes, so it may be necessary to reload a given attribute from within a recipe. For example: if you have an attribute that reads firewall rules, and a recipe that installs a firewall package, the firewall attributes will not be set the first time you execute the cookbook. Since <tt class="docutils literal"><span class="pre">include_attribute</span></tt> is not available from inside recipes, you will need to manually reload your <tt class="docutils literal"><span class="pre">firewall::default</span> <span class="pre">attribute</span></tt> from recipes by doing something like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s1">&#39;iptables&#39;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;ruby_block[try_firewall_again]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">ruby_block</span> <span class="s1">&#39;try_firewall_again&#39;</span> <span class="k">do</span>
  <span class="n">block</span> <span class="k">do</span>
    <span class="n">node</span><span class="o">.</span><span class="n">load_attribute_by_short_filename</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;firewall&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="h2-definitions-done">
<h3>H2 &#8211; Definitions &#8211; DONE<a class="headerlink" href="#h2-definitions-done" title="Permalink to this headline">¶</a></h3>
<p>A definition is used to create a new resource by stringing together one (or more) existing resources. A definition is not a resource and does not take any actions by itself. A definition is replaced by one (or more) resources, and it then takes actions on behalf of those resources. There is no limit to the number of resources that can be part of a definition. All definitions within a cookbook must be located in the definitions folder <strong>(jamescott: need path/swap)</strong>. A definition is never declared into a cookbook. A definition is best-used when:</p>
<ul class="simple">
<li>Data needs to be passed from one (or more) recipes into a single definition</li>
<li>A repeating usage pattern exists for one (or more) resources</li>
<li>An action does not need to be sent directly to a resource (when it does, it should be sent to a provider)</li>
</ul>
<div class="section" id="h3-definition-syntax-done">
<h4>H3 &#8211; Definition Syntax &#8211; DONE<a class="headerlink" href="#h3-definition-syntax-done" title="Permalink to this headline">¶</a></h4>
<p>A definition has three components:</p>
<ul class="simple">
<li>A resource name</li>
<li>One (or more) arguments that are used to to define a parameter and set its default value; if a default value is not specified, it is assumed to be <tt class="docutils literal"><span class="pre">nil</span></tt></li>
<li>A hash that is used within a definition to provide access to parameters and their values</li>
</ul>
<p>The parameter values that are provided are used as the default values, in case a value is not provided when the resource is invoked.</p>
<p>The basic syntax of a definition:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">define</span> <span class="ss">:resource_name</span><span class="p">,</span> <span class="ss">:parameter</span> <span class="o">=&gt;</span> <span class="ss">:argument</span><span class="p">,</span> <span class="ss">:parameter</span> <span class="o">=&gt;</span> <span class="ss">:argument</span>
  <span class="n">params_hash</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For example, a definition named <tt class="docutils literal"><span class="pre">apache_site</span></tt> with an parameter called <tt class="docutils literal"><span class="pre">action</span></tt> with an argument for <tt class="docutils literal"><span class="pre">enable</span> <span class="pre">do</span></tt> would look something like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">define</span> <span class="ss">:apache_site</span><span class="p">,</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:enable</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:enable</span><span class="o">]</span>
     <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">else</span>
     <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-scenario-create-a-new-resource-done">
<h4>H3 &#8211; Scenario: Create a new resource &#8211; DONE<a class="headerlink" href="#h3-scenario-create-a-new-resource-done" title="Permalink to this headline">¶</a></h4>
<p>A definition file creates a new resource apache_site:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">apache_site</span> <span class="no">Definition</span>
<span class="n">define</span> <span class="ss">:apache_site</span><span class="p">,</span> <span class="ss">:enable</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span>
  <span class="n">include_recipe</span> <span class="s2">&quot;apache2&quot;</span>

  <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:enable</span><span class="o">]</span>
    <span class="n">execute</span> <span class="s2">&quot;a2ensite </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
      <span class="n">command</span> <span class="s2">&quot;/usr/sbin/a2ensite </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:service</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache2&quot;</span><span class="p">)</span>
      <span class="n">not_if</span> <span class="k">do</span>
        <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-enabled/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-enabled/000-</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
      <span class="k">end</span>
      <span class="n">only_if</span> <span class="k">do</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-available/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="n">execute</span> <span class="s2">&quot;a2dissite </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">do</span>
      <span class="n">command</span> <span class="s2">&quot;/usr/sbin/a2dissite </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:service</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache2&quot;</span><span class="p">)</span>
      <span class="n">only_if</span> <span class="k">do</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="ss">:apache</span><span class="o">][</span><span class="ss">:dir</span><span class="o">]</span><span class="si">}</span><span class="s2">/sites-enabled/</span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Once created, the definition can be utilized by placing it in a recipe:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">apache_site</span> <span class="n">resource</span>
<span class="c1"># Enable my_site.conf</span>
<span class="n">apache_site</span> <span class="s2">&quot;my_site.conf&quot;</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="c1"># Disable my_site.conf</span>
<span class="n">apache_site</span> <span class="s2">&quot;my_site.conf&quot;</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="kp">false</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The attributes of the new <tt class="docutils literal"><span class="pre">apache_site</span></tt> resource are made accessible via the params hash. Within the context of a Chef run, the definition will be replaced by all the resources that are specified within the definition. For example, in the <tt class="docutils literal"><span class="pre">enabled</span></tt> case, the definition will be expanded to:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">execute</span> <span class="s2">&quot;a2ensite my_site.conf&quot;</span> <span class="k">do</span>
  <span class="n">command</span> <span class="s2">&quot;/usr/sbin/a2ensite my_site.conf&quot;</span>
  <span class="n">notifies</span> <span class="ss">:restart</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:service</span> <span class="o">=&gt;</span> <span class="s2">&quot;apache2&quot;</span><span class="p">)</span>
  <span class="n">not_if</span> <span class="k">do</span>
    <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="s2">&quot;/etc/apache2/sites-enabled/my_site.conf&quot;</span><span class="p">)</span> <span class="ow">or</span>
      <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">symlink?</span><span class="p">(</span><span class="s2">&quot;/etc/apache2/sites-enabled/000-my_site.conf&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-scenario-many-recipes-one-definition-done">
<h4>H3 &#8211; Scenario: Many recipes, one definition &#8211; DONE<a class="headerlink" href="#h3-scenario-many-recipes-one-definition-done" title="Permalink to this headline">¶</a></h4>
<p>Data can be passed to a definition from more than one recipe. For example, when both <tt class="docutils literal"><span class="pre">/etc/aliases</span></tt> and <tt class="docutils literal"><span class="pre">/etc/sudoers</span></tt> require updates from multiple recipes during a single Chef run. A definition file that reopens resources would look something like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">define</span> <span class="ss">:email_alias</span><span class="p">,</span> <span class="ss">:recipients</span> <span class="o">=&gt;</span> <span class="o">[]</span> <span class="k">do</span>
  <span class="n">execute</span> <span class="s2">&quot;newaliases&quot;</span> <span class="k">do</span>
    <span class="n">action</span> <span class="ss">:nothing</span>
  <span class="k">end</span>

  <span class="n">t</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">begin</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s2">&quot;/etc/aliases&quot;</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Exceptions</span><span class="o">::</span><span class="no">ResourceNotFound</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">template</span> <span class="s2">&quot;/etc/aliases&quot;</span> <span class="k">do</span>
      <span class="n">source</span> <span class="s2">&quot;aliases.erb&quot;</span>
      <span class="n">cookbook</span> <span class="s2">&quot;aliases&quot;</span>
      <span class="n">variables</span><span class="p">({</span><span class="ss">:aliases</span> <span class="o">=&gt;</span> <span class="p">{}</span> <span class="p">})</span>
      <span class="n">notifies</span> <span class="ss">:run</span><span class="p">,</span> <span class="s2">&quot;execute[newaliases]&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">variables</span><span class="o">[</span><span class="ss">:aliases</span><span class="o">].</span><span class="n">has_key?</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">variables</span><span class="o">[</span><span class="ss">:aliases</span><span class="o">][</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]]</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="k">end</span>
  <span class="n">t</span><span class="o">.</span><span class="n">variables</span><span class="o">[</span><span class="ss">:aliases</span><span class="o">][</span><span class="n">params</span><span class="o">[</span><span class="ss">:name</span><span class="o">]]</span> <span class="o">&lt;&lt;</span> <span class="o">[</span> <span class="n">params</span><span class="o">[</span><span class="ss">:recipients</span><span class="o">]</span> <span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example was provided by Opscode community member &#8220;Mithrandir&#8221;. Thank you!</p>
</div>
</div>
<div class="section" id="h3-scenario-virtual-hosts-done">
<h4>H3 &#8211; Scenario: Virtual hosts &#8211; DONE<a class="headerlink" href="#h3-scenario-virtual-hosts-done" title="Permalink to this headline">¶</a></h4>
<p>Two applications need to be deployed and run on a single node under the same domain and sub-domain. A Ruby on Rails application will reside as the main application at <tt class="docutils literal"><span class="pre">example.com</span></tt> and a WordPress application will reside at <tt class="docutils literal"><span class="pre">blog.example.com</span></tt>. The domain is running Apache2 as the web server. The domain is expected to grow, but for now only two run_list resources are created, with the appropriate roles added to them. At some point in the future, when a new sub-domain is required, a new run_list resource would also be created.</p>
<p>The virtual host on the Apache2 server is only one per node, which can create challenges when a node requires updates. Using a definition helps get around this issue. For example, the <tt class="docutils literal"><span class="pre">web_app</span></tt> definition exists in the Opscode Apache2 cookbook, and can be used like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">web_app</span> <span class="s2">&quot;blog_site&quot;</span> <span class="k">do</span>
  <span class="n">server_name</span> <span class="s2">&quot;blog&quot;</span>
  <span class="n">server_aliases</span> <span class="o">[</span> <span class="s2">&quot;blog.</span><span class="si">#{</span><span class="n">node</span><span class="o">[</span><span class="s1">&#39;domain&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">node</span><span class="o">[</span><span class="s1">&#39;fqdn&#39;</span><span class="o">]</span> <span class="o">]</span>
  <span class="n">docroot</span> <span class="s2">&quot;/srv/www/blog_site&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>When Chef processes a recipe that contains this definition, it will find the <tt class="docutils literal"><span class="pre">web_app</span></tt> resource and will attempt to recognize it as a resource. Assuming that the Opscode Apache2 cookbook is available, then the resources contained within that cookbook will be found and loaded, replacing the definition.</p>
</div>
</div>
<div class="section" id="h2-file-distributions-done">
<h3>H2 &#8211; File Distributions &#8211; DONE<a class="headerlink" href="#h2-file-distributions-done" title="Permalink to this headline">¶</a></h3>
<p>A file distribution is a resource that tells a cookbook how to distribute (or more) files to servers, including by node, by platform, and by file version.</p>
<div class="section" id="h3-syntax-done">
<h4>H3 &#8211; Syntax(?) &#8211; DONE<a class="headerlink" href="#h3-syntax-done" title="Permalink to this headline">¶</a></h4>
<p>The cookbook_file resource defines a file distribution. For example, the following cookbook_file details:</p>
<div class="highlight-python"><pre>cookbook_file "/usr/local/bin/apache2_module_conf_generate.pl" do
  source "apache2_module_conf_generate.pl"
  mode 0755
  owner "root"
  group "root"
end</pre>
</div>
<p>would create the <tt class="docutils literal"><span class="pre">/usr/local/bin/apache2_module_conf_generate.pl</span></tt> from the <tt class="docutils literal"><span class="pre">apache2_module_conf_generate.pl</span></tt> file contained in the cookbook that is most specific to the node that is executing the recipe.</p>
<p><strong>jamescott: there is some mumbo jumbo about a &#8220;By default, the file specificity requirements are obtained from the ``remote_url`` setting in the configuration file on the |chef client|.&#8221; but (as far as I can tell) there is no ``remote_url`` setting in any of the configuration files.</strong></p>
</div>
<div class="section" id="h3-file-specificity-done">
<h4>H3 &#8211; File Specificity &#8211; DONE<a class="headerlink" href="#h3-file-specificity-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: I found this section a tad confusing on the Wiki &#8211; the verbiage didn&#8217;t make sense, so I rewrote it to &#8220;make sense&#8221; which means that this section should be reviewed carefully by someone who actually understands it, in case I misunderstood the point I thought the article was trying to make.</strong></p>
<p>A cookbook will frequently be designed to work across many platforms and will often be required to distribute a specific file to a specific platform. A cookbook can be designed to support distributing files across platforms, but ensuring that the right file ends up on each system. For example, a cookbook may have a directory structure like this:</p>
<div class="highlight-python"><pre>files/
   host-foo.example.com
   ubuntu-8.04
   ubuntu-8
   ubuntu
   default</pre>
</div>
<p>and a cookbook_file resource like this:</p>
<div class="highlight-python"><pre>cookbook_file "/usr/local/bin/apache2_module_conf_generate.pl" do
  source "apache2_module_conf_generate.pl"
  mode 0755
  owner "root"
  group "root"
end</pre>
</div>
<p>would be matched in the same order as the cookbook directory structure. For a node named &#8220;foo.example.com&#8221; that is running Ubuntu 8.04, then the second item would be the matching item and the location to which the file identified in the cookbook_resource would be distributed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">host</span><span class="o">-</span><span class="n">foo</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">apache2_module_conf_generate</span><span class="o">.</span><span class="n">pl</span>
<span class="n">ubuntu</span><span class="o">-</span><span class="mf">8.04</span><span class="o">/</span><span class="n">apache2_module_conf_generate</span><span class="o">.</span><span class="n">pl</span>
<span class="n">ubuntu</span><span class="o">-</span><span class="mi">8</span><span class="o">/</span><span class="n">apache2_module_conf_generate</span><span class="o">.</span><span class="n">pl</span>
<span class="n">ubuntu</span><span class="o">/</span><span class="n">apache2_module_conf_generate</span><span class="o">.</span><span class="n">pl</span>
<span class="n">default</span><span class="o">/</span><span class="n">apache2_module_conf_generate</span><span class="o">.</span><span class="n">pl</span>
</pre></div>
</div>
<p>If the <tt class="docutils literal"><span class="pre">apache_module_conf_generate.pl</span></tt> file was located in the cookbook directory under <tt class="docutils literal"><span class="pre">files/host-foo.example.com/</span></tt> then the specified file(s) would only be copied to the machine with the domain name foo.example.com.</p>
<p><strong>jamescott: THE SECTION IMMEDIATELY BELOW MAKES SENSE, BUT DOESN&#8217;T MAKE SENSE. COME BACK TO THIS ONE</strong></p>
<p>So, the rule distilled:</p>
<ol class="arabic simple">
<li>host-node[:fqdn]</li>
<li>node[:platform]-node[:version]</li>
<li>node[:platform]-version_components: The version string is split on decimals and searched from greatest specificity to least; for example, if the location from the last rule was centos-5.7.1, then centos-5.7 and centos-5 would also be searched.</li>
<li>node[:platform]</li>
<li>default</li>
</ol>
</div>
<div class="section" id="h3-host-notation-done">
<h4>H3 &#8211; Host Notation &#8211; DONE<a class="headerlink" href="#h3-host-notation-done" title="Permalink to this headline">¶</a></h4>
<p>The naming of folders within cookbook directories must literally match the host notation used for file specificity matching. For example, if a host is named <tt class="docutils literal"><span class="pre">foo.example.com</span></tt>, then the folder must be named <tt class="docutils literal"><span class="pre">host-foo.example.com</span></tt>.</p>
<p><strong>jamescott: this is probably best to single-source, as it lives in several places.</strong></p>
</div>
<div class="section" id="h3-file-transfers-done">
<h4>H3 &#8211; File Transfers &#8211; DONE<a class="headerlink" href="#h3-file-transfers-done" title="Permalink to this headline">¶</a></h4>
<p>When a cookbook_file resource is run, the chef-client will calculate the checksum of each local file and then compare this against the checksum for that same file as it currently exists in the cookbook on the Chef server. If the checksums match, that file is not transferred. Even though a cookbook may contain many files, only files that require an update are transferred from the Chef server to a chef-client.</p>
</div>
</div>
<div class="section" id="h2-libraries-done">
<h3>H2 &#8211; Libraries &#8211; DONE<a class="headerlink" href="#h2-libraries-done" title="Permalink to this headline">¶</a></h3>
<p>A library allows arbitrary Ruby code to be included in a cookbook, either as a way to extend the Chef language or to implement a new class directly. A library is defined in <tt class="docutils literal"><span class="pre">/libraries/library_name.rb</span></tt> for each cookbook. A library that is included in a cookbook is automatically required and will be available to all recipes, attributes, file definitions, providers, and definitions. A library is defined in the library_name.rb, which is found in the libraries folder for each cookbook. The contents of a library will determine the potential uses of that library in a cookbook.</p>
<p>(jamescott: need to swap name those and includes_chef_cookbook_library needs a 2nd revision).</p>
<p>A library can be used to:</p>
<ul class="simple">
<li>Access attributes that are stored in files</li>
<li>Do basic programming techniques, such as a loop</li>
<li>Create a custom namespace that can be called directly from any Chef recipe (which also helps keep the <tt class="docutils literal"><span class="pre">Chef::Recipe</span></tt> namespace clean)</li>
<li>Connect to a database</li>
<li>Talk to an LDAP provider</li>
<li>Do anything that can be done with Ruby</li>
</ul>
<div class="section" id="h3-library-syntax-done">
<h4>H3 &#8211; Library Syntax &#8211; DONE<a class="headerlink" href="#h3-library-syntax-done" title="Permalink to this headline">¶</a></h4>
<p>The basic syntax of a library:</p>
<div class="highlight-python"><pre>your_cookbook/libraries/your_example_library.rb
# define a module to mix into Chef::Recipe::namespace
module YourExampleLibrary
  def your_function()
    # ... do something useful
  end
end
your_cookbook/recipes/default.rb
# open the Chef::Recipe class and mix in the library module
class Chef::Recipe::namespace
  include YourExampleLibrary
end

your_function()</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In the above example, the <tt class="docutils literal"><span class="pre">::namespace</span></tt> part of the <tt class="docutils literal"><span class="pre">Chef::Recipe::namespace</span></tt> syntax should only be used when a custom namespace has been added that extends the default Chef libraries.</p>
</div>
</div>
<div class="section" id="h3-scenario-attributes-stored-in-file-done">
<h4>H3 &#8211; Scenario: Attributes stored in file &#8211; DONE<a class="headerlink" href="#h3-scenario-attributes-stored-in-file-done" title="Permalink to this headline">¶</a></h4>
<p>A customer record is stored in an attribute file that looks like this:</p>
<div class="highlight-python"><pre>mycompany_customers({
  :bob =&gt; {
    :homedir =&gt; "/home/bob",
    :webdir =&gt; "/home/bob/web"
  }
}
)</pre>
</div>
<p>A simple recipe may contain something like this:</p>
<div class="highlight-python"><pre>directory node[:mycompany_customers][:bob][:webdir] do
  owner "bob"
  group "bob"
  action :create
end</pre>
</div>
<p>Or a less verbose version of the same simple recipe:</p>
<div class="highlight-python"><pre>directory customer(:bob)[:webdir] do
  owner "bob"
  group "bob"
  action :create
end</pre>
</div>
<p>A simple library could be created that extends <tt class="docutils literal"><span class="pre">Chef::Recipe::</span></tt>, like this:</p>
<div class="highlight-python"><pre>class Chef
  class Recipe
    # A shortcut to a customer
    def customer(name)
      @node[:mycompany_customers][name]
    end
  end
end</pre>
</div>
</div>
<div class="section" id="h3-scenario-loop-over-customer-records-done">
<h4>H3 &#8211; Scenario: Loop over customer records &#8211; DONE<a class="headerlink" href="#h3-scenario-loop-over-customer-records-done" title="Permalink to this headline">¶</a></h4>
<p>A customer record is stored in an attribute file that looks like this:</p>
<div class="highlight-python"><pre>mycompany_customers({
  :bob =&gt; {
    :homedir =&gt; "/home/bob",
    :webdir =&gt; "/home/bob/web"
  }
}
)</pre>
</div>
<p>If there are many customer records in an environment, a simple recipe can be used to loop over every customer, like this:</p>
<div class="highlight-python"><pre>all_customers do |name, info|
  directory info[:webdir] do
    owner name
    group name
    action :create
  end
end</pre>
</div>
<p>A simple library could be created that extends <tt class="docutils literal"><span class="pre">Chef::Recipe::</span></tt>, like this:</p>
<div class="highlight-python"><pre>class Chef
  class Recipe
    def all_customers(&amp;block)
      @node[:mycompany_customers].each do |name, info|
        block.call(name, info)
      end
    end
  end
end</pre>
</div>
</div>
<div class="section" id="h3-scenario-creating-a-namespace-done">
<h4>H3 &#8211; Scenario: Creating a namespace &#8211; DONE<a class="headerlink" href="#h3-scenario-creating-a-namespace-done" title="Permalink to this headline">¶</a></h4>
<p>A database can contain a list of virtual hosts that are used by customers. A custom namespace could be created that looks something like:</p>
<div class="highlight-python"><pre>require 'sequel'

class Chef::Recipe::ISP
  # We can call this with ISP.vhosts
  def self.vhosts
    v = []
    @db = Sequel.mysql(
      'web',
      :user =&gt; 'example',
      :password =&gt; 'example_pw',
      :host =&gt; 'dbserver.example.com'
    )
    @db[
      "SELECT virtualhost.domainname,
           usertable.userid,
           usertable.uid,
           usertable.gid,
           usertable.homedir
       FROM usertable, virtualhost
       WHERE usertable.userid = virtualhost.user_name"
      ].all do |query|
      vhost_data = {
        :servername   =&gt; query[:domainname],
        :documentroot =&gt; query[:homedir],
        :uid          =&gt; query[:uid],
        :gid          =&gt; query[:gid],
      }
      v.push(vhost_data)
    end
    Chef::Log.debug("About to provision #{v.length} vhosts")
    v
  end
end</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example was provided by Opscode community member &#8220;Arjuna (fujin)&#8221;. Thank you!</p>
</div>
<p>After the custom namespace is created, it could then be used in a recipe, like this:</p>
<div class="highlight-python"><pre>Using ISP.vhosts in a Recipe
ISP.vhosts.each do |vhost|
  directory vhost[:documentroot] do
    owner vhost[:uid]
    group vhost[:gid]
    mode 0755
    action :create
  end

  directory "#{vhost[:documentroot]}/#{vhost[:domainname]}" do
    owner vhost[:uid]
    group vhost[:gid]
    mode 0755
    action :create
  end
end</pre>
</div>
</div>
</div>
<div class="section" id="h2-lightweight-resources-and-providers-done">
<h3>H2 &#8211; Lightweight Resources and Providers &#8211; DONE<a class="headerlink" href="#h2-lightweight-resources-and-providers-done" title="Permalink to this headline">¶</a></h3>
<p>A lightweight resource and provider is simple way to implement resource and provider functionality that is not already built-in to Chef. Once created, the lightweight resource and provider become a Ruby class within the Chef environment. A lightweight resource and provider require less coding and are ideal for implementing specific sets of desired functionality quickly.</p>
<p><strong>jamescott: THIS WHOLE SECTION WAS HERE: http://wiki.opscode.com/display/chef/Lightweight+Resources+and+Providers+%28LWRP%29 THAT TOPIC ON THE OLD WIKI IS GAWDAWFUL AND HAS TO BE DEPRECATED. THIS SET OF TOPICS IS AN ATTEMPT TO REBUILD IT. I REMOVED THE CONFUSING STUFF ON PURPOSE.</strong></p>
<div class="section" id="h3-file-locations-done">
<h4>H3 &#8211; File Locations &#8211; DONE<a class="headerlink" href="#h3-file-locations-done" title="Permalink to this headline">¶</a></h4>
<p>Lightweight resources and providers are loaded from files that are saved in the following cookbook sub-directories:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Directory</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">providers/</span></tt></td>
<td>The sub-directory in which lightweight providers are located.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">resources/</span></tt></td>
<td>The sub-directory in which lightweight resources are located.</td>
</tr>
</tbody>
</table>
<p>The naming patterns of lightweight resources and providers are determined by the name of the cookbook and by the name of the files in the <tt class="docutils literal"><span class="pre">resources/</span></tt> and <tt class="docutils literal"><span class="pre">providers/</span></tt> sub-directories. For example, if a cookbook named <tt class="docutils literal"><span class="pre">example</span></tt> was downloaded to the Chef repository, it would be located at <tt class="docutils literal"><span class="pre">/cookbooks/example/</span></tt>. If that cookbook contained two resources and two providers, the following files would be part of the <tt class="docutils literal"><span class="pre">resources/</span></tt> directory:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Files</th>
<th class="head">Resource Name</th>
<th class="head">Generated Class</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default.rb</span></tt></td>
<td>example</td>
<td>Chef::Resource::Example</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">custom.rb</span></tt></td>
<td>custom</td>
<td>Chef::Resource::ExampleCustom</td>
</tr>
</tbody>
</table>
<p>And the following files would be part of the <tt class="docutils literal"><span class="pre">providers/</span></tt> directory:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Files</th>
<th class="head">Provider Name</th>
<th class="head">Generated Class</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default.rb</span></tt></td>
<td>example</td>
<td>Chef::Provider::Example</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">custom.rb</span></tt></td>
<td>custom</td>
<td>Chef::Provider::ExampleCustom</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-lightweight-resources-done">
<h4>H3 &#8211; Lightweight Resources &#8211; DONE<a class="headerlink" href="#h3-lightweight-resources-done" title="Permalink to this headline">¶</a></h4>
<p>A lightweight resource is a custom resource that creates an abstract approach for defining a set of actions and (for each action) a set of attributes and validation parameters. A lightweight resource relies on a lightweight provider to take the necessary steps to bring a piece of the system to a desired state.</p>
<div class="section" id="h4-common-functionality-for-all-lightweight-resources-done">
<h5>H4 &#8211; Common Functionality for all Lightweight Resources &#8211; DONE<a class="headerlink" href="#h4-common-functionality-for-all-lightweight-resources-done" title="Permalink to this headline">¶</a></h5>
<p>The attributes and actions in this section apply to all lightweight resources.</p>
</div>
<div class="section" id="h5-actions-done-needs-to-be-h5">
<h5>H5 &#8211; Actions &#8211; DONE, NEEDS TO BE H5<a class="headerlink" href="#h5-actions-done-needs-to-be-h5" title="Permalink to this headline">¶</a></h5>
<p>The following actions are common to every resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">nothing</span></tt></td>
<td>Use to do nothing. In the absence of another default action, <tt class="docutils literal"><span class="pre">nothing</span></tt> is the default. This action can be useful to specify a resource so that it can be notified of other actions.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h5-attributes-done-needs-to-be-h5">
<h5>H5 &#8211; Attributes &#8211; DONE, NEEDS TO BE H5<a class="headerlink" href="#h5-attributes-done-needs-to-be-h5" title="Permalink to this headline">¶</a></h5>
<p>The following attributes are common to every resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">ignore_failure</span></tt></td>
<td>Use to continue running a recipe if a resource fails for any reason. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">provider</span></tt></td>
<td>Use to specify the class name of a provider for use with a resource.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">retries</span></tt></td>
<td>Use to specify the number of times to catch exceptions and retry the resource. Default value: <tt class="docutils literal"><span class="pre">0</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">retry_delay</span></tt></td>
<td>Use to specify the retry delay (in seconds). Default value: <tt class="docutils literal"><span class="pre">2</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">supports</span></tt></td>
<td>Use to specify a hash of options that contains hints about the capabilities of a resource. Chef may use these hints to help identify the correct provider. This attribute is only utilized by a small number of providers, including <tt class="docutils literal"><span class="pre">User</span></tt> and <tt class="docutils literal"><span class="pre">Service</span></tt>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h5-conditional-execution-done-needs-to-be-h5">
<h5>H5 &#8211; Conditional Execution &#8211; DONE, NEEDS TO BE H5<a class="headerlink" href="#h5-conditional-execution-done-needs-to-be-h5" title="Permalink to this headline">¶</a></h5>
<p>A conditional execution can be used to put additional guards around certain resources so that they are only run when the condition is met. The most common reason for using a conditional execution is to ensure that the <tt class="docutils literal"><span class="pre">execute</span></tt> resource is idempotent, but conditional executions can be used with any resource. A conditional execution can be passed as a string or as a block. A strings is executed as a shell command and a block is Ruby code. In both cases, the attribute is <tt class="docutils literal"><span class="pre">true</span></tt> when the command returns <tt class="docutils literal"><span class="pre">0</span></tt>).</p>
<p>The following attributes can be used to define a conditional execution for a resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">not_if</span></tt></td>
<td>Indicates whether this resource should not be applied. If <tt class="docutils literal"><span class="pre">true</span></tt>, this action should not be performed. If <tt class="docutils literal"><span class="pre">false</span></tt> this action should always be performed.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">only_if</span></tt></td>
<td>Indicates whether only this resource is applied. If <tt class="docutils literal"><span class="pre">true</span></tt>, this action should always be performed. If <tt class="docutils literal"><span class="pre">false</span></tt> this action should never be performed.</td>
</tr>
</tbody>
</table>
<p>The following arguments can be used with the <tt class="docutils literal"><span class="pre">not_if</span></tt> or <tt class="docutils literal"><span class="pre">only_if</span></tt> attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:user</span></tt></td>
<td><p class="first">Use to specify the user that a command will run as. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="s1">&#39;adam&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:group</span></tt></td>
<td><p class="first">Use to specify the group that a command will run as. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="s1">&#39;adam&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:environment</span></tt></td>
<td><p class="first">Use to specify a hash of environment variables to be set. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam /etc/passwd&quot;</span><span class="p">,</span> <span class="ss">:environment</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">&#39;HOME&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;/home/adam&quot;</span> <span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:cwd</span></tt></td>
<td><p class="first">Use to set the current working directory before running a command. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;grep adam passwd&quot;</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="s1">&#39;/etc&#39;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:timeout</span></tt></td>
<td><p class="first">Use to set a timeout for a command. For example:</p>
<div class="last highlight-ruby"><div class="highlight"><pre><span class="n">not_if</span> <span class="s2">&quot;sleep 10000&quot;</span><span class="p">,</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">10</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h5-notifications-done-needs-to-be-h5">
<h5>H5 &#8211; Notifications &#8211; DONE, NEEDS TO BE H5<a class="headerlink" href="#h5-notifications-done-needs-to-be-h5" title="Permalink to this headline">¶</a></h5>
<p>The following notifications can be used with any resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Notification</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">notifies</span></tt></td>
<td>Use to notify another resource to take an action if this resource&#8217;s state changes for any reason.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">subscribes</span></tt></td>
<td>Use to take action on this resource if another resource&#8217;s state changes. This is similar to <tt class="docutils literal"><span class="pre">notifies</span></tt>, but reversed.</td>
</tr>
</tbody>
</table>
<p>The following timers can be used to define when a notification is triggered:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Timer</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:restart</span></tt></td>
<td>Use to restart a service or application.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:delayed</span></tt></td>
<td>Use to specify that a notification should be queued up and then executed at the very end of a Chef run.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:immediately</span></tt></td>
<td>Use to specify that a notification be run immediately.</td>
</tr>
</tbody>
</table>
<p>The basic syntax of a <tt class="docutils literal"><span class="pre">notifies</span></tt> notification is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:action</span><span class="p">,</span> <span class="s2">&quot;resource_type[resource_name]&quot;</span><span class="p">,</span> <span class="ss">:notification_timing</span>
<span class="k">end</span>
</pre></div>
</div>
<p>A resource must be defined before another resource may subscribe to it. The basic syntax of a <tt class="docutils literal"><span class="pre">subscribes</span></tt> notification is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">subscribes</span> <span class="ss">:action</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:resource_type</span> <span class="o">=&gt;</span> <span class="s2">&quot;resource_name&quot;</span><span class="p">),</span> <span class="ss">:notification_timing</span>
<span class="k">end</span>
</pre></div>
</div>
<p>or:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">resource</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
  <span class="n">subscribes</span> <span class="ss">:action</span><span class="p">,</span> <span class="n">resources</span><span class="p">(</span><span class="s2">&quot;resource[resource_name]&quot;</span><span class="p">),</span> <span class="ss">:notification_timing</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h5-relative-paths-done-needs-to-be-h5">
<h5>H5 &#8211; Relative Paths &#8211; DONE, NEEDS TO BE H5<a class="headerlink" href="#h5-relative-paths-done-needs-to-be-h5" title="Permalink to this headline">¶</a></h5>
<p>The following relative paths can be used with any resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Relative Path</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">#{ENV['HOME']}</span></tt></td>
<td>Use to return the <tt class="docutils literal"><span class="pre">~</span></tt> path in Linux and Mac OS X or the <tt class="docutils literal"><span class="pre">%HOMEPATH%</span></tt> in Microsoft Windows.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-actions-done">
<h5>H4 &#8211; Actions &#8211; DONE<a class="headerlink" href="#h4-actions-done" title="Permalink to this headline">¶</a></h5>
<p>The actions available to a lightweight resource are custom to each lightweight resource. They are defined using the <tt class="docutils literal"><span class="pre">action</span></tt> keyword using a comma-separated list to define multiple actions. Actions are defined using the following syntax:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:action_name</span><span class="p">,</span> <span class="ss">:action_name</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">:action_name</span></tt> could be <tt class="docutils literal"><span class="pre">:create</span></tt>, <tt class="docutils literal"><span class="pre">:delete</span></tt>, <tt class="docutils literal"><span class="pre">:execute</span></tt> and so on. Each action requires a definition to be present in a lightweight provider. When more than one action is present in the lightweight resource, the additional actions will append to the list of allowed actions (and not overwrite them).</p>
</div>
<div class="section" id="h4-attributes-and-validation-parameters-done">
<h5>H4 &#8211; Attributes and Validation Parameters &#8211; DONE<a class="headerlink" href="#h4-attributes-and-validation-parameters-done" title="Permalink to this headline">¶</a></h5>
<p>The attributes available to a lightweight resource are custom to each action. They are defined using the <tt class="docutils literal"><span class="pre">attribute</span></tt> keyword and may be assigned on (or more) validation parameters. Attributes are defined using the following syntax:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">attribute</span> <span class="ss">:attribute_name</span><span class="p">,</span> <span class="ss">:validation_parameter</span> <span class="o">=&gt;</span> <span class="n">value</span>
</pre></div>
</div>
<p>where the <tt class="docutils literal"><span class="pre">:validation_parameter</span></tt> is optional. (Attributes that do not have a validation parameter assigned to them will not require the defined validation when the action it is associated with is run from a recipe.) More than one attribute can be defined.</p>
<p>The following parameters can be passed to the attribute keyword in order to validate a parameter that has been set on a resource in a recipe:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Parameter</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:default</span></tt></td>
<td>Use to set the default value for a parameter.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:kind_of</span></tt></td>
<td>Use to ensure that a value is a <tt class="docutils literal"><span class="pre">kind_of?(whatever)</span></tt>. Pass this parameter as an array to ensure that a value is one of those types.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:required</span></tt></td>
<td>Use to raise an exception if a parameter is missing. Valid values: <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>. Default value: <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:regex</span></tt></td>
<td>Use to match the value of a parameter against a regular expression.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:equal_to</span></tt></td>
<td>Use to match the value of a parameter with <tt class="docutils literal"><span class="pre">==</span></tt>. An array means it can be equal to any of the values.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:name_attribute</span></tt></td>
<td>Use to specify the name of a resource. Valid value: <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">:callbacks</span></tt></td>
<td>Use to take a hash of <tt class="docutils literal"><span class="pre">Procs</span></tt>, which should return <tt class="docutils literal"><span class="pre">true</span></tt> if the argument is valid. The key will be inserted into the error message if the <tt class="docutils literal"><span class="pre">Proc</span></tt> does not return true: <tt class="docutils literal"><span class="pre">&quot;Option</span> <span class="pre">#{key}'s</span> <span class="pre">value</span> <span class="pre">#{value}</span> <span class="pre">#{message}!&quot;</span></tt>.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">:respond_to</span></tt></td>
<td>Use to ensure that a value has a given method. Takes one method name or an array of method names.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h4-syntax-done">
<h5>H4 &#8211; Syntax &#8211; DONE<a class="headerlink" href="#h4-syntax-done" title="Permalink to this headline">¶</a></h5>
<p>A lightweight resource is an abstract interface that specifies one (or more) actions that can be taken, one (or more) attributes, and then for each attribute a validation rule that defines how each attribute can be applied. The syntax for a lightweight resource is:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:action_name</span><span class="p">,</span> <span class="ss">:action_name</span>

<span class="n">attribute</span> <span class="ss">:attribute_name</span><span class="p">,</span>   <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="n">string</span><span class="p">,</span> <span class="n">integer</span><span class="p">,</span> <span class="n">etc</span><span class="o">.</span> <span class="o">]</span>
<span class="n">attribute</span> <span class="ss">:attribute_name</span><span class="p">,</span>   <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="n">regular_expression</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">:action_name</span></tt> defines each action and <tt class="docutils literal"><span class="pre">:attribute_name</span></tt> defines each attribute. Using <tt class="docutils literal"><span class="pre">:kind_of</span></tt> will enforce a specific value type and using <tt class="docutils literal"><span class="pre">:regex</span></tt> will allow a regular expression. For example, a list of actions like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:foo</span><span class="p">,</span> <span class="ss">:bar</span>
</pre></div>
</div>
<p>specifies a list of allowed actions for a resource that includes &#8220;foo&#8221; and &#8220;bar&#8221;. Typically, the names of actions correspond to methods that are available to the provider that will implement the actions. For example, an action named <tt class="docutils literal"><span class="pre">:foo</span></tt> would correspond to a method named <tt class="docutils literal"><span class="pre">action_foo</span></tt>. If more than one action is listed, the additional actions will append to (and not overwrite) the list of allowed actions. <strong>jamescott: I have no idea what the previous sentence actually means. Anyone?</strong></p>
<p>For attributes, the validation rules are optional. For example, using only the attribute keyword:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">attribute</span> <span class="ss">:foo</span>
</pre></div>
</div>
<p>will create an attribute named <tt class="docutils literal"><span class="pre">:foo</span></tt> that is accessible to the provider using the resource&#8217;s <tt class="docutils literal"><span class="pre">foo</span></tt> method, but without validation. To use validation, specify the type of validation (a string or a regular expression) like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">attribute</span> <span class="ss">:bar</span><span class="p">,</span> <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">attribute</span> <span class="ss">:bar</span><span class="p">,</span> <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="n">regular_expression</span>
</pre></div>
</div>
<p>For example, a lightweight resource that has four actions and six attributes:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:touch</span><span class="p">,</span> <span class="ss">:create_if_missing</span>

<span class="n">attribute</span> <span class="ss">:backup</span><span class="p">,</span>   <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="nb">Integer</span><span class="p">,</span> <span class="no">FalseClass</span> <span class="o">]</span>
<span class="n">attribute</span> <span class="ss">:group</span><span class="p">,</span>    <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span>
<span class="n">attribute</span> <span class="ss">:mode</span><span class="p">,</span>     <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^0?\d{3,4}$/</span>
<span class="n">attribute</span> <span class="ss">:owner</span><span class="p">,</span>    <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span> <span class="o">]</span>
<span class="n">attribute</span> <span class="ss">:path</span><span class="p">,</span>     <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span>
<span class="n">attribute</span> <span class="ss">:checksum</span><span class="p">,</span> <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^[a-zA-Z0-9]{64}$/</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-compare-platform-and-lightweight-resources-done">
<h5>H4 &#8211; Compare Platform and Lightweight Resources &#8211; DONE<a class="headerlink" href="#h4-compare-platform-and-lightweight-resources-done" title="Permalink to this headline">¶</a></h5>
<p>The following example uses the File resource to show the difference between it and what it would look like if it were a lightweight resource.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;chef/resource&#39;</span>

<span class="k">class</span> <span class="nc">Chef</span>
  <span class="k">class</span> <span class="nc">Resource</span>
    <span class="k">class</span> <span class="nc">File</span> <span class="o">&lt;</span> <span class="no">Chef</span><span class="o">::</span><span class="no">Resource</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="vi">@resource_name</span> <span class="o">=</span> <span class="ss">:file</span>
        <span class="vi">@path</span> <span class="o">=</span> <span class="nb">name</span>
        <span class="vi">@backup</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="vi">@action</span> <span class="o">=</span> <span class="s2">&quot;create&quot;</span>
        <span class="vi">@allowed_actions</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:touch</span><span class="p">,</span> <span class="ss">:create_if_missing</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:backup</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="nb">Integer</span><span class="p">,</span> <span class="no">FalseClass</span> <span class="o">]</span>
        <span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">checksum</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:checksum</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^[a-zA-Z0-9]{64}$/</span>
        <span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">group</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:group</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span> <span class="o">]</span>
        <span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:mode</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^0?\d{3,4}$/</span>
        <span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">owner</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:owner</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span> <span class="o">]</span>
        <span class="p">)</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="n">arg</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
        <span class="n">set_or_return</span><span class="p">(</span>
          <span class="ss">:path</span><span class="p">,</span>
          <span class="n">arg</span><span class="p">,</span>
          <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span>
        <span class="p">)</span>
      <span class="k">end</span>

    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The above code is simple, traditional Ruby&#8211;no magic at all. A number of getter/setter methods are created and inputs are validated against criteria, like regular expressions, strings, true/false, and so on. The lightweight resource looks like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:touch</span><span class="p">,</span> <span class="ss">:create_if_missing</span>

<span class="n">attribute</span> <span class="ss">:backup</span><span class="p">,</span>   <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="nb">Integer</span><span class="p">,</span> <span class="no">FalseClass</span> <span class="o">]</span>
<span class="n">attribute</span> <span class="ss">:group</span><span class="p">,</span>    <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span>
<span class="n">attribute</span> <span class="ss">:mode</span><span class="p">,</span>     <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^0?\d{3,4}$/</span>
<span class="n">attribute</span> <span class="ss">:owner</span><span class="p">,</span>    <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="sr">/^([a-z]|[A-Z]|[0-9]|_|-)+$/</span><span class="p">,</span> <span class="sr">/^\d+$/</span> <span class="o">]</span>
<span class="n">attribute</span> <span class="ss">:path</span><span class="p">,</span>     <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span>
<span class="n">attribute</span> <span class="ss">:checksum</span><span class="p">,</span> <span class="ss">:regex</span> <span class="o">=&gt;</span> <span class="sr">/^[a-zA-Z0-9]{64}$/</span>
</pre></div>
</div>
<p>Hopefully this shows the similarities and differences between resources and lightweight resources. The lightweight resources are easier to write and understand, plus they can offer much the same (if not identical) functionality as the more complex resources that are built into Chef.</p>
</div>
<div class="section" id="h4-use-a-default-provider-done">
<h5>H4 &#8211; Use a Default Provider &#8211; DONE<a class="headerlink" href="#h4-use-a-default-provider-done" title="Permalink to this headline">¶</a></h5>
<p>If a lightweight resource is used in a recipe, and the provider attribute is omitted, Chef will look for a lightweight provider of the same name as the resource in the same cookbook by default. For example, a lightweight resource that explicitly names the provider:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">aws_elastic_ip</span> <span class="ss">:my_ip</span> <span class="k">do</span>
  <span class="n">ip</span> <span class="mi">1</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">4</span>
  <span class="n">provider</span> <span class="ss">:aws_elastic_ip</span> <span class="c1"># unnecessary, as this is the default</span>
<span class="k">end</span>
</pre></div>
</div>
<p>versus a similar lightweight resource that does not list the lightweight provider:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">aws_elastic_ip</span> <span class="ss">:my_ip</span> <span class="k">do</span>
  <span class="n">ip</span> <span class="mi">1</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">4</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Both examples should provide the same results.</p>
</div>
</div>
<div class="section" id="h3-lightweight-providers-done">
<h4>H3 &#8211; Lightweight Providers &#8211; DONE<a class="headerlink" href="#h3-lightweight-providers-done" title="Permalink to this headline">¶</a></h4>
<p>A lightweight provider is a custom provider that is designed to take the steps that are required to bring a piece of the system to a desired state based on an action that is defined by a lightweight resource.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Typically, using a lightweight provider is the best (and recommended) way of handling a resource that does not already exist. If using a lightweight provider is not an option, then creating a custom provider might be the best approach. Please use the Chef IRC channel to contact us and we will help you get started.</p>
</div>
<div class="section" id="id12">
<h5>H4 &#8211; Actions &#8211; DONE<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h5>
<p>Actions are defined as list of keywords in a resource:</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">actions</span></tt></td>
<td>A comma-separated list of actions.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">default_action</span></tt></td>
<td>Use to specify which action is the default action.</td>
</tr>
</tbody>
</table>
<p>For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:keyword</span><span class="p">,</span> <span class="ss">:keyword</span>
<span class="n">default_action</span> <span class="ss">:keyword</span>
</pre></div>
</div>
<p>For each action in a resource, a provider must specify what the steps for that action will be. For example, something like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:keyword</span> <span class="k">do</span>
  <span class="n">execute</span> <span class="s2">&quot;keyword resource_name&quot;</span> <span class="k">do</span>
    <span class="c1"># ruby code that defines the action goes here</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-extending-providers-done">
<h5>H4 &#8211; Extending Providers &#8211; DONE<a class="headerlink" href="#h4-extending-providers-done" title="Permalink to this headline">¶</a></h5>
<p>A lightweight provider can extend another provider class. This can be done as a <tt class="docutils literal"><span class="pre">mixin</span></tt>, which is then placed in a library under the <tt class="docutils literal"><span class="pre">library/</span></tt> directory of any cookbook that will use the extended provider class. The lightweight provider is then written to include that library in its implementation so that it has access to the extended core resource.</p>
<p><strong>jamescott: THIS TOPIC NEEDS TO BE REMOVED FROM THE CHEF ESSENTIALS TOPICS. IT IS WAY TOO DETAILED FOR JUST A SHORT PARAGRAPH. IF WE WANT THIS IN THE DOCS, IT HAS TO BE AN ACTUAL SCENARIO THAT ACTUALLY SHOWS HOW THIS IS DONE. LEFT IN FOR POSTERITY FOR NOW, BUT THIS GETS REMOVED BEFORE THIS TOPIC SHIPS.</strong></p>
</div>
</div>
<div class="section" id="h3-example-create-lightweight-provider-and-resource-done">
<h4>H3 &#8211; Example: Create Lightweight Provider and Resource &#8211; DONE<a class="headerlink" href="#h3-example-create-lightweight-provider-and-resource-done" title="Permalink to this headline">¶</a></h4>
<p>A lightweight resource named <tt class="docutils literal"><span class="pre">database.rb</span></tt> should be created and located in the <tt class="docutils literal"><span class="pre">resources/</span></tt> folder of a cookbook. This resource will define the actions for creating and deleting a MySQL database:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">actions</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:delete</span>

<span class="n">attribute</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">,</span> <span class="ss">:name_attribute</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="n">attribute</span> <span class="ss">:type</span><span class="p">,</span> <span class="ss">:kind_of</span> <span class="o">=&gt;</span> <span class="nb">String</span>
</pre></div>
</div>
<p>A lightweight provider named <tt class="docutils literal"><span class="pre">mysql.rb</span></tt> should be created in the <tt class="docutils literal"><span class="pre">providers/</span></tt> folder of the same cookbook. This provider will define the steps required to take the actions that are defined by the resource. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">action</span> <span class="ss">:create</span> <span class="k">do</span>
  <span class="n">execute</span> <span class="s2">&quot;create database&quot;</span> <span class="k">do</span>
    <span class="n">not_if</span> <span class="s2">&quot;mysql -e &#39;show databases;&#39; | grep </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">command</span> <span class="s2">&quot;mysqladmin create </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">action</span> <span class="ss">:delete</span> <span class="k">do</span>
  <span class="n">execute</span> <span class="s2">&quot;delete database&quot;</span> <span class="k">do</span>
    <span class="n">only_if</span> <span class="s2">&quot;mysql -e &#39;show databases;&#39; | grep </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">command</span> <span class="s2">&quot;mysqladmin drop </span><span class="si">#{</span><span class="n">new_resource</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>If the name of the cookbook was <tt class="docutils literal"><span class="pre">opscode</span></tt>, then the short name of the provider that is created is <tt class="docutils literal"><span class="pre">opscode_mysql</span></tt>, where the name of the cookbook and the name of the provider are joined with an underscore to comprise the name of the provider. The <tt class="docutils literal"><span class="pre">load_current_resource</span></tt> method will do nothing (since it is not defined) and the <tt class="docutils literal"><span class="pre">action_create</span></tt> and <tt class="docutils literal"><span class="pre">action_delete</span></tt> methods will be available for use in a recipe. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">opscode_database</span> <span class="s2">&quot;database&quot;</span> <span class="k">do</span>
  <span class="n">type</span> <span class="s2">&quot;innodb&quot;</span>
  <span class="n">action</span> <span class="ss">:create</span>
  <span class="n">provider</span> <span class="s2">&quot;opscode_mysql&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<p>This resource will execute the <tt class="docutils literal"><span class="pre">action</span> <span class="pre">:create</span> <span class="pre">do</span></tt> block in the provider (above) and would create a MySQL database called &#8220;database&#8221;.</p>
</div>
</div>
<div class="section" id="h2-metadata-done">
<h3>H2 &#8211; Metadata &#8211; DONE<a class="headerlink" href="#h2-metadata-done" title="Permalink to this headline">¶</a></h3>
<p>Every cookbook requires a small amount of metadata. This metadata provides hints to the Chef server so that cookbooks are deployed to each node correctly.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>jamescott: remove this? find out if this is true. for the most part it&#8217;s best to not refer too much to future functionality that does not yet exist, at least not from within the &#8220;core documentation&#8221; &#8211; if we want to talk about this stuff, use dedicated topics.</strong> In the future, metadata will be used as part of an automated system for discovering and installing cookbooks.</p>
</div>
<div class="section" id="h3-metadata-rb-done">
<h4>H3 &#8211; metadata.rb &#8211; DONE<a class="headerlink" href="#h3-metadata-rb-done" title="Permalink to this headline">¶</a></h4>
<p>Metadata is stored in a file called metadata.rb that lives at the top of each cookbook&#8217;s directory. When Knife is used to create a cookbook, a metadata.rb file is created automatically.</p>
<p>A metadata.rb file is never interpreted directly. Rather, the metadata.rb file provides a simple location to store and edit data that is then compiled by the Chef server and stored as JSON data. Metadata is compiled whenever the following happens:</p>
<ul class="simple">
<li>A cookbook is uploaded to the Chef server.</li>
<li>The <tt class="docutils literal"><span class="pre">knife</span> <span class="pre">cookbook</span> <span class="pre">metadata</span></tt> sub-command is run.</li>
</ul>
<p>In general, editing metadata should only be done using the metadata.rb file and then either uploading the cookbook to the Chef server or by asking the Chef server to recompile the metadata into JSON data.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A metadata.json file can be edited directly, should temporary changes be required. Any subsequent upload or action that generates metadata will cause the existing metadata.json file to be overwritten with the newly-generated metadata. Therefore, any permanent change to metadata that is required should only be made in the metadata.rb file.</p>
</div>
</div>
<div class="section" id="h3-error-messages-done">
<h4>H3 &#8211; Error Messages &#8211; DONE<a class="headerlink" href="#h3-error-messages-done" title="Permalink to this headline">¶</a></h4>
<p>The Chef server will only try to distribute the cookbooks that are needed to configure an individual node. This is determined by identifying the roles and recipes that are assigned directly to that system, and then to expand the list of dependencies, and then deliver that entire set to the node. In some cases, if the dependency is not specified in the cookbook&#8217;s metadata the Chef server may not treat that dependency as a requirement, which will result in an error message. If an error message is received from the Chef server about cookbook distribution, verify the <tt class="docutils literal"><span class="pre">depends</span></tt> entries in the metadata.rb file, and then try again.</p>
</div>
</div>
<div class="section" id="h2-recipes-done">
<h3>H2 &#8211; Recipes &#8211; DONE<a class="headerlink" href="#h2-recipes-done" title="Permalink to this headline">¶</a></h3>
<p>A recipe is the most fundamental configuration element within the Chef environment. A recipe:</p>
<ul class="simple">
<li>Is authored using Ruby, which is a programming language designed to read and behave exactly as expected. (Ruby is a fairly simple programming language that does not require any previous programming experience.)</li>
<li>Is mostly a collection of resources in a Ruby syntax with some helper code around it</li>
<li>Must define everything that is required to configure part of a system</li>
<li>Must be stored in a cookbook</li>
<li>May be included in a recipe</li>
<li>May use the results of a search query and read the contents of a data bag (including an encrypted data bag)</li>
<li>May have a dependency on one (or more) recipes</li>
<li>May be tagged to facilitate the creation of arbitrary groupings that exist outside of the normal naming conventions an organization may have</li>
<li>Must be added to a run-list before it can be used by Chef</li>
<li>Is always executed in the same order as listed in a run-list</li>
</ul>
<div class="section" id="h3-apply-recipes-to-run-lists-done">
<h4>H3 &#8211; Apply Recipes to Run-lists &#8211; DONE<a class="headerlink" href="#h3-apply-recipes-to-run-lists-done" title="Permalink to this headline">¶</a></h4>
<p>A recipe must be assigned to a run-list using the appropriate name, as defined by the cookbook directory and namespace. For example, a cookbook directory has the following structure:</p>
<div class="highlight-python"><pre>cookbooks/
  apache2/
    recipes/
      default.rb
      mod_ssl.rb</pre>
</div>
<p>There are two recipes: a default recipe (that has the same name as the cookbook) and a recipe named mod_ssl. The syntax that applies a recipe to a run-list is like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;run_list&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="s">&quot;recipe[cookbook_name::default_recipe]&quot;</span><span class="p">,</span>
  <span class="s">&quot;recipe[cookbook_name::recipe_name]&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">::default_recipe</span></tt> is implied (and does not need to be specified). On a node, these recipes can be assigned to a node&#8217;s run-list like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;run_list&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="s">&quot;recipe[apache2]&quot;</span><span class="p">,</span>
  <span class="s">&quot;recipe[apache2::mod_ssl]&quot;</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>jamescott: LOOKS LIKE BIFURCATION FOR CHEF SERVER AND CHEF SOLO IS REQUIRED HERE</strong></p>
<p><strong>jamescott: CHEF SERVER AND CHEF CLIENT BELOW</strong>
Use Knife to add the recipe to the node&#8217;s run-list. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife node run list add NODENAME <span class="s2">&quot;recipe[apache2]&quot;</span>
</pre></div>
</div>
<p>More than one recipe can to be added:</p>
<div class="highlight-bash"><div class="highlight"><pre>% knife node run list add NODENAME <span class="s2">&quot;recipe[apache2],recipe[mysql],role[ssh]&quot;</span>
   run_list:
      recipe<span class="o">[</span>apache2<span class="o">]</span>
      recipe<span class="o">[</span>mysql<span class="o">]</span>
      role<span class="o">[</span>ssh<span class="o">]</span>
</pre></div>
</div>
<p><strong>jamescott: CHEF SERVER AND CHEF CLIENT ABOVE</strong></p>
<p><strong>jamescott: CHEF SOLO BELOW</strong>
Use a JSON file to pass run-list details to Chef Solo as long as the cookbook in which the recipe is located is available to the system on which Chef Solo is running. For example, a JSON file named &#8220;dna.json&#8221; contains the following details:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;run_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;recipe[apache2]&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To add the run-list to the node, enter the following:</p>
<div class="highlight-python"><pre>.. code-block:: bash</pre>
</div>
<blockquote>
<div>$ sudo chef-solo -j /etc/chef/dna.json</div></blockquote>
<p><strong>jamescott: CHEF SOLO ABOVE</strong></p>
</div>
<div class="section" id="h3-include-recipes-in-recipes-done">
<h4>H3 &#8211; Include Recipes in Recipes &#8211; DONE<a class="headerlink" href="#h3-include-recipes-in-recipes-done" title="Permalink to this headline">¶</a></h4>
<p>A recipe can include one (or more) recipes found in other cookbooks by using the <tt class="docutils literal"><span class="pre">include_recipe</span></tt> keyword. When a recipe is included, the resources found in that recipe will be inserted (in the same exact order) at the point where the <tt class="docutils literal"><span class="pre">include_recipe</span></tt> keyword is located. The syntax for including a recipe is like this:</p>
<div class="highlight-python"><pre>include_recipe "recipe"</pre>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>include_recipe "apache2::mod_ssl"</pre>
</div>
<p>If a recipe is included more than once in a recipe, only the first inclusion will be processed and any subsequent inclusion will be ignored.</p>
</div>
<div class="section" id="h3-cookbook-dependencies-done">
<h4>H3 &#8211; Cookbook Dependencies &#8211; DONE<a class="headerlink" href="#h3-cookbook-dependencies-done" title="Permalink to this headline">¶</a></h4>
<p>If a cookbook has a dependency on a recipe that is located in another cookbook, that dependency must be declared in the metadata.rb file for that cookbook using the <tt class="docutils literal"><span class="pre">depends</span></tt> keyword.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Declaring cookbook dependencies is not required with Chef Solo.</p>
</div>
<p>For example, if the following recipe is included in a cookbook named &#8220;my_app&#8221;:</p>
<div class="highlight-python"><pre>include_recipe "apache2::mod_ssl"</pre>
</div>
<p>Then the metadata.rb file for that cookbook would have:</p>
<div class="highlight-python"><pre>depends "apache2"</pre>
</div>
</div>
<div class="section" id="h3-recipe-attributes-done">
<h4>H3 &#8211; Recipe Attributes &#8211; DONE<a class="headerlink" href="#h3-recipe-attributes-done" title="Permalink to this headline">¶</a></h4>
<p>NEEDS DEFINITION</p>
<div class="section" id="id13">
<h5>H4 &#8211; Types &#8211; DONE<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h5>
<p>There are four types of attributes:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">default</span></tt></td>
<td>A default attribute is <strong>jamescott: &#8220;A default attribute is what?&#8221; (other than the obvious) &#8211; but what&#8217;s the difference between default an normal and how does an attribute become a &#8220;default attribute&#8221;?</strong>. A default attribute has the lowest attribute precedence. A default attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses default attributes whenever possible.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">normal</span></tt></td>
<td>A normal attribute is an attribute that persists on the target system . A normal attribute is never reset during a Chef run. A normal attribute has a higher attribute precedence than a default attribute.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">override</span></tt></td>
<td>An override attribute is an attribute that is specified in a recipe (or a run-list) and are often set only for specific roles or nodes. An override attribute has a higher attribute precedence than default or normal attributes. An override attribute is automatically reset each time Chef runs. A cookbook should be authored so that it uses override attributes for role-specific or node-specific values when required.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">automatic</span></tt></td>
<td>An automatic attribute contains data that is automatically-generated by Ohai during every Chef run (all previous values are overwritten by the newly-generated values). An automatic attribute cannot be modified. An automatic attribute has the highest attribute precedence. An automatic attribute is automatically reset each time Chef runs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id14">
<h5>H4 &#8211; Precedence vs. Priority (PICK A WORD!) &#8211; DONE<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h5>
<p>During a Chef run, saved attributes are retrieved from the Chef server and are merged with the attributes on the local system. The attribute type and the source of the attribute determines which attribute values have priority over others. Attribute values are applied in the following order (from low to high priority):</p>
<ul class="simple">
<li>Default attributes applied in an attributes file</li>
<li>Default attributes applied in an environment</li>
<li>Default attributes applied in a role</li>
<li>Default attributes applied on a node directly in a recipe</li>
<li>Normal attributes applied in an attributes file</li>
<li>Normal attributes applied on a node directly in a recipe</li>
<li>Override attributes applied in an attributes file</li>
<li>Override attributes applied in a role</li>
<li>Override attributes applied in an environment</li>
<li>Override attributes applied on a node directly in a recipe</li>
<li>Automatic attributes, re-generated by Ohai during each Chef run.</li>
</ul>
</div>
<div class="section" id="id15">
<h5>H4 &#8211; Persistence &#8211; DONE<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h5>
<p>At the beginning of a Chef run, all default, override, and automatic attributes are reset. Chef rebuilds these attributes by based on attributes contained in cookbooks, recipes, roles, and environments, plus Ohai data that is collected about that node at the beginning of the Chef run. Normal attributes are never reset. During a Chef run, any new attributes that are passed to the chef-client are merged with the existing normal attributes on the node and any new settings are applied according to attribute precedence. At the conclusion of the Chef run, all default, override, and automatic attributes disappear, leaving only a collection of normal attributes that will persist until the next Chef run.</p>
<p><strong>jamescott: THIS ONE NEEDS TO BE REVIEWED. SEE http://wiki.opscode.com/display/chef/Attributes AND READ &#8220;ATTRIBUTE PERSISTENCE&#8221; AND THEN READ THE ABOVE AND PROVIDE FEEDBACK.</strong></p>
</div>
<div class="section" id="id16">
<h5>H4 &#8211; Automatic Attributes &#8211; DONE<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h5>
<p>An automatic attribute is data that must be understood, but not modified. For example, the IP address of a node, a host name, or the number of loaded kernel modules. When Chef makes changes to a system during a Chef run, automatic attributes are used to ensure that Chef does not make changes to the larger environment on which a node is running. An automatic attribute always has the highest attribute precedence. Automatic attributes are saved to the Chef server where they are indexed for search. Automatic attributes are detected by Ohai before every Chef run.</p>
</div>
<div class="section" id="id17">
<h5>H4 &#8211; Notation &#8211; DONE<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h5>
<p>Attributes are a special key-value store called a mash within the context of the Ruby DSL. A mash is just a hash where the key can be either a symbol (:key) or a string (&#8220;key&#8221;).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Individuals who are new to Ruby and Chef may have an easier time using only string notation. This approach allows attributes to &#8220;be quoted&#8221; and doesn&#8217;t require learning about special cases, namespace overlap (and <tt class="docutils literal"><span class="pre">method_missing</span></tt>), character constraints, and escaping.</p>
</div>
</div>
<div class="section" id="h4-attribute-methods">
<h5>H4 &#8211; Attribute Methods<a class="headerlink" href="#h4-attribute-methods" title="Permalink to this headline">¶</a></h5>
<p><strong>jamescott: THIS IS NOT DONE. NEED DEFINITION/LIST TABLE FOR BELOW.</strong></p>
<p>Use the following methods within a cookbook&#8217;s attributes file or in a recipe. They correspond to the attribute type of the same name (set is an alias for normal).</p>
<ul class="simple">
<li>override</li>
<li>default</li>
<li>normal (or set)</li>
<li>_unless</li>
<li>attribute?</li>
</ul>
<p>Additionally, there are _unless methods available. See the end of this document for information on conditionally setting attributes</p>
<p>Another handy method available related to attributes is the attribute? method. This will check for the existence of an attribute, so you can do processing in an attributes file or recipe only if a specific attribute exists.</p>
<p>attribute?() in attributes file</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;ec2&quot;</span><span class="p">)</span>
  <span class="c1"># ... set stuff related to EC2</span>
<span class="k">end</span>
</pre></div>
</div>
<p>attribute?() in recipe</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;ec2&quot;</span><span class="p">)</span>
  <span class="c1"># ... do stuff on EC2 nodes</span>
<span class="k">end</span>
</pre></div>
</div>
<p>In the recipe, we need to use the method on the node object. In the attributes file, the node object is implicit. In either, we can also look for a sub-key of an attribute by chaining the attribute as methods:</p>
<p>attribute?() in recipe</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">chef</span><span class="o">.</span><span class="n">attribute?</span><span class="p">(</span><span class="s2">&quot;webui_enabled&quot;</span><span class="p">)</span>
  <span class="c1"># set up webui stuff</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h4-reloading-attributes-from-recipes">
<h5>H4 &#8211; Reloading Attributes From Recipes<a class="headerlink" href="#h4-reloading-attributes-from-recipes" title="Permalink to this headline">¶</a></h5>
<p>Attributes sometimes depend on actions taken from within recipes, so it may be necessary to reload a given attribute from within a recipe. For example: if you have an attribute that reads firewall rules, and a recipe that installs a firewall package, the firewall attributes will not be set the first time you execute the cookbook. Since <tt class="docutils literal"><span class="pre">include_attribute</span></tt> is not available from inside recipes, you will need to manually reload your <tt class="docutils literal"><span class="pre">firewall::default</span> <span class="pre">attribute</span></tt> from recipes by doing something like:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s1">&#39;iptables&#39;</span> <span class="k">do</span>
  <span class="n">notifies</span> <span class="ss">:create</span><span class="p">,</span> <span class="s1">&#39;ruby_block[try_firewall_again]&#39;</span><span class="p">,</span> <span class="ss">:immediately</span>
<span class="k">end</span>

<span class="n">ruby_block</span> <span class="s1">&#39;try_firewall_again&#39;</span> <span class="k">do</span>
  <span class="n">block</span> <span class="k">do</span>
    <span class="n">node</span><span class="o">.</span><span class="n">load_attribute_by_short_filename</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;firewall&#39;</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">action</span> <span class="ss">:nothing</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Attribute accessor methods are automatically created and the method invocation can be used interchangeably with the keys. For example:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">dir</span>          <span class="o">=</span> <span class="s2">&quot;/etc/apache2&quot;</span>
<span class="n">default</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">listen_ports</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;80&quot;</span><span class="p">,</span><span class="s2">&quot;443&quot;</span> <span class="o">]</span>
</pre></div>
</div>
<p>This is a matter of style and preference for how attributes are reloaded from recipes <strong>jamescott: check the wiki page here</strong>, and may be seen when &#8220;retrieving&#8221; the value of an attribute.</p>
</div>
</div>
<div class="section" id="id18">
<h4>H3 &#8211; Search Indexes &#8211; DONE<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h4>
<p>Search indexes allow queries to be made for any type of data that is indexed by a Chef server, including data for a chef-client, data bags (and data bag items), environments, nodes, and roles. Chef has a defined query syntax that includes search patterns like exact, wildcard, range, and fuzzy. The search engine is based on Apache Solr and is run from a Chef server. A search is a full-text query that can be done from within a recipe or by using the <tt class="docutils literal"><span class="pre">search</span></tt> sub-command in Knife.</p>
<p>The results of a search query can be loaded into a recipe. For example, a very simple search query (in a recipe) might look like this:</p>
<div class="highlight-python"><pre>search(:node, "attribute:value")</pre>
</div>
<p>A search query can be assigned to variables and then used elsewhere in a recipe. For example, to search for all nodes that have a role assignment named &#8220;webserver&#8221;, and then render a template which includes those role assignments:</p>
<div class="highlight-python"><pre>webservers = search(:node, "role:webserver")::

template "/tmp/list_of_webservers" do
  source "list_of_webservers.erb"
  variables(:webservers =&gt; webservers)
end</pre>
</div>
</div>
<div class="section" id="h3-data-bags-done">
<h4>H3 &#8211; Data Bags &#8211; DONE<a class="headerlink" href="#h3-data-bags-done" title="Permalink to this headline">¶</a></h4>
<p>A data bag is a read-only global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search. The contents of a data bag can vary, but they often include sensitive information (such as database passwords). The contents of a data bag can also be encrypted to prevent the contents of that data bag from being compromised.</p>
<p>The contents of a data bag can be loaded into a recipe. For example, a data bag named &#8220;apps&#8221; and a data bag item named &#8220;my_app&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
  <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="s">&quot;my_app&quot;</span><span class="p">,</span>
  <span class="s">&quot;repository&quot;</span><span class="p">:</span> <span class="s">&quot;git://github.com/company/my_app.git&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>can be accessed in a recipe, like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_bag</span> <span class="o">=</span> <span class="n">data_bag_item</span><span class="p">(</span><span class="s">&quot;apps&quot;</span><span class="p">,</span> <span class="s">&quot;my_app&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The data bag item&#8217;s keys and values can be accessed with a Ruby hash:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">my_bag</span><span class="p">[</span><span class="s">&quot;repository&quot;</span><span class="p">]</span> <span class="c">#=&gt; &quot;git://github.com/company/my_app.git&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-other-recipe-dsl-methods-done-deprecate">
<h4>H3 &#8211; Other Recipe DSL Methods &#8211; DONE, DEPRECATE?<a class="headerlink" href="#h3-other-recipe-dsl-methods-done-deprecate" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: DEPRECATE THIS MOFO. There should be a doc called &#8220;Recipe DSL Methods&#8221; (or some such appropriately-titled doc) that describes the DSL methods available to recipes. There are a few known: platform?, attribute?, value_for_platform, and perhaps others? NEED TO FIND OUT.</strong></p>
<p>The only thing that should remain here is the INCLUDE overview for Recipe DSL. Stubbed out, waiting for more info. Included.**</p>
</div>
<div class="section" id="h3-tags-done-but-weak">
<h4>H3 &#8211; Tags &#8211; DONE, BUT WEAK<a class="headerlink" href="#h3-tags-done-but-weak" title="Permalink to this headline">¶</a></h4>
<p>A tag is a custom description that is applied to a node. A tag, once applied, can be helpful when managing nodes using Knife or when building recipes by providing alternate methods of grouping similar types of information.</p>
<p>Tags can be added and remove. Machines can be checked to see if they already have a specific tag. To use tags in your recipe simply add the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">tag</span><span class="p">(</span><span class="s">&#39;mytag&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To test if a machine is tagged, add the following:</p>
<div class="highlight-python"><pre>tagged?('mytag')</pre>
</div>
<p>to return <tt class="docutils literal"><span class="pre">true</span></tt> or <tt class="docutils literal"><span class="pre">false</span></tt>. <tt class="docutils literal"><span class="pre">tagged?</span></tt> can also use an array as an argument.</p>
<p>To remove a tag:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">untag</span><span class="p">(</span><span class="s">&#39;mytag&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-python"><pre>tag("machine")

if tagged?("machine")
   Chef::Log.info("Hey I'm #{node[:tags]}")
end

untag("machine")

if not tagged?("machine")
   Chef::Log.info("I has no tagz")
end</pre>
</div>
<p>Will return something like this:</p>
<div class="highlight-python"><pre>[Thu, 22 Jul 2010 18:01:45 +0000] INFO: Hey I'm machine
[Thu, 22 Jul 2010 18:01:45 +0000] INFO: I has no tagz</pre>
</div>
</div>
<div class="section" id="h3-ruby-in-recipes-done">
<h4>H3 &#8211; Ruby in Recipes &#8211; DONE<a class="headerlink" href="#h3-ruby-in-recipes-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: This might be a good candidate for single-source inclusion into some type of section about &#8220;Using Ruby with Chef&#8221; (which would include the &#8220;Just Enough Ruby for Chef&#8221; topic, among other things).</strong></p>
<p>Anything that can be done with Ruby can be used within a recipe, such as expressions (if, unless, etc.), case statements, loop statements, arrays, hashes, and variables. In Ruby the conditionals <tt class="docutils literal"><span class="pre">nil</span></tt> and <tt class="docutils literal"><span class="pre">false</span></tt> are false; every other conditional is <tt class="docutils literal"><span class="pre">true</span></tt>.</p>
<p>A variable uses an equals sign (&#8220;=&#8221;) to assign a value.</p>
<p>To assign a value to a variable:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package_name</span> <span class="o">=</span> <span class="s2">&quot;apache2&quot;</span>
</pre></div>
</div>
<p>A case statement can be used to compare an expression (specified by case) and then executing the code that matches the expression.</p>
<p>To select a package name based on platform:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;apache2&quot;</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">node</span><span class="o">[</span><span class="ss">:platform</span><span class="o">]</span>
  <span class="k">when</span> <span class="s2">&quot;centos&quot;</span><span class="p">,</span><span class="s2">&quot;redhat&quot;</span><span class="p">,</span><span class="s2">&quot;fedora&quot;</span><span class="p">,</span><span class="s2">&quot;suse&quot;</span>
    <span class="n">package_name</span> <span class="s2">&quot;httpd&quot;</span>
  <span class="k">when</span> <span class="s2">&quot;debian&quot;</span><span class="p">,</span><span class="s2">&quot;ubuntu&quot;</span>
    <span class="n">package_name</span> <span class="s2">&quot;apache2&quot;</span>
  <span class="k">when</span> <span class="s2">&quot;arch&quot;</span>
    <span class="n">package_name</span> <span class="s2">&quot;apache&quot;</span>
  <span class="k">end</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</pre></div>
</div>
<p>An if expression can be used to check for conditions (true or false).</p>
<p>To check for condition only for Debian and Ubuntu platforms:</p>
<div class="highlight-ruby"><pre>if platform?(“debian”, “ubuntu”)
  # do something if node[‘platform’] is debian or ubuntu
else
  # do other stuff
end</pre>
</div>
<p>An unless expression can be used to execute code when a condition returns a false value (effectively, an unless expression is the opposite of an if statement).</p>
<p>To use an expression to execute when a condition returns a false value:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="k">unless</span> <span class="n">node</span><span class="o">[</span><span class="ss">:platform_version</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;5.0&quot;</span>
  <span class="c1"># do stuff on everything but 5.0</span>
<span class="k">end</span>
</pre></div>
</div>
<p>A hash is a collection of key-value pairs. Indexing for a hash is done using arbitrary keys of any object (as opposed to the indexing done by an array). The syntax for a hash is: <tt class="docutils literal"><span class="pre">key</span> <span class="pre">=&gt;</span> <span class="pre">&quot;value&quot;</span></tt>.</p>
<p>To loop over a hash of gem package names:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;fog&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;0.6.0&quot;</span><span class="p">,</span> <span class="s2">&quot;highline&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;1.6.0&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">g</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
  <span class="n">gem_package</span> <span class="n">g</span> <span class="k">do</span>
    <span class="n">version</span> <span class="n">v</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>A loop statement is used to execute a block of code one (or more) times. A loop statement is created when <tt class="docutils literal"><span class="pre">.each</span></tt> is added to an expression that defines an array or a hash. An array is an integer-indexed collection of objects. Each element in an array can be associated with and referred to by an index.</p>
<p>To loop over an array of package names by platform:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="o">[</span><span class="s2">&quot;apache2&quot;</span><span class="p">,</span> <span class="s2">&quot;apache2-mpm&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
  <span class="n">package</span> <span class="nb">p</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-exceptions-and-logging-done">
<h4>H3 &#8211; Exceptions and Logging &#8211; DONE<a class="headerlink" href="#h3-exceptions-and-logging-done" title="Permalink to this headline">¶</a></h4>
<p>A recipe can write events to a Chef log file and can cause exceptions using <tt class="docutils literal"><span class="pre">Chef::Log</span></tt>. The levels include <tt class="docutils literal"><span class="pre">debug</span></tt>, <tt class="docutils literal"><span class="pre">info</span></tt>, <tt class="docutils literal"><span class="pre">warn</span></tt>, <tt class="docutils literal"><span class="pre">error</span></tt>, and <tt class="docutils literal"><span class="pre">fatal</span></tt>. For example, to just capture information:</p>
<div class="highlight-python"><pre>Chef::Log.info('some useful information')</pre>
</div>
<p>Or to trigger a fatal exception:</p>
<div class="highlight-python"><pre>Chef::Log.fatal('something bad')</pre>
</div>
<p><strong>jamescott: seems like this is best as &#8220;just noted&#8221; in this section and CONSOLIDATED under essentials_exception_and_report_handlers. YEAH, DO THAT</strong></p>
</div>
</div>
<div class="section" id="h2-resources-and-providers-done">
<h3>H2 - Resources and Providers &#8211; DONE<a class="headerlink" href="#h2-resources-and-providers-done" title="Permalink to this headline">¶</a></h3>
<p>A resource is a key part of a recipe. A resource defines the actions that can be taken, such as when a package should be installed, whether a service should be enabled or restarted, which groups, users, or groups of users should be created, where to put a collection of files, what the name of a new directory should be, and so on. During a Chef run, each resource is identified and then associated with a provider. The provider then does the work to complete the action defined by the resource. Chef ensures that the same actions are taken the same way everywhere and that actions are idempotent. A resource is implemented within a recipe using Ruby.</p>
<p>A resource represents a piece of the system, its current state, and the action that is needed to move it to a desired state. A provider defines the path required to bring that piece of the system from its current to the desired state. An action is de-coupled from the steps required to complete that action, which means that a provider exists for each of the paths that are required to complete the action. This is important because a single action may require different steps, depending on the platform of the system on which the action is being taken.</p>
<p>For example, &#8220;install a package&#8221; is a single action. To install a package onto various platforms, the steps required steps for each of those platforms may be different. This requires  different providers. On a Red Hat or CentOS machine a provider will use the Yum package provider to get the package installed and on a Debian or an Ubuntu machine a provider will use the APT package installer. One action, two providers, each taking only the steps required to complete that action.</p>
<div class="section" id="h3-resources-syntax-done">
<h4>H3 &#8211; Resources Syntax &#8211; DONE<a class="headerlink" href="#h3-resources-syntax-done" title="Permalink to this headline">¶</a></h4>
<p>A resource is a Ruby block with four components: a type, a name, one (or more) parameters (with attributes), and one (or more) actions. The syntax for a resource is like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">type</span> <span class="s2">&quot;name&quot;</span> <span class="k">do</span>
   <span class="n">parameter</span> <span class="s2">&quot;attribute&quot;</span>
   <span class="n">action</span> <span class="ss">:type_of_action</span>
<span class="k">end</span>
</pre></div>
</div>
<p>For example, a resource that is used to install a tar.gz package for version 1.16.1 may look something like this:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">package</span> <span class="s2">&quot;tar&quot;</span> <span class="k">do</span>
  <span class="n">version</span> <span class="s2">&quot;1.16.1-1&quot;</span>
  <span class="n">action</span> <span class="ss">:install</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Every resource in Chef has its own set of parameters and actions. Many parameters have default attributes. Some parameters are available to all resources; these are sometimes referred to as &#8220;meta&#8221; parameters and they are commonly used to send notifications to other resources or to set up conditional execution rules. All actions have a default value. Only non-default behaviors of parameters and actions need to be specified.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Attributes used with resource parameters are not the same as the attributes associated with nodes.</p>
</div>
</div>
<div class="section" id="h3-platform-resources-done">
<h4>H3 &#8211; Platform Resources &#8211; DONE<a class="headerlink" href="#h3-platform-resources-done" title="Permalink to this headline">¶</a></h4>
<p>The following resources are built into Chef:</p>
<table border="1" class="docutils">
<colgroup>
<col width="23%" />
<col width="77%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Resource</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Cookbook File</td>
<td>The Cookbook File resource is used to transfer files from a sub-directory of the <tt class="docutils literal"><span class="pre">files/</span></tt> directory in a cookbook to a specified path on the host running the chef-client or Chef Solo. <strong>jamescott: what about uploads to the Chef Hosted/Private servers?</strong> The file in a cookbook is selected according to file specificity, which allows different source files to be used based on the hostname, host platform (operating system, distro, or as appropriate), or platform version. Place files under COOKBOOK_NAME/files/default to use them on any platform.</td>
</tr>
<tr class="row-odd"><td>Cron</td>
<td>The Cron resource is used to manage cron entries for time-based job scheduling. Attributes for a schedule will default to <tt class="docutils literal"><span class="pre">*</span></tt> of not provided, so only specify scheduling attributes that are applicable to a cron entry. The Cron resource requires that a package be installed that provides the crontab program, typically cron.</td>
</tr>
<tr class="row-even"><td>Deploy</td>
<td>The Deploy resource is used to manage and control deployments. There is a large number of attributes available for this resource that can be used to specify many different behaviors. Please review them carefully before deciding on which approach is required for a particular recipe.</td>
</tr>
<tr class="row-odd"><td>Directory</td>
<td>The Directory resource is used to manage a directory.</td>
</tr>
<tr class="row-even"><td>Env</td>
<td>The Env resource is used to manage environment keys in Microsoft Windows. After an environment key is set, Microsoft Windows must be restarted before the environment key will be available to the Task Scheduler.</td>
</tr>
<tr class="row-odd"><td>Erlang Call</td>
<td>The Erlang Call resource is used to connect to a node located within a distributed Erlang system. An Erlang Call resource is not idempotent. Use the <tt class="docutils literal"><span class="pre">not_if</span></tt> and <tt class="docutils literal"><span class="pre">only_if</span></tt> meta parameters to guard the use of this resource for idempotence.</td>
</tr>
<tr class="row-even"><td>Execute</td>
<td>The Execute resource is used to execute a command. Commands that are executed with this resource are (by their nature) not idempotent, as they are typically unique to the environment in which they are run. Use the <tt class="docutils literal"><span class="pre">not_if</span></tt> and <tt class="docutils literal"><span class="pre">only_if</span></tt> meta parameters to guard the use of this resource for idempotence.</td>
</tr>
<tr class="row-odd"><td>File</td>
<td>The File resource is used to manage files that are present on a node, including setting or updating the contents of those files.</td>
</tr>
<tr class="row-even"><td>Group</td>
<td>The Group resource is used to manage a local group.</td>
</tr>
<tr class="row-odd"><td>HTTP Request</td>
<td>The HTTP Request resource is used to send an HTTP request (GET, PUT, POST, DELETE, HEAD, or OPTIONS) with an arbitrary message. This resource is useful when custom callbacks are necessary.</td>
</tr>
<tr class="row-even"><td>Ifconfig</td>
<td>The Ifconfig resource is used to manage interfaces.</td>
</tr>
<tr class="row-odd"><td>Link</td>
<td>The Link resource is used to create symbolic or hard links.</td>
</tr>
<tr class="row-even"><td>Log</td>
<td>The Log resource is used to create log entries from a recipe.</td>
</tr>
<tr class="row-odd"><td>MDADM</td>
<td>The MDADM resource is used to manage mdadm software RAID devices in a Linux environment. The MDADM provider will create and assemble an array, but it will not create the config file that is used to persist the array upon reboot. If the config file is required, it must be done by specifying a template with the correct array layout, and then by using the Mount provider to create a file systems table (fstab) entry.</td>
</tr>
<tr class="row-even"><td>Mount</td>
<td>The Ohai resource is used to reload the Ohai configuration on node. This allows recipes that have changed system attributes (such as adding a user) to refer to those attributes later in the recipe.</td>
</tr>
<tr class="row-odd"><td>Ohai</td>
<td>The Ohai resource is used to re-load the Ohai configuration on a node. This allows recipes that change system attributes (like adding a user) to refer to those attributes later on during the Chef run.</td>
</tr>
<tr class="row-even"><td>Package</td>
<td>The Package resource is used to manage packages. When the package is installed from a local file (such as RubyGems dkpg or RPM Package Manager) the file must be added to the node using the Remote File or Cookbook File resources.</td>
</tr>
<tr class="row-odd"><td>PowerShell Script</td>
<td><p class="first">The PowerShell Script resource is used to execute a script using the Windows PowerShell interpreter.</p>
<ul class="simple">
<li>This resource is used just like the Script resource or the providers for Bash, Csh, Perl, Python, and Ruby. The PowerShell Script resource is similar to those, but with some small tweaks under the covers for the Microsoft Windows platform and Windows PowerShell interpreter.</li>
<li>This resource creates and executes a temporary file (similar to the Script resource), rather than running it inline.</li>
<li>This resource includes actions (<tt class="docutils literal"><span class="pre">:run</span></tt> and <tt class="docutils literal"><span class="pre">:nothing</span></tt>; ) and attributes (<tt class="docutils literal"><span class="pre">creates</span></tt>, <tt class="docutils literal"><span class="pre">cwd</span></tt>, <tt class="docutils literal"><span class="pre">environment</span></tt>, <tt class="docutils literal"><span class="pre">group</span></tt>, <tt class="docutils literal"><span class="pre">path</span></tt>, <tt class="docutils literal"><span class="pre">timeout</span></tt>, and <tt class="docutils literal"><span class="pre">user</span></tt>) that are available from the Execute resource.</li>
</ul>
<p class="last">Commands that are executed with this resource are (by their nature) not idempotent, as they are typically unique to the environment in which they are run. Use the <tt class="docutils literal"><span class="pre">not_if</span></tt> and <tt class="docutils literal"><span class="pre">only_if</span></tt> meta parameters to guard the use of this resource for idempotence.</p>
</td>
</tr>
<tr class="row-even"><td>Remote Directory</td>
<td>The Directory resource is used to manage a directory.</td>
</tr>
<tr class="row-odd"><td>Remote File</td>
<td>The Remote File resource is used to transfer a file from a remote location using file specificity. This resource is similar to File.</td>
</tr>
<tr class="row-even"><td>Route</td>
<td>The Route resource is used to manage the system routing table in a Linux environment.</td>
</tr>
<tr class="row-odd"><td>Ruby Block</td>
<td>The Ruby Block resource is used to execute Ruby code during a Chef run. Ruby code in the <tt class="docutils literal"><span class="pre">ruby_block</span></tt> resource is evaluated with other resources during convergence, whereas Ruby code outside of a <tt class="docutils literal"><span class="pre">ruby_block</span></tt> resource is evaluated before other resources, as the recipe is compiled.</td>
</tr>
<tr class="row-even"><td>Source Control Management (SCM)</td>
<td>The Source Control Management (SCM) resource is used to manage source control resources that exist in a git repository or a Subversion repository.</td>
</tr>
<tr class="row-odd"><td>Script</td>
<td>The Script resource is used to execute using the specified interpreter (Bash, Csh, Perl, Python, or Ruby). This resource includes all of the actions and attributes that are available to the Execute resource. The Ruby script resource is different from the Ruby Block resource because Ruby run with the Script resource is created as a temporary file and executed like other script resources, rather than run inline. Commands that are executed with this resource are (by their nature) not idempotent, as they are typically unique to the environment in which they are run. Use the <tt class="docutils literal"><span class="pre">not_if</span></tt> and <tt class="docutils literal"><span class="pre">only_if</span></tt> meta parameters to guard the use of this resource for idempotence.</td>
</tr>
<tr class="row-even"><td>Service</td>
<td>The Service resource is used to manage a service.</td>
</tr>
<tr class="row-odd"><td>Template</td>
<td>The Template resource is used to manage file contents with an embedded Ruby (erb) template. This resource includes actions and attributes from the File resource. Templates follow the same file specificity rules as the Remote File and File resources.</td>
</tr>
<tr class="row-even"><td>User</td>
<td>The User resource is used to manage a local user.</td>
</tr>
<tr class="row-odd"><td>Yum Package</td>
<td>The Yum Package resource is used to use yum for installation, upgrade, and removal of packages. This resource is able to resolve provides data for packages much like yum can do when running it from the command line. This allows a variety of options for installing packages, like minimum versions, virtual provides, and library names.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-platform-providers-done">
<h4>H3 &#8211; Platform Providers &#8211; DONE<a class="headerlink" href="#h3-platform-providers-done" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">Chef::Platform</span></tt> class maps providers to platforms (and platform versions). Ohai, as part of every Chef run, verifies the <tt class="docutils literal"><span class="pre">platform</span></tt> and <tt class="docutils literal"><span class="pre">platform_version</span></tt> attributes on each node, and then Chef uses those values to identify the correct provider, build an instance of that provider, identify the current state of the resource, do the specified action, and then mark the resource as updated (if changes were made). For example, given the following resource:</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="n">directory</span> <span class="s2">&quot;/tmp/folder&quot;</span> <span class="k">do</span>
  <span class="n">owner</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">group</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">mode</span> <span class="mo">0755</span>
  <span class="n">action</span> <span class="ss">:create</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Chef will look up the provider for the <tt class="docutils literal"><span class="pre">directory</span></tt> resource, which happens to be <tt class="docutils literal"><span class="pre">Chef::Provider::Directory</span></tt>, call <tt class="docutils literal"><span class="pre">load_current_resource</span></tt> to create a new resource called <tt class="docutils literal"><span class="pre">directory[&quot;/tmp/folder&quot;]</span></tt>, and then based on the current state of the directory, do the specified action, which in this case is to create a directory called <tt class="docutils literal"><span class="pre">/tmp/folder</span></tt>. If the directory already exists, nothing will happen. If the directory was changed in any way, the resource is marked as updated.</p>
</div>
</div>
<div class="section" id="h2-templates-done">
<h3>H2 &#8211; Templates &#8211; DONE<a class="headerlink" href="#h2-templates-done" title="Permalink to this headline">¶</a></h3>
<p>A cookbook template is a file written in a markup language that allows the contents of a file to be dynamically generated based on variables or complex logic. Templates can contain Ruby expressions and statements. Templates are a great way to manage configuration files across a Chef environment. A template requires a template resource being added to a recipe and then a corresponding erb template being added to a cookbook.</p>
<p><strong>jamescott: this needs to be revised includes_chef_cookbook_template</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Chef uses Erubis for templates, which is a fast, secure, and extensible implementation of embedded Ruby. Erubis should be familiar to members of the Ruby on Rails, Merb, or Puppet communities. For more information about Erubis, see: <a class="reference external" href="http://www.kuwata-lab.com/erubis/">http://www.kuwata-lab.com/erubis/</a>.</p>
</div>
<div class="section" id="h3-requirements-done">
<h4>H3 &#8211; Requirements &#8211; DONE<a class="headerlink" href="#h3-requirements-done" title="Permalink to this headline">¶</a></h4>
<p>To use a template, two things must happen:</p>
<ol class="arabic simple">
<li>A template resource must be added to a recipe</li>
<li>An erb template must be added to a cookbook</li>
</ol>
<p>For example, the following template file and template resource settings can be used to manage a configuration file named <tt class="docutils literal"><span class="pre">/etc/sudoers</span></tt>. Within a cookbook that uses Indicates that a bootstrap operation should be executed using sudo., the following resource could be added to <tt class="docutils literal"><span class="pre">recipes/default.rb</span></tt> <strong>(jamescott: SWAP/PATH)</strong>:</p>
<div class="highlight-python"><pre>template "/etc/sudoers" do
  source "sudoers.erb"
  mode 0440
  owner "root"
  group "root"
  variables({
     :sudoers_groups =&gt; node[:authorization][:sudo][:groups],
     :sudoers_users =&gt; node[:authorization][:sudo][:users]
  })
end</pre>
</div>
<p><strong>jamescott: it would be ideal if we could put some explanation around what this resource does.</strong></p>
<p>And then create a template called <tt class="docutils literal"><span class="pre">sudoers.erb</span></tt> and save it to <tt class="docutils literal"><span class="pre">templates/default/sudoers.erb</span></tt>:</p>
<div class="highlight-python"><pre>#
# /etc/sudoers
#
# Generated by Chef for &lt;%= node[:fqdn] %&gt;
#

Defaults        !lecture,tty_tickets,!fqdn

# User privilege specification
root          ALL=(ALL) ALL

&lt;% @sudoers_users.each do |user| -%&gt;
&lt;%= user %&gt;   ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL
&lt;% end -%&gt;

# Members of the sysadmin group may gain root privileges
%sysadmin     ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL

&lt;% @sudoers_groups.each do |group| -%&gt;
# Members of the group '&lt;%= group %&gt;' may gain root privileges
%&lt;%= group %&gt; ALL=(ALL) &lt;%= "NOPASSWD:" if @passwordless %&gt;ALL
&lt;% end -%&gt;</pre>
</div>
<p><strong>jamescott: it would be ideal if we could put some explanation around what this template does.</strong></p>
<p>And then set the default attributes in <tt class="docutils literal"><span class="pre">attributes/default.rb</span></tt> <strong>(jamescott: NEED PATH/SWAP)</strong>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">default</span><span class="p">[</span><span class="s">&quot;authorization&quot;</span><span class="p">][</span><span class="s">&quot;sudo&quot;</span><span class="p">][</span><span class="s">&quot;groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;sysadmin&quot;</span><span class="p">,</span><span class="s">&quot;wheel&quot;</span><span class="p">,</span><span class="s">&quot;admin&quot;</span> <span class="p">]</span>
<span class="n">default</span><span class="p">[</span><span class="s">&quot;authorization&quot;</span><span class="p">][</span><span class="s">&quot;sudo&quot;</span><span class="p">][</span><span class="s">&quot;users&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;jerry&quot;</span><span class="p">,</span><span class="s">&quot;greg&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="h3-variables-done">
<h4>H3 &#8211; Variables &#8211; DONE<a class="headerlink" href="#h3-variables-done" title="Permalink to this headline">¶</a></h4>
<p>A Chef template is an erb template. An erb template allows Ruby code to be embedded inside a text file within specially formatted tags. Ruby code can be embedded using expressions and statements. An expression is delimited by <tt class="docutils literal"><span class="pre">&lt;%=</span></tt> and <tt class="docutils literal"><span class="pre">%&gt;</span></tt>. For example:</p>
<div class="highlight-python"><pre>``&lt;%= "my name is #{$ruby}" %&gt;``</pre>
</div>
<p>A statement is delimited by <tt class="docutils literal"><span class="pre">&lt;%</span></tt> and <tt class="docutils literal"><span class="pre">-%&gt;</span></tt>. For example:</p>
<div class="highlight-python"><pre>if false
   # this won't happen
elsif nil
   # this won't either
else
   # code here will run though
end</pre>
</div>
<p>Using a Ruby expression is the most common approach because this is how all variables sent to a template are referenced. Whenever a template needs to use an <tt class="docutils literal"><span class="pre">each</span></tt>, <tt class="docutils literal"><span class="pre">if</span></tt>, or <tt class="docutils literal"><span class="pre">end</span></tt>, use a Ruby statement.</p>
<p>When a template is rendered, Ruby expressions and statements are evaluated by Chef. The variables listed in the resource&#8217;s variables attribute and the node object are identified. Chef then passes these variables to the template, where they will be accessible as instance variables within the template; a node object can be accessed just as if it were part of a recipe, using the same node.</p>
<p>For example, a simple template resource like this:</p>
<div class="highlight-python"><pre>node[:fqdn] = "latte"
template "/tmp/foo" do
  source "foo.erb"
  variables({
    :x_men =&gt; "are keen"
  })
end</pre>
</div>
<p>And a simple erb template like this:</p>
<div class="highlight-python"><pre>The node &lt;%= node[:fqdn] %&gt; thinks the x-men &lt;%= @x_men %&gt;</pre>
</div>
<p>Would render something like:</p>
<div class="highlight-python"><pre>The node latte thinks the x-men are keen</pre>
</div>
<p>Even though this is a very simple example, the full capabilities of Ruby can be used to tackle even the most complex and demanding template requirements.</p>
</div>
<div class="section" id="h3-location-specificity-done">
<h4>H3 &#8211; Location Specificity &#8211; DONE<a class="headerlink" href="#h3-location-specificity-done" title="Permalink to this headline">¶</a></h4>
<p><strong>jamescott: I found this section a tad confusing on the Wiki &#8211; the verbiage didn&#8217;t make sense, so I rewrote it to &#8220;make sense&#8221; which means that this section should be reviewed carefully by someone who actually understands it, in case I misunderstood the point I thought the article was trying to make.</strong></p>
<p>A cookbook will frequently be designed to work across many platforms. A template often needs to be specific to a platform, host, or function of a node. When these differences are minor, they can often be handled with a small amount of logic within the template itself. When these differences are significant, a cookbook can be designed to use many templates. Chef will determine the correct template based on the rules that are provided to it.</p>
<p>For example, a cookbook that has a directory structure like this:</p>
<div class="highlight-python"><pre>templates/
   host-foo.example.com
   ubuntu-8.04
   ubuntu
   default</pre>
</div>
<p>would be matched in the same order. For a node named &#8220;foo.example.com&#8221; and resource named <tt class="docutils literal"><span class="pre">sudoers.erb</span></tt>, matching would occur in the following order:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">host</span><span class="o">-</span><span class="n">foo</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">sudoers</span><span class="o">.</span><span class="n">erb</span>
<span class="n">ubuntu</span><span class="o">-</span><span class="mf">8.04</span><span class="o">/</span><span class="n">sudoers</span><span class="o">.</span><span class="n">erb</span>
<span class="n">ubuntu</span><span class="o">/</span><span class="n">sudoers</span><span class="o">.</span><span class="n">erb</span>
<span class="n">default</span><span class="o">/</span><span class="n">sudoers</span><span class="o">.</span><span class="n">erb</span>
</pre></div>
</div>
<p>If the <tt class="docutils literal"><span class="pre">sudoers.rb</span></tt> resource was placed under the <tt class="docutils literal"><span class="pre">files/host-foo.example.com/</span></tt> directory, then it would only be copied to a machine with the domain name <tt class="docutils literal"><span class="pre">foo.example.com</span></tt>.</p>
<p><strong>jamescott: THE SECTION IMMEDIATELY BELOW MAKES SENSE, BUT DOESN&#8217;T MAKE SENSE. COME BACK TO THIS ONE</strong></p>
<p>So, the rule distilled:</p>
<ol class="arabic simple">
<li>host-node[:fqdn]</li>
<li>node[:platform]-node[:platform_version]</li>
<li>node[:platform]</li>
<li>default</li>
</ol>
<p>where <tt class="docutils literal"><span class="pre">default</span></tt> does not refer to a recipe in <tt class="docutils literal"><span class="pre">default.rb</span></tt>. Templates are not split up into different directories by a recipe.</p>
</div>
<div class="section" id="id19">
<h4>H3 &#8211; Host Notation &#8211; DONE<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h4>
<p>The naming of folders within cookbook directories must literally match the host notation used for template specificity matching. For example, if a host is named <tt class="docutils literal"><span class="pre">foo.example.com</span></tt>, then the folder must be named <tt class="docutils literal"><span class="pre">host-foo.example.com</span></tt>.</p>
<p><strong>jamescott: this is probably best to single-source, as it lives in several places. WOULD NEED TO MAKE IT MORE GENERIC FOR THIS TO WORK REALLY WELL</strong></p>
</div>
<div class="section" id="h3-transfer-frequency-done">
<h4>H3 &#8211; Transfer Frequency &#8211; DONE<a class="headerlink" href="#h3-transfer-frequency-done" title="Permalink to this headline">¶</a></h4>
<p>Chef caches a template when it is first requested. On each subsequent request for that template, Chef compares that request to the template located on the Chef server. If the templates are the same, no transfer occurs.</p>
</div>
<div class="section" id="h3-versions-done">
<h4>H3 &#8211; Versions &#8211; DONE<a class="headerlink" href="#h3-versions-done" title="Permalink to this headline">¶</a></h4>
<p>A cookbook version represents a specific set of functionality that is different from the cookbook on which it is based. A version may exist for many reasons, such as for ensuring that the correct versions of third-party components are being used or to provide an update to a cookbook that fixes previous issues or adds new improvements. A cookbook version can be defined using syntax and operators, it can be associated with environments, cookbook metadata, or run-lists, and it can be frozen (to prevent unwanted updates from being made). A cookbook version is a cookbook, from the perspective of the repository and how cookbooks are stored on the Chef server and pushed out to one (or more) nodes.</p>
<p>A cookbook version represents a specific set of functionality that is different from the cookbook on which it is based. A version may exist for many reasons, such as for ensuring that the correct versions of third-party components are being used or to provide an update to a cookbook that fixes previous issues or adds new improvements. A cookbook version can be defined using syntax and operators, it can be associated with environments, cookbook metadata, or run-lists, and it can be frozen (to prevent unwanted updates from being made). A cookbook version is a cookbook, from the perspective of the repository and how cookbooks are stored on the Chef server and pushed out to one (or more) nodes.</p>
</div>
<div class="section" id="id20">
<h4>H3 &#8211; Syntax &#8211; DONE<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h4>
<p>A cookbook version always takes the form x.y.z, where x, y, and z are decimal numbers that are used to represent major (x), minor (y), and patch (z) versions. A two-part version (x.y) is also allowed. Alphanumeric version numbers (1.2.a3) and version numbers with more than three parts (1.2.3.4) are not allowed.</p>
</div>
<div class="section" id="h3-operators-done">
<h4>H3 &#8211; Operators &#8211; DONE<a class="headerlink" href="#h3-operators-done" title="Permalink to this headline">¶</a></h4>
<p>The following operators can be used with cookbook versions:</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Operator</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>=</td>
<td>Equal to</td>
</tr>
<tr class="row-odd"><td>&gt;</td>
<td>Greater than</td>
</tr>
<tr class="row-even"><td>&lt;</td>
<td>Less than</td>
</tr>
<tr class="row-odd"><td>&gt;=</td>
<td>Greater than or equal to</td>
</tr>
<tr class="row-even"><td>=&lt;</td>
<td>Less than or equal to</td>
</tr>
<tr class="row-odd"><td>~&gt;</td>
<td>Approximately greater than</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-version-constraints-done">
<h4>H3 &#8211; Version Constraints &#8211; DONE<a class="headerlink" href="#h3-version-constraints-done" title="Permalink to this headline">¶</a></h4>
<p>A version constraint is a string that combines the cookbook version syntax with an operator, in the following format:</p>
<div class="highlight-python"><pre>operator cookbook_version_syntax</pre>
</div>
<p>For example, a version constraint for &#8220;greater than version 1.0.2&#8221; is expressed like this:</p>
<div class="highlight-python"><pre>&gt; 1.0.2</pre>
</div>
<p>An optimistic version constraint is one that looks for versions greater than or equal to the specified version. For example:</p>
<div class="highlight-python"><pre>&gt;= 2.6.5</pre>
</div>
<p>will match cookbooks greater than or equal to 2.6.5, such as 2.6.5, 2.6.7 or 3.1.1.</p>
<p>A pessimistic version constraint is one that will find the upper limit version number within the range specified by the minor version number or patch version number. For example, a pessimistic version constraint for minor version numbers:</p>
<div class="highlight-python"><pre>~&gt; 2.6</pre>
</div>
<p>will match cookbooks that are greater than version 2.6, but less than version 3.0. Or, a pessimistic version constraint for patch version numbers:</p>
<div class="highlight-python"><pre>~&gt; 2.6.5</pre>
</div>
<p>will match cookbooks that are greater than version 2.6.5, but less than version 2.7.0.</p>
</div>
<div class="section" id="h3-metadata-in-metadata-rb-done">
<h4>H3 &#8211; Metadata (in metadata.rb) &#8211; DONE<a class="headerlink" href="#h3-metadata-in-metadata-rb-done" title="Permalink to this headline">¶</a></h4>
<p>Every cookbook requires a small amount of metadata. This metadata provides hints to the Chef server so that cookbooks are deployed to each node correctly.</p>
<p><strong>jamescott: THE DESCRIPTIONS HERE NEED TO BE EDITED DOWN FOR THE METADATA.RB FILE. THE VERSION OPERATORS AND OTHER SMALL PIECES HERE MAYBE SHOULD BE INCLUDED IN THE METADATA.RB FILE JUST FOR GOOD MEASURE. IT CANNOT HURT. SAME EXAMPLES FOR BOTH IDEALLY. AND REMOVE OPERATOR DISCUSSION FROM DESCRIPTIONS.</strong></p>
<p>Versions and version constraints can be specified in a cookbook&#8217;s metadata.rb file by using the following functions. Each function accepts a name and an optional version constraint; if a version constraint is not provided, <tt class="docutils literal"><span class="pre">&gt;=</span> <span class="pre">0.0.0</span></tt> is used as the default.</p>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Function</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">conflicts</span></tt></td>
<td><p class="first">Indicates that a cookbook conflicts with another cookbook or cookbook version. Use a version constraint to define constraints for cookbook versions: <tt class="docutils literal"><span class="pre">&lt;</span></tt> (less than), <tt class="docutils literal"><span class="pre">&lt;=</span></tt> (less than or equal to), <tt class="docutils literal"><span class="pre">=</span></tt> (equal to), <tt class="docutils literal"><span class="pre">&gt;=</span></tt> (greater than or equal to), <tt class="docutils literal"><span class="pre">~&gt;</span></tt> (approximately greater than), or <tt class="docutils literal"><span class="pre">&gt;</span></tt> (greater than).  This field requires that a cookbook with a matching name and version exist on the Chef server. When the match exists, the Chef server will ensure that conflicted cookbook is not included with the set of cookbooks that are sent to the node when the chef-client runs. <strong>jamescott: wild-ass guess based on the seeming parallelism of the ``depends`` field.</strong> For example:</p>
<div class="highlight-python"><pre>conflicts "apache2", "&lt; 3.0"</pre>
</div>
<p>Or:</p>
<div class="last highlight-python"><pre>conflicts "daemon-tools"</pre>
</div>
</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">depends</span></tt></td>
<td><p class="first">Indicates that a cookbook has a dependency on another cookbook or cookbook version. Use a version constraint to define dependencies for cookbook versions: <tt class="docutils literal"><span class="pre">&lt;</span></tt> (less than), <tt class="docutils literal"><span class="pre">&lt;=</span></tt> (less than or equal to), <tt class="docutils literal"><span class="pre">=</span></tt> (equal to), <tt class="docutils literal"><span class="pre">&gt;=</span></tt> (greater than or equal to), <tt class="docutils literal"><span class="pre">~&gt;</span></tt> (approximately greater than), or <tt class="docutils literal"><span class="pre">&gt;</span></tt> (greater than). This field requires that a cookbook with a matching name and version exist on the Chef server. When the match exists, the Chef server will include the dependency as part of the set of cookbooks that are sent to the node when the chef-client runs. This field should be used whenever a feature that is included in another cookbook should be run when this cookbook is run, such as including recipes, using the same resources or providers in lightweight resource providers, custom libraries, or definitions. It is very important that the <tt class="docutils literal"><span class="pre">depends</span></tt> field contain accurate data. If a dependency statement is inaccurate, Chef may not be able to complete the configuration of the system. For example:</p>
<div class="highlight-python"><pre>depends "opscode-base"</pre>
</div>
<p>Or:</p>
<div class="highlight-python"><pre>depends "opscode-github", "&gt; 1.0.0"</pre>
</div>
<p>Or:</p>
<div class="last highlight-python"><pre>depends "runit", "~&gt; 1.2.3"</pre>
</div>
</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">provides</span></tt></td>
<td>Adds a recipe, definition, or resource that is provided by this cookbook, should the auto-populated list be insufficient.</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">recommends</span></tt></td>
<td>Adds a dependency on another cookbook that is recommended, but not required. A cookbook will still work even if recommended dependencies are not available.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">replaces</span></tt></td>
<td>Indicates that this cookbook should replace another (and can be used in-place of that cookbook).</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">suggests</span></tt></td>
<td>Adds a dependency on another cookbook that is suggested, but not required. This field is weaker than <tt class="docutils literal"><span class="pre">recommends</span></tt>; a cookbook will still work even when suggested dependencies are not available.</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">supports</span></tt></td>
<td>Indicates that a cookbook has a supported platform. Use a version constraint to define dependencies for platform versions: <tt class="docutils literal"><span class="pre">&lt;</span></tt> (less than), <tt class="docutils literal"><span class="pre">&lt;=</span></tt> (less than or equal to), <tt class="docutils literal"><span class="pre">=</span></tt> (equal to), <tt class="docutils literal"><span class="pre">&gt;=</span></tt> (greater than or equal to), <tt class="docutils literal"><span class="pre">~&gt;</span></tt> (approximately greater than), or <tt class="docutils literal"><span class="pre">&gt;</span></tt> (greater than). To specify more than one platform, use more than one <tt class="docutils literal"><span class="pre">supports</span></tt> field, once for each platform.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="h3-environments-done">
<h4>H3 &#8211; Environments &#8211; DONE<a class="headerlink" href="#h3-environments-done" title="Permalink to this headline">¶</a></h4>
<p>An environment can use version constraints to specify a list of allowed cookbook versions by specifying the cookbook&#8217;s name along with the version constraint. For example:</p>
<div class="highlight-python"><pre>cookbook "apache2", "~&gt; 1.2.3"</pre>
</div>
<p>Or:</p>
<div class="highlight-python"><pre>cookbook "runit", "= 4.2.0"</pre>
</div>
<p>If a cookbook is not explicitly given a version constraint the environment will assume the cookbook has no version constraint and will use any version of that cookbook with any node in the environment.</p>
</div>
<div class="section" id="h3-run-list-items-done">
<h4>H3 &#8211; Run-list Items &#8211; DONE<a class="headerlink" href="#h3-run-list-items-done" title="Permalink to this headline">¶</a></h4>
<p>A version constraint can be specified for recipe items that are part of a run-list. Use <tt class="docutils literal"><span class="pre">&#64;</span></tt> (at sign) to indicate a version constraint. Only the &#8220;equal to&#8221; constraint can be used to specify a version constraint in a run-list. For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;run_list&quot;</span><span class="p">:[</span><span class="s">&quot;recipe[nginx@1.2.3]&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<div class="section" id="h4-freezing-versions-done">
<h5>H4 &#8211; Freezing Versions &#8211; DONE<a class="headerlink" href="#h4-freezing-versions-done" title="Permalink to this headline">¶</a></h5>
<p>A cookbook version can be frozen, which will prevent updates from being made to that version of a cookbook. (A user can always upload a new version of a cookbook.) Using cookbook versions that are frozen within environments is a reliable way to keep a production environment safe from accidental updates while testing changes that are made to a development infrastructure.</p>
<p>For example, to freeze a cookbook version using Knife, enter:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>knife cookbook upload redis --freeze
</pre></div>
</div>
<p>To return:</p>
<div class="highlight-python"><pre>.. code-block:: bash</pre>
</div>
<blockquote>
<div>Uploading redis...
Upload completed</div></blockquote>
<p>Once a cookbook version is frozen, only by using the <tt class="docutils literal"><span class="pre">--force</span></tt> option can an update be made. For example:</p>
<div class="highlight-python"><pre>.. code-block:: bash</pre>
</div>
<blockquote>
<div>$ knife cookbook upload redis &#8211;force</div></blockquote>
<p>Without the <tt class="docutils literal"><span class="pre">--force</span></tt> option specified, an error will be returned similar to &#8220;Version 0.0.0 of cookbook redis is frozen. Use &#8211;force to override.&#8221;</p>
</div>
</div>
<div class="section" id="h3-version-control-strategies-done">
<h4>H3 &#8211; Version Control Strategies &#8211; DONE<a class="headerlink" href="#h3-version-control-strategies-done" title="Permalink to this headline">¶</a></h4>
<p>There are two strategies to consider when using version control as part of the cookbook management process:</p>
<ul class="simple">
<li>Use maximum version control when it is important to keep every bit of data within version control</li>
<li>Use branch tracking when cookbooks are being managed in separate environments using git branches and the versioning policy information is already stored in a cookbook&#8217;s metadata.</li>
</ul>
<div class="section" id="h4-branch-tracking-done">
<h5>H4 &#8211; Branch Tracking &#8211; DONE<a class="headerlink" href="#h4-branch-tracking-done" title="Permalink to this headline">¶</a></h5>
<p>Using a branch tracking strategy requires that a branch for each environment exists in the source control and that each cookbook&#8217;s versioning policy is tracked at the branch level. This approach is relatively simple and lightweight: for development environments that track the latest cookbooks, just bump the version before a cookbook is uploaded for testing. For any cookbooks that require higher levels of version control, Knife allows cookbooks to be uploaded to specific environments and for cookbooks to be frozen (which prevents others from being able to make changes to that cookbook).</p>
<p>The typical workflow with a branch tracking version control strategy includes:</p>
<ol class="arabic simple">
<li>Bumping the version number as appropriate.</li>
<li>Making changes to a cookbook.</li>
<li>Uploading and testing a cookbook.</li>
<li>Moving a tested cookbook to production.</li>
</ol>
<p>For example, to bump the version number:</p>
<div class="highlight-python"><pre>knife cookbook upload my-app</pre>
</div>
<p>Make changes to the cookbook, upload and test it, repeating the process as required. When the cookbook is finished, move those changes to the production environment and use the <tt class="docutils literal"><span class="pre">--freeze</span></tt> option to prevent others from making further changes:</p>
<div class="highlight-python"><pre>knife cookbook upload  my-app -E production --freeze</pre>
</div>
</div>
<div class="section" id="h4-maximum-version-control-done">
<h5>H4 &#8211; Maximum Version Control &#8211; DONE<a class="headerlink" href="#h4-maximum-version-control-done" title="Permalink to this headline">¶</a></h5>
<p>Using a maximum version control strategy is required when everything needs to be tracked in source control. This approach is very similar to a branch tracking strategy while the cookbook is in development and being tested, but is more complicated and time-consuming (and requires file-level editing for environment data) in order to get the cookbook deployed to a production environment.</p>
<p>The typical workflow with a maximum version control strategy includes:</p>
<ol class="arabic simple">
<li>Bumping the version number as appropriate.</li>
<li>Making changes to a cookbook.</li>
<li>Uploading and testing a cookbook.</li>
<li>Moving a tested cookbook to production.</li>
</ol>
<p>For example, to bump the version number:</p>
<div class="highlight-python"><pre>knife cookbook upload my-app</pre>
</div>
<p>Make changes to the cookbook, upload and test it, repeating the process as required. When the cookbook is finished, move those changes to the production environment and use the <tt class="docutils literal"><span class="pre">--freeze</span></tt> option to prevent others from making further changes:</p>
<div class="highlight-python"><pre>knife cookbook upload  my-app -E production --freeze</pre>
</div>
<p>Then modify the environment so that it prefers the newly-uploaded version:</p>
<div class="highlight-python"><pre>(vim|emacs|mate|ed) YOUR_REPO/environments/production.rb</pre>
</div>
<p>Upload the updated environment:</p>
<div class="highlight-python"><pre>knife environment from file production.rb</pre>
</div>
<p>And then deploy the new cookbook version.</p>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li><a href="#">Chef Overview</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Opscode, Inc..
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>